---
title: "Container Apps + API Managementã§æ§‹ç¯‰ã™ã‚‹API Gateway"
emoji: "ğŸ˜½"
type: "tech"
topics: ["azure", "containerapps", "apimanagement"]
published: false
---


ã“ã‚“ã«ã¡ã¯ã€AIShift ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®çŸ³äº•([@sugar235711](https://twitter.com/sugar235711))ã§ã™ã€‚
æœ¬è¨˜äº‹ã¯[AIShift Advent Calendar 2023](https://adventar.org/calendars/8766)ã® 10æ—¥ç›®ã®è¨˜äº‹ã¨ãªã‚Šã¾ã™ã€‚

ä»Šå›ã®è¨˜äº‹ã§ã¯ã€Container Apps + API Managementã§API Gatewayã‚’æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚

[GCPç‰ˆã¯ã“ã¡ã‚‰](https://www.ai-shift.co.jp/techblog/3906)


## ã¯ã˜ã‚ã«

ä»Šå›ã¯ Azureä¸Šã§ã‚¹ãƒ”ãƒ¼ãƒ‡ã‚£ãƒ¼ãªAPIé–‹ç™ºç’°å¢ƒã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’ç›®çš„ã«ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’è€ƒæ…®ã—ãŸæ§‹æˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ä½œã‚‹æ§‹æˆ

- æ§‹æˆ1
![Alt text](/images/kousei1.png)

- æ§‹æˆ2(å®Ÿè·µç·¨)
![Alt text](/images/kosei2.png)

â€»ä»Šå›ã¯é–‹ç™ºç’°å¢ƒã®æº–å‚™ã®ãŸã‚ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯Developer Planã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
æœ¬ç•ªç’°å¢ƒã§ã®åˆ©ç”¨ã¯æ¥­å‹™è¦ä»¶ç­‰ã‚’è€ƒæ…®ã—ã¦ã”æ¤œè¨ãã ã•ã„ã€‚

## ä½¿ç”¨ã™ã‚‹Azureãƒªã‚½ãƒ¼ã‚¹

### API Management

API Managementã¯ã€Web APIã‚’çµ±åˆç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚Azureä¸Šã§æ§‹ç¯‰ã•ã‚ŒãŸAPIã‚„ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®APIã‚’çµ±åˆç®¡ç†ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã€èªè¨¼ãƒ»èªå¯ã€ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ãªã©ã®åˆ¶å¾¡ã‚‚è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

![API Management](/images/api-management.png)

ä»Šå›ã®ãƒ‡ãƒ¢ã§ã¯ã€Container Appsä¸Šã«æ§‹ç¯‰ã—ãŸREST APIã‚’åˆ©ç”¨ã—ã¾ã™ãŒã€gRPCãªã©ã®ä»–ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

### Azure Container Apps

Azure Container Appsã¯ã€Kubernetesä¸Šã«æ§‹ç¯‰ã•ã‚ŒãŸãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚AKSã¨ã¯ç•°ãªã‚Šã€ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼æ§‹æˆã‚„ç®¡ç†ã®æ‰‹é–“ãŒä¸è¦ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«ç„¦ç‚¹ã‚’å½“ã¦ãŸã‚µãƒ¼ãƒ“ã‚¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚

2022å¹´ã«ä¸€èˆ¬æä¾›(GA)ãŒé–‹å§‹ã•ã‚ŒãŸã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã¯ã€å¾Œç™ºã‚†ãˆã«é«˜æ©Ÿèƒ½ã§ä½¿ã„ã‚„ã™ã„ã‚µãƒ¼ãƒ“ã‚¹ã¨ãªã£ã¦ã„ã¾ã™ã€‚

ä¸»ãªç‰¹å¾´ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Šã¾ã™ï¼š

- CNCF OSSï¼ˆEnvoyã€KEDAã€Daprï¼‰ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™ã€‚
- ãƒ¦ãƒ¼ã‚¶èªè¨¼æ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚
- ã‚«ãƒŠãƒªã‚¢ãƒªãƒªãƒ¼ã‚¹ã€ABãƒ†ã‚¹ãƒˆã€ãƒ–ãƒ«ãƒ¼ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãªã©ã®ãƒ‡ãƒ—ãƒ­ã‚¤æˆ¦ç•¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚
- Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã®ç®¡ç†ãŒä¸è¦ã§ã™ã€‚
- Service Connectorã‚’é€šã˜ã¦ä»–ã®Azureãƒªã‚½ãƒ¼ã‚¹ã¨ã®é€£æºãŒå®¹æ˜“ã§ã™ã€‚

è©³ç´°ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š
https://learn.microsoft.com/ja-jp/azure/container-apps/overview


## ãƒ‡ãƒ¢ç’°å¢ƒã®æ§‹ç¯‰

ã¾ãšã€é©å½“ãªãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆã—ã€ãã®ä¸­ã«Vnetã‚’ä½œæˆã—ã¾ã™ã€‚Container Appsã€API Managementç”¨ã«ãã‚Œãã‚Œã‚µãƒ–ãƒãƒƒãƒˆã‚’ä½œæˆã—ã€ãã®ä¸­ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’é…ç½®ã—ã¾ã™ã€‚

### Container Appsã®ä½œæˆ

Container Appsã‚’ä½œæˆã™ã‚‹ã«ã¯ã€Containerãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹Container Apps EnvironmentãŒå¿…è¦ã§ã™ã€‚
ã“ã®Environmentã«å¯¾ã—ã¦ã‚µãƒ–ãƒãƒƒãƒˆã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã§ã€Container AppsãŒåˆ©ç”¨ã™ã‚‹ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãªãŠã€ãƒ¯ãƒ¼ã‚¯ãƒ­ãƒ¼ãƒ‰ç’°å¢ƒã§ã¯æœ€ä½ã§ã‚‚/27ã®ã‚µãƒ–ãƒãƒƒãƒˆã‚’å‰²ã‚Šå½“ã¦ã€`Microsoft.App/environments`ã«å¯¾ã—ã¦å§”ä»»ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

https://learn.microsoft.com/ja-jp/azure/container-apps/networking?tabs=workload-profiles-env%2Cazure-cli#subnet

ä½œæˆã—ãŸã‚µãƒ–ãƒãƒƒãƒˆã‚’Container Apps Environmentã«å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
infrasturcture subnetã«å‰²ã‚Šå½“ã¦ã€Virtual IPã‚’Internalã«è¨­å®šã—ã¾ã™ã€‚
ã“ã‚Œã«ã‚ˆã£ã¦ã€Container Appsã«å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯Vnetå†…ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚

![Container Apps Environment](/images/container-app-env2.png)

æ¬¡ã«ã“ã®Environmentã«å¯¾ã—ã¦Container Appsã‚’ä½œæˆã—ã¾ã™ã€‚
ã“ã“ã§ã¯ã‚µãƒ³ãƒ—ãƒ«ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¦Container Appsã‚’ä½œæˆã—ã¾ã™ã€‚Internalã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€Vnetå†…ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªç’°å¢ƒã¨ãªã‚Šã¾ã™ã€‚

![Container Apps Creation](/images/container-app3.png)

ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ãŸã‚‰ã€Application Urlã‚’ç¢ºèªã—ã¾ã™ã€‚
Internalã«è¨­å®šã—ãŸãŸã‚ã€Vnetå†…ã‹ã‚‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã®ã§ã€ã“ã®URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã™ã€‚

![Container Settings](/images/container-setting.png)


![No Access](/images/noaccess.png)

æ¬¡ã«ã€Vnetå†…ã§Container Appsã®åå‰è§£æ±ºã‚’è¡Œã†ãŸã‚ã«ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆDNSã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚ä½œæˆã™ã‚‹ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆDNSã‚¾ãƒ¼ãƒ³ã®ã€Œnameã€ã«ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚¢ãƒ—ãƒªã®ã€ŒApplication Urlã€ã®ãƒ‰ãƒ¡ã‚¤ãƒ³éƒ¨åˆ†ã‚’æŒ‡å®šã—ã¾ã™ã€‚

![Private DNS Instance Detail](/images/private-dns-instance-detail.png)

DNS ZoneãŒä½œæˆã•ã‚ŒãŸã‚‰ã€ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚
ãƒ¬ã‚³ãƒ¼ãƒ‰åã«ã¯ã€Container Appsã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã€ IPã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã¯Container Apps Environmentã®Static IPã‚’æŒ‡å®šã—ã¾ã™ã€‚

![Record Creation](/images/record.png)

æœ€å¾Œã«Virtual NetWork Linkã‚’ä½œæˆã—ã€Vnetã¨ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆDNSã‚¾ãƒ¼ãƒ³ã‚’ç´ã¥ã‘ã¾ã™ã€‚
ã“ã‚Œã§Container Appsã®åå‰è§£æ±ºãŒå¯èƒ½ã«ãªã‚Šã¾ã—ãŸã€‚

![Network Link](/images/network-link.png)

### API Managementã®ä½œæˆ

ä»Šå›ã¯API Managementã«PublicIPã‚’å‰²ã‚Šå½“ã¦ã€API Gatewayã¨ã—ã¦åˆ©ç”¨ã—ã¾ã™ã€‚
ãã®éš›ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã«ã€NSGã‚’å‰²ã‚Šå½“ã¦ãŸã‚µãƒ–ãƒãƒƒãƒˆã«ç´ã¥ã‘ã¾ã™ã€‚

![NSG](/images/subnet-api-management.png)
åŸºæœ¬çš„ã«ã¯ã€API Managementã®VNetä½¿ç”¨è¨­å®šã«å¾“ã£ã¦inbound/outboundã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
https://learn.microsoft.com/ja-jp/azure/api-management/api-management-using-with-vnet?tabs=stv2#configure-nsg-rules


ã‚µãƒ–ãƒãƒƒãƒˆã«å¯¾ã—ã¦ã®NSGã®é©ç”¨ã—ã¾ã™ã€‚
ãã®éš›ã«ã‚µãƒ–ãƒãƒƒãƒˆã®å§”ä»»ã‚’ã—ãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚
![Subnet API Management](/images/subnet-api-management2.png)

æ¬¡ã«ã€API Managementç”¨ã®PublicIPã‚’å–å¾—ã—ã¾ã™ã€‚ï¼ˆSKUãŒStandardã§ãªã„ã¨API Managementã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¾ã›ã‚“ï¼‰
å–å¾—ã—ãŸã‚‰ã€è¨­å®šã‹ã‚‰DNSåã®ãƒ©ãƒ™ãƒ«ä»˜ã‘ã‚’è¡Œã„ã¾ã™ã€‚

![IP DNS Name](/images/ip-dns-name.png)

ä»¥ä¸Šã®æº–å‚™ãŒã§ããŸã‚‰ã€API Managementã‚’ä½œæˆã—ã¾ã™ã€‚
ãã®éš›ã«ã€å…ˆã»ã©ä½œæˆã—ãŸã‚µãƒ–ãƒãƒƒãƒˆãŠã‚ˆã³IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã—ã¾ã™ã€‚
å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹ãŸã‚ã«Connectivity Typeã‚’Externalã«è¨­å®šã—ã¾ã™ã€‚

![API Management Creation](/images/api-management2.png)

ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ãŸã‚‰ã€API Managementã«Container Appsã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

![API Management Container Import](/images/api-management-container.png)

ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸéš›ã«è¨­å®šã—ãŸsuffixã¨gatewayã®URLã‚’åˆã‚ã›ã¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚¢ãƒ—ãƒªã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦æ±‚ã•ã‚Œã‚‹ã®ã§ä¸€æ™‚çš„ã«è§£é™¤ã—ã¦ã„ã¾ã™ï¼‰ã€‚

![API Access](/images/image.png)

`https://<resource-name>.azure-api.net/`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€Container Appsã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
![API Access Result](/images/image-1.png)

ã“ã“ã¾ã§ã§ã€API ManagementçµŒç”±ã§Container Appsã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

IPåˆ¶é™ã‚„æµé‡ç®¡ç†ã¯API Managementã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¾‹ãˆã°ã€API ManagementçµŒç”±ã®å…¨ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«IPåˆ¶é™ã‚’ã‹ã‘ãŸã„å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’è¨­å®šã—ã¾ã™ã€‚

![IP Filter](/images/all-ip.png)

è¨­å®šä»¥å¤–ã®IPã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã€ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã™ã€‚

![Access Denied](/images/no.png)

ã“ã“ã¾ã§ã§ã€å†’é ­ã§ç´¹ä»‹ã—ãŸæ§‹æˆã®å®Ÿç¾ãŒã§ãã¾ã—ãŸã€‚

## å®Ÿè·µç·¨

ä»Šå›ã¯ç°¡æ˜“çš„ãªå®Ÿé¨“ã®ãŸã‚ã«ã‚µãƒ³ãƒ—ãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã—ã¾ã—ãŸãŒã€ã‚ˆã‚Šå®Ÿé‹ç”¨ã«è¿‘ã„æ§‹æˆã‚‚ç´¹ä»‹ã—ã¾ã™ã€‚
![Alt text](/images/kosei2.png)

### ãƒ‡ãƒ¢ç”¨ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç”¨æ„ã™ã‚‹

ä»Šå›ã¯ã€Bunã¨Typescriptã§æ§‹æˆã•ã‚ŒãŸç°¡æ˜“çš„ãªREST APIã‚’ç”¨æ„ã—ã¾ã™ã€‚

[repository](https://github.com/sugar-cat7/container-app-sample)

ä»Šå›ã¯ã€Azure Registryã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Pushã—ã€ãã“ã‹ã‚‰Container Appsã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

linux/amd64ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç”¨æ„ã—ã¾ã™ã€‚
â€»Container Appsã¯Armã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚

```bash
$ docker build --pull --platform linux/amd64 -t bun-hello-world .
$ docker tag bun-hello-world <registry-name>.azurecr.io/dev
$ docker push <registry-name>.azurecr.io/dev
```

ãã®å¾Œã€å…ˆã»ã©ã®æ‰‹é †ã§ã‚µãƒ³ãƒ—ãƒ«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ©ç”¨ã™ã‚‹éƒ¨åˆ†ã‚’å¤‰æ›´ã—ã€RegistryçµŒç”±ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã—ã¾ã™ã€‚


### Postgresã‚µãƒ¼ãƒãƒ¼ã®ç”¨æ„

Azure Database for PostgreSQLã‚’ç”¨æ„ã—ã¾ã™ã€‚
Developer Planã‚’åˆ©ç”¨ã—ãŸã„ã®ã§ã€Azure Database for PostgreSQLã®ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚

https://learn.microsoft.com/ja-jp/azure/postgresql/flexible-server/overview

DBç”¨ã®ã‚µãƒ–ãƒãƒƒãƒˆã‚’æº–å‚™ã—ã¾ã™ã€‚
ã“ã®ã‚µãƒ–ãƒãƒƒãƒˆã¯`Microsoft.DBforPostgreSQL/flexibleServers`ã«å§”ä»»ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

![ã‚µãƒ–ãƒãƒƒãƒˆã®æº–å‚™](/images/subnet-pg.png)



Postgresã‚µãƒ¼ãƒãƒ¼ã‚‚Vnetä»¥å¤–ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ããŸã‚ã«ã€Private access (VNet Integration)ã‚’é¸æŠã—ã¾ã™ã€‚

https://learn.microsoft.com/ja-jp/azure/postgresql/flexible-server/concepts-networking-private#virtual-network-concepts

![Private accessã®é¸æŠ](/images/network-pg.png)

ã“ã¡ã‚‰ã‚‚Container Appsã¨åŒæ§˜ã«Private DNSã‚¾ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¾ã™ã€‚Flexible Serverã®ä½œæˆæ™‚ã«åŒæ™‚ã«è‡ªå‹•ä½œæˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

![Private DNSã‚¾ãƒ¼ãƒ³ã®ä½œæˆ](/images/pg-dns.png)


### Container Appsã¨Azure Database for PostgreSQLã‚’ç¹‹ã

ã“ã®Postgresã‚µãƒ¼ãƒãƒ¼ã¨Container Appsã‚’é€£æºã•ã›ã‚‹ãŸã‚ã«ã€Service Connectorã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

Service Connectorã¯Azureä¸Šã®ãƒªã‚½ãƒ¼ã‚¹ã¨ã®é€£æºã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã§ã™ã€‚ã“ã‚Œã‚’åˆ©ç”¨ã™ã‚‹ã¨ã€ç’°å¢ƒå¤‰æ•°ã®æƒ…å ±ãªã©ã‚’è‡ªå‹•ã§Container Appsã«è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ä¸Šè¨˜ã§ä½œæˆã—ãŸPostgresã‚µãƒ¼ãƒãƒ¼ã‚’é¸æŠã—ã€Container Appsã¨é€£æºã•ã›ã¾ã™ã€‚

Container Appså´ã§ä½¿ç”¨ã™ã‚‹ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ç’°å¢ƒã«åˆã‚ã›ã¦æ¥ç¶šæƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚

![Service Connectorã®è¨­å®š](/images/service-connector.png)

ã“ã“ã¾ã§è¡Œã†ã¨ã€Containerã‹ã‚‰Postgresã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

å®Ÿéš›ã«ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚Monitoringã®Consoleã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒŠã‚’ç¢ºèªã§ãã¾ã™ã€‚Postgresã®ã‚µãƒ¼ãƒãƒ¼åã‚’æŒ‡å®šã—ã¦`nslookup`ã—ã¦ã¿ã¾ã™ã€‚

![nslookupã®çµæœ](/images/nslookup.png)

æ­£å¸¸ã«è§£æ±ºã§ãã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

æ¬¡ã«ã€æ‰‹å…ƒã‹ã‚‰ç›´æ¥Postgresã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚ã“ã‚Œã¯Publicã«Ã¥å…¬é–‹ã—ã¦ã„ãªã„ã®ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã¯ãšã§ã™ã€‚
![Alt text](/images/host-psql.png)

ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ­£ã—ãVnetå†…ã§ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ãŒåˆ¶å¾¡ã§ãã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

æ¬¡ã«ã€API Managementã‹ã‚‰Container Appsã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€Container Appsã«æ§‹ç¯‰ã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰Postgresã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚

ä½¿ç”¨ã™ã‚‹ã‚½ãƒ¼ã‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚DBã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹APIã§ã™ã€‚

:::details code
```typescript
import { Hono } from "hono";
import { Pool } from "pg";
import fs from "fs";
const app = new Hono();

const sslConfig = Bun.env.AZURE_POSTGRESQL_SSL
  ? {
      ca: fs.readFileSync("./DigiCertGlobalRootCA.crt.pem"),
    }
  : false;

const pool = new Pool({
  user: Bun.env.AZURE_POSTGRESQL_USER,
  host: Bun.env.AZURE_POSTGRESQL_HOST,
  database: Bun.env.AZURE_POSTGRESQL_DATABASE,
  password: Bun.env.AZURE_POSTGRESQL_PASSWORD,
  port: parseInt(Bun.env.AZURE_POSTGRESQL_PORT!, 10),
  ssl: sslConfig,
});

app.get("/", async (c) => {
  try {
    console.log("Connecting to database");
    const client = await pool.connect();
    try {
      const result = await client.query("SELECT current_user;");
      const currentUser = result.rows.at(0).current_user;
      return c.json({ message: `Hello, ${currentUser}` }, 200);
    } finally {
      client.release();
    }
  } catch (err) {
    if (err instanceof Error) {
      console.error(err);
      return c.json({ error: err.message }, 500);
    }
    console.error("An unknown error occurred");
    return c.json({ error: "An unknown error occurred" }, 500);
  }
});

export default app;
```

```Dockerfile
# use the official Bun image
FROM oven/bun:1 as base
WORKDIR /usr/src/app

# Install common network troubleshooting tools
RUN apt-get update && apt-get install -y \
    curl \
    telnet \
    netcat \
    dnsutils

# install dependencies into temp directory
# this will cache them and speed up future builds
FROM base AS install
RUN mkdir -p /temp/dev
COPY package.json bun.lockb /temp/dev/
RUN cd /temp/dev && bun install --frozen-lockfile

# install with --production (exclude devDependencies)
RUN mkdir -p /temp/prod
COPY package.json bun.lockb /temp/prod/
RUN cd /temp/prod && bun install --frozen-lockfile --production

# copy node_modules from temp directory
# then copy all (non-ignored) project files into the image
FROM base AS prerelease
COPY --from=install /temp/dev/node_modules node_modules
COPY . .

# Copy the DigiCertGlobalRootCA.crt.pem file
COPY DigiCertGlobalRootCA.crt.pem ./

# [optional] tests & build
ENV NODE_ENV=production
RUN bun test
RUN bun run build

# copy production dependencies and source code into final image
FROM base AS release
COPY --from=install /temp/prod/node_modules node_modules
COPY --from=prerelease /usr/src/app/index.ts .
COPY --from=prerelease /usr/src/app/package.json .

# Copy the DigiCertGlobalRootCA.crt.pem file to final image
COPY --from=prerelease /usr/src/app/DigiCertGlobalRootCA.crt.pem ./

# run the app
USER bun
EXPOSE 3000/tcp
ENTRYPOINT [ "bun", "run", "index.ts" ]

```


:::

TLSã®è¨­å®šã‚’è¡Œã†ãŸã‚ã«ã€Postgresã‚µãƒ¼ãƒãƒ¼ã®è¨¼æ˜æ›¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¯Portalã‹ã‚‰è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
â€»æ³¨æ„: ä»Šå›ã¯ä¸€æ™‚çš„ãªãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã®ãŸã‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã«è¨¼æ˜æ›¸ã‚’å«ã‚ã¦ã„ã¾ã™ãŒã€æœ¬ç•ªç’°å¢ƒã§ã¯Azure Key Vaultãªã©ã«è¨¼æ˜æ›¸ã‚’ä¿å­˜ã—ã¦åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚


å‹•ä½œç¢ºèª
![Alt text](/images/api-mabagement-pg.png)

ä»¥ä¸Šã®ã‚¢ãƒ—ãƒªã‚’Container Appsã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã€API ManagementçµŒç”±ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§DBã¾ã§ã‚»ã‚­ãƒ¥ã‚¢ã«æ¥ç¶šã—ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

### ãŠã‚ã‚Šã«
ä»Šå›ã¯ Azure Container Apps + API Managementã§API Gatewayã‚’æ§‹ç¯‰ã™ã‚‹æ‰‹é †ã‚’ã”ç´¹ä»‹ã—ã¾ã—ãŸã€‚

AI Shiftã§ã¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ¡ç”¨ã«åŠ›ã‚’å…¥ã‚Œã¦ã„ã¾ã™ï¼
å°‘ã—ã§ã‚‚èˆˆå‘³ã‚’æŒã£ã¦ã„ãŸã ã‘ã¾ã—ãŸã‚‰ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«é¢è«‡ã§ãŠè©±ã—ã¾ã›ã‚“ã‹ï¼Ÿ
ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ»19æ™‚ä»¥é™ã®é¢è«‡ã‚‚å¯èƒ½ã§ã™ï¼ï¼‰
ã€[é¢è«‡ãƒ•ã‚©ãƒ¼ãƒ ã¯ã“ã¡ã‚‰](https://hrmos.co/pages/cyberagent-group/jobs/1826557091831955459)ã€‘
