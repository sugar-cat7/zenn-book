---
title: "Agones GameServerAllocationç·¨"
emoji: "ğŸ®"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [agones, kubernetes, gameserver]
published: false
---

ã“ã‚“ã«ã¡ã¯ã€[@sugar235711](https://twitter.com/sugar235711)ã§ã™ã€‚
ã“ã®è¨˜äº‹ã¯ã€Œã²ã¨ã‚Šã§æ°—ã«ãªã‚‹OSSã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¨éƒ¨èª­ã‚“ã§ä½•ã‹ã™ã‚‹ Advent Calendar 2025ã€4æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
https://qiita.com/advent-calendar/2025/sugarcat

- [å…¨ä½“ç·¨](https://zenn.dev/king/articles/4e55f030aa01ee)
- [GameServerç·¨](https://zenn.dev/king/articles/003f7b79409b4a)
- [Fleetç·¨](https://zenn.dev/king/articles/e956ef8f3cd6bf)
- GameServerAllocationç·¨ â†ä»Šã“ã“
- FleetAutoscalerç·¨


## GameServerAllocationã«é–¢ã—ã¦

GameServerAllocationã¯GameServerã‚’å‹•çš„ã«å‰²ã‚Šå½“ã¦ã‚‹ãŸã‚ã®Custom Resourceã§ã™ã€‚
ä¾‹ãˆã°OpenMatchç­‰ã®ãƒãƒƒãƒãƒ¡ã‚¤ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã•ã‚Œã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒãƒƒãƒãƒ³ã‚°ã•ã‚ŒãŸéš›ã«GameServerã‚’å‰²ã‚Šå½“ã¦ã‚‹ç”¨é€”ã§ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒãƒƒãƒãƒ¡ã‚¤ã‚­ãƒ³ã‚°å¾Œã«ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã™ã‚‹éš›ã€åˆ©ç”¨å¯èƒ½ãªGameServerã‚’è‡ªå‹•çš„ã«é¸æŠãƒ»å‰²ã‚Šå½“ã¦
- é¸æŠã•ã‚ŒãŸGameServerã‚’ReadyçŠ¶æ…‹ã‹ã‚‰AllocatedçŠ¶æ…‹ã«é·ç§»ã•ã›ã‚‹
- å‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸGameServerã®è©³ç´°æƒ…å ±ï¼ˆã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒãƒ¼ãƒˆç­‰ï¼‰ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™

![image0](/images/agones/2.png)

## å‰²ã‚Šå½“ã¦æ–¹æ³•ã«é–¢ã—ã¦

Agonesã«ãŠã„ã¦ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯`GameServerAllocation`ã¨`Allocator Service`ã®ã©ã¡ã‚‰ã‹ã§è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
Allocator Serviceã¯LoadBalancerçµŒç”±ã§å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦æä¾›ã•ã‚Œã¦ãŠã‚Šã€ãƒãƒ«ãƒã‚¯ãƒ©ã‚¹ã‚¿ç’°å¢ƒã«ãŠã„ã¦ã‚‚åˆ©ç”¨å¯èƒ½ã§ã™ã€‚

https://agones.dev/site/docs/reference/gameserverallocation/
https://agones.dev/site/docs/advanced/allocator-service/

å†…éƒ¨çš„ã«ã¯GameServerAllocationã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã“ã§ã¯GameServerAllocationã®å®Ÿè£…ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚

## å‰²ã‚Šå½“ã¦ã®æµã‚Œã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãƒãƒªã‚·ãƒ¼

GameServerã®é¸æŠã¯ã€ã¾ãšã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼æ¡ä»¶ï¼ˆãƒ©ãƒ™ãƒ«ï¼çŠ¶æ…‹ãªã©ï¼‰ã«åŸºã¥ã„ã¦å€™è£œGameServerãƒªã‚¹ãƒˆã‚’æ¤œç´¢ã™ã‚‹ã¨ã“ã‚ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚
ãã®ä¸Šã§GameServerã‚’é¸æŠå¾Œã€2ç¨®é¡ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°æ–¹å¼ã®ã©ã¡ã‚‰ã‹ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚

Packed
- å¯èƒ½ãªé™ã‚Šå°‘ãªã„ãƒãƒ¼ãƒ‰ã«GameServerã‚’é›†ç´„ã™ã‚‹æ–¹å¼

Distributed
- GameServerã‚’ã‚¯ãƒ©ã‚¹ã‚¿å…¨ä½“ã«åˆ†æ•£é…ç½®ã™ã‚‹æ–¹å¼

![image1](/images/agones/1.png)

å‰²ã‚Šå½“ã¦ã«é–¢ã—ã¦ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã®`gameServerCache`ãŒåˆ©ç”¨ã•ã‚Œã¦ãŠã‚Šã€å‰²ã‚Šå½“ã¦ã®ãŸã‚ã®ã‚½ãƒ¼ãƒˆãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

```go
//
//nolint:govet // ignore fieldalignment, singleton embedded in AllocationCache
type gameServerCache struct {
	mu    sync.RWMutex
	cache map[string]*agonesv1.GameServer
}
```

https://github.com/googleforgames/agones/blob/3b94c58f3819456ba259195e9785d87cf3392d9b/pkg/gameserverallocations/allocation_cache.go#L169-L238

```go
if Scheduling == Packed:
    â†’ ListSortedGameServers()  // Bin Packingã‚½ãƒ¼ãƒˆ
else if Scheduling == Distributed && Prioritiesè¨­å®šã‚ã‚Š:
    â†’ ListSortedGameServersPriorities()  // Prioritiesã‚½ãƒ¼ãƒˆ
else:
    â†’ ListSortedGameServers() â†’ rand.Shuffle()  // ãƒ©ãƒ³ãƒ€ãƒ 
```

å‰²ã‚Šå½“ã¦ã¯ãã‚Œãã‚Œã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ã«å¿œã˜ãŸã‚½ãƒ¼ãƒˆé–¢æ•°ã‚’ä½¿ç”¨ã—ã¦è¡Œã‚ã‚Œã¾ã™ã€‚
https://github.com/googleforgames/agones/blob/3b94c58f3819456ba259195e9785d87cf3392d9b/pkg/gameserverallocations/find.go#L43-L68

### High Density GameServers

1ã¤ã®GameServerãƒ—ãƒ­ã‚»ã‚¹ã§è¤‡æ•°ã®åŒæ™‚ã‚²ãƒ¼ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ãƒªã‚½ãƒ¼ã‚¹ã‚’åŠ¹ç‡çš„ã«æ´»ç”¨ã§ãã¾ã™ã€‚
Agonesã§ã¯ã“ã®å•é¡Œã«å¯¾ã—ã¦2ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://agones.dev/site/docs/integration-patterns/high-density-gameservers/

### Session/Room Counters

Counteræ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€GameServerä¸Šã§åˆ©ç”¨å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã‚’è¿½è·¡ã™ã‚‹æ–¹æ³•ã§ã™ã€‚
ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã¨SDKçµŒç”±ã®ä¸¡æ–¹ã§Counterå€¤ã‚’æ›´æ–°ã§ãã€Agoneså´ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã‚’è¿½è·¡ã§ãã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/3b94c58f3819456ba259195e9785d87cf3392d9b/pkg/apis/allocation/v1/gameserverallocation.go#L295-L318

```yaml
apiVersion: allocation.agones.dev/v1
kind: GameServerAllocation
spec:
  scheduling: Packed
  priorities:
    - type: Counter
      key: rooms
      order: Ascending # æœ€ã‚‚æº€æ¯ã«è¿‘ã„"rooms"ã‚’å„ªå…ˆ
  selectors:
    # ã™ã§ã«AllocatedçŠ¶æ…‹ã§ã€1ã¤ä»¥ä¸Šã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å—ã‘å…¥ã‚Œå¯èƒ½ãªGameServerã‚’æ¤œç´¢
    - gameServerState: Allocated
      matchLabels:
        agones.dev/fleet: simple-game-server
      counters:
        rooms:
          minAvailable: 1
    # è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ReadyçŠ¶æ…‹ã®GameServerã‚’å‰²ã‚Šå½“ã¦
    - gameServerState: Ready
      matchLabels:
        agones.dev/fleet: simple-game-server
      counters:
        rooms:
          minAvailable: 1
  counters:
    rooms:
      action: Increment
      amount: 1 # ã‚¢ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«roomæ•°ã‚’1å¢—ã‚„ã™
```

ã¾ãšã€ã™ã§ã«AllocatedçŠ¶æ…‹ã§roomsã®ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã«ä½™è£•ãŒã‚ã‚‹GameServerã‚’æ¤œç´¢ã—ã¾ã™ã€‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ReadyçŠ¶æ…‹ã®GameServerã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚
å‰²ã‚Šå½“ã¦æ™‚ã«`rooms` Counterã‚’1å¢—ã‚„ã—ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã¯GameServerãƒ—ãƒ­ã‚»ã‚¹ãŒSDKçµŒç”±ã§`rooms` Counterã‚’æ¸›ã‚‰ã—ã¦ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã‚’å›å¾©ã•ã›ã¾ã™ã€‚


## ã¾ã¨ã‚

Allocationã®åŸºæœ¬å‹•ä½œã‚’ç¢ºèªã—ã¾ã—ãŸã€‚
æ˜æ—¥ã¯FleetAutoscalerã‚’è¦‹ã¾ã™ã€‚