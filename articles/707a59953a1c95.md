---
title: "tslogã§å®Ÿç¾ã™ã‚‹ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã¨ãƒ­ã‚®ãƒ³ã‚°"
emoji: "ğŸ“„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

ã“ã‚“ã«ã¡ã¯ã€[sugar-cat](https://twitter.com/sugar235711)ã§ã™ã€‚

## ã¯ã˜ã‚ã«

çš†ã•ã‚“ã¯TypeScriptã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã‚’è¡Œã†éš›ã«ã©ã®ã‚ˆã†ã«ãƒ­ã‚®ãƒ³ã‚°ã‚’ã—ã¦ã„ã¾ã™ã‹ã€‚

ã“ã®è¨˜äº‹ã§ã¯tslogã¨ã„ã†TypeScriptè£½ã®ãƒ­ã‚®ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç´¹ä»‹ã¨ãã®å†…éƒ¨ã®ä»•çµ„ã¿ã€ç§˜åŒ¿æƒ…å ±ã‚’å«ã‚€ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ãªã„ãŸã‚ã®æ–¹æ³•ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã™ã€‚


## ãƒ­ã‚°ã®ç¨®é¡

ã“ã®è¨˜äº‹ã§ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã‚’æ‰±ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã§å‡ºåŠ›ã•ã‚ŒãŸæ¨™æº–å‡ºåŠ›ã‚’åé›†ã—ã€ä»»æ„ã®ç›£è¦–ãƒ„ãƒ¼ãƒ«ã«é€ä¿¡ã—è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ãªãƒ­ã‚°ã‚’æŒ‡ã—ã¾ã™ã€‚
ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã ã£ãŸã‚Šç›£æŸ»ãƒ­ã‚°ã€ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã¿ãŸã„ãªã‚‚ã®ã¯æ‰±ã„ã¾ã›ã‚“ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§é–‹ç™ºè€…ãŒæ„å›³çš„ã«å‡ºåŠ›ã™ã‚‹ãƒ­ã‚°ã‚’æŒ‡ã—ã¾ã™ã€‚


## tslogã¨ã¯

tslogã¯TypeScriptè£½ã§ä½œæˆã•ã‚ŒãŸæ§‹é€ åŒ–ãƒ­ã‚®ãƒ³ã‚°ã‚’è¡Œã†ãŸã‚ã®ãƒ­ã‚®ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
https://tslog.js.org

ä¸»ãªç‰¹å¾´ã¨ã—ã¦ã¯ã€node.js/browserã©ã¡ã‚‰ã«ã‚‚å¯¾å¿œã—ã¦ãŠã‚Šã€ä»–ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ç•°ãªã‚Šå¤–éƒ¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã®ä¾å­˜ãŒä¸€åˆ‡ãªã‹ã£ãŸã‚Šã€ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ãŒTypeScriptã ã£ãŸã‚Šã—ã¾ã™ã€‚
![alt text](/images/tslog/tslog-depenedency.png)



ã•ã¦ã€æ§‹é€ åŒ–ãƒ­ã‚°ã¯ä¸€èˆ¬çš„ã«JSONã¾ãŸã¯[logfmt](https://brandur.org/logfmt)å½¢å¼ã§å‡ºåŠ›ã•ã‚Œã‚‹ãƒ­ã‚°ã®ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚
ãŠä½¿ã„ã®ç›£è¦–SaaS(Grafana Loki, Datadog, etc)ãªã©ãƒ¡ã‚¸ãƒ£ãƒ¼ã©ã“ã‚ã§ã‚ã‚Œã°ã©ã¡ã‚‰ã®å½¢å¼ã§ã‚‚å¯¾å¿œã—ã¦ã„ã¾ã™ãŒã€JSONå½¢å¼ã§ã®ã¿å—ã‘ã‚‰ã‚Œã‚‹ã‚µãƒãƒ¼ãƒˆ(ç‰¹å®šã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’ç´ã¥ã‘ã‚‹ã“ã¨ã§UIã®è¡¨ç¤ºã‚’ãƒªãƒƒãƒã«ã—ã¦ãã‚Œã‚‹ç­‰)ã‚„Cloud Loggingã®ã‚ˆã†ãªãã‚‚ãã‚‚JSONã—ã‹ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ã‚ã‚‹ã®ã§ã€åŸºæœ¬ã¯JSONå½¢å¼ã§å‡ºåŠ›ã™ã‚‹ã“ã¨ãŒç„¡é›£ã§ã™ã€‚

ã¨ã„ã†ã‚ã‘ã§ã€tslogã§ã‚‚JSONå½¢å¼ã®ãƒ­ã‚°ãŒå‡ºåŠ›å¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚
å¯¾å¿œå½¢å¼ã¨ã—ã¦ã¯pretty, jsonãŒå¯¾å¿œã—ã¦ã„ã¾ã™ã€‚
- pretty
é–‹ç™ºæ™‚ãªã©ã«äººé–“ãŒèª­ã¿ã‚„ã™ã„å½¢ã§ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ãã‚Œã‚‹ã‚ˆã†ãªã‚‚ã®ã§ã™ã€‚
![alt text](/images/tslog/tslog-pretty-sample.png)
- JSON
ãã®åã®é€šã‚ŠJSONå½¢å¼ã§ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ãã‚Œã¾ã™ã€‚
![alt text](/images/tslog/tslog-json-sample.png)


### æ§‹é€ åŒ–ãƒ­ã‚®ãƒ³ã‚°ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å†…éƒ¨

ã“ã“ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®šã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã›ãšã«ä½¿ç”¨ã—ãŸéš›ã®tslogã§ã¯ã©ã®ã‚ˆã†ãªå‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹ã‹ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚
ä¸‹è¨˜ã®ã‚ˆã†ãªå˜ç´”ãªå‡¦ç†ã ã¨ã—ã¾ã™ã€‚
```js
import http from 'http';
import { Logger } from 'tslog';

const server = http.createServer(handle);

const logger = new Logger({ type: "json" });

function handle(req, res) {
  logger.info(`[Request received]: ${req.method} ${req.url}`);
  res.end('hello world');
}

server.listen(3000)
```

ãƒã‚¹ã‚­ãƒ³ã‚°ã®éç¨‹ã‚’æŒŸã¾ãªã„å ´åˆã€tslogã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ä¸Šè¨˜ä¾‹ã§ã¯`[Request received]:~`ã¨ã„ã†æ–‡å­—åˆ—ã‚’å—ã‘å–ã‚Šã€ãã‚Œã«å¯¾ã—ã¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿(ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€ãƒ›ã‚¹ãƒˆæƒ…å ±ãªã©)ã‚’ä»˜ä¸ã—ã¦Objectã‚’ä½œã‚Šã€ãã‚Œã‚’`JSON.stringify`ã§æ–‡å­—åˆ—åŒ–ã—ã¦`console.log`ã«é€šã—ã¦å‡ºåŠ›ã—ã¦ã„ã¾ã™ã€‚

![alt text](/images/tslog/tslog-internal.png)


ã“ã®ãã‚Œãã‚Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¯overrideå¯èƒ½ã§ã‚ã‚Šã€å¿…è¦ãŒã‚ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

### ãƒã‚¹ã‚­ãƒ³ã‚°ã«ã¤ã„ã¦

ã“ã“ã§ã¯ãƒ­ã‚°ã«ç§˜åŒ¿æƒ…å ±ã‚’å‡ºåŠ›ã—ãªã„æ–¹æ³•ã‚’è€ƒãˆã¾ã™ã€‚
ç§˜åŒ¿æƒ…å ±ã¯æ°åã€ä½æ‰€ã®ã‚ˆã†ãªå€‹äººæƒ…å ±ã‚’æŒ‡ã—ã€ä¸€åº¦ãƒ­ã‚°ã«å‡ºåŠ›ã•ã‚Œã¦ã—ã¾ã†ã¨å‰Šé™¤ãŒé›£ã—ã„(å‡ºåŠ›å…ˆã®æ¨©é™ã‚„ã™ãã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚Œã‚‹ç­‰)ãŸã‚ã€å¯èƒ½ãªé™ã‚Šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ç§˜åŒ¿æƒ…å ±ã®éƒ¨åˆ†ã‚’ãƒã‚¹ã‚­ãƒ³ã‚°ã€ã¾ãŸã¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å‰Šé™¤ã™ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚
ã—ã‹ã—å¤šãã®å ´åˆã€å®Ÿè£…è€…ãŒæ°—ã¥ã‹ãšã«ç§˜åŒ¿æƒ…å ±ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ã‚°ã‚’å‡ºåŠ›ã«å«ã‚ã¦ã—ã¾ã†ã“ã¨ãŒèµ·ã“ã‚ŠãŒã¡ã§ã™ã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã†ã§å¼¾ã‘ã‚Œã°è‰¯ã„ã§ã™ãŒã€å¯èƒ½ãªã‚‰äººé–“ã®æ‰‹ã‚’ä»‹ã•ãšã«æ©Ÿæ¢°çš„ã«ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã™ã‚‹ã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚

tslogã§ã¯ãƒã‚¹ã‚­ãƒ³ã‚°ã‚’è¡Œã†ãŸã‚ã®ä»•çµ„ã¿ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚(å†å¸°çš„ã«ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¢ç´¢ã—ã€æ–‡å­—åˆ—ã®å ´åˆã«replaceã‚’æŒŸã‚€å˜ç´”ãªã‚‚ã®ã§ã™ãŒã€çµæ§‹è‡ªå‰ã§å®Ÿè£…ã™ã‚‹ã¨é¢å€’ãªã‚‚ã®ã§ã™)
https://github.com/fullstack-build/tslog/blob/9a5d15696ae813142b64a21f42987e59e7115448/src/BaseLogger.ts#L183C1-L235C4

ã“ã®ä»•çµ„ã¿ã«ä¹—ã£ã‹ã‚‹ã“ã¨ã§ä¸‹è¨˜ã®ã‚ˆã†ã«ãƒ­ã‚°ã‚’ç°¡å˜ã«ãƒã‚¹ã‚­ãƒ³ã‚°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```js
import http from 'http';
import { Logger } from 'tslog';

const server = http.createServer(handle);

const logger = new Logger({
    type: "json",
    maskValuesOfKeys: ["password"],
    maskPlaceholder: "[###]",
  });

function handle(req, res) {
  logger.info("Secret!" ,{
      password: "pass123",
      otherKey: "otherKey456",
    });
  res.end('hello world');
}

server.listen(3000)
```

![alt text](/images/tslog/tslog-masking.png)



ã¾ãŸéƒ¨åˆ†çš„ã«ç½®æ›ã—ãŸã„å ´åˆãªã©ã¯æ­£è¦è¡¨ç¾ã‚’ä½¿ã£ã¦ãƒã‚¹ã‚­ãƒ³ã‚°ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
```js
import http from 'http';
import { Logger } from 'tslog';

const server = http.createServer(handle);

const logger = new Logger({
    type: "json",
    maskValuesRegEx: [new RegExp("otherKey", "g")],
  });

function handle(req, res) {
  logger.info("Secret!" ,{
      password: "pass123",
      otherKey: "otherKey456",
    });
  res.end('hello world');
}

server.listen(3000)
```

![alt text](/images/tslog/tslog-masking-regex.png)

ã“ã®ã‚ˆã†ã«ãƒã‚¹ã‚­ãƒ³ã‚°ã®ãŸã‚ã®ä»•çµ„ã¿ãŒç”¨æ„ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ç§˜åŒ¿æƒ…å ±ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ­ã‚°ã«å‡ºåŠ›ã™ã‚‹éš›ã«ã¯åˆ©ç”¨ã—ã¾ã—ã‚‡ã†ã€‚

ã—ã‹ã—ã€ã“ã®æ–¹æ³•ã§ã¯ã‚ã‚‰ã‹ã˜ã‚ãƒã‚¹ã‚­ãƒ³ã‚°å¯¾è±¡ã®ã‚­ãƒ¼ãŒçŸ¥ã‚Œã¦ã„ã‚‹å ´åˆã«ã¯æœ‰ç”¨ã§ã™ãŒã€äº‹æ•…ã§ä¸å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã¦ã—ã¾ã£ãŸå ´åˆã«ã¯å¯¾å¿œãŒé›£ã—ã„ã§ã™ã€‚
ãã®ãŸã‚ã€tslogã§ã„ã†ã¨ã“ã‚ã®
1.ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›æ™‚ã¾ãŸã¯`toLogObject`ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆæ™‚ã«ã‚ã‚‰ã‹ã˜ã‚å‹ã‚’å®šç¾©ã—ã¦ãŠããƒ‘ãƒ¼ã‚¹ã™ã‚‹
2.`transport`ã®éš›ã®`JSON.stringify`ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹

ã®æ–¹æ³•ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚


1ã§ã‚ã‚Œã°`zod`ã‚’ä½¿ç”¨ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’`parse`ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã“ã‚Œã¯Databaseã‹ã‚‰å–å¾—ã—ãŸè¡Œã®ä¸è¦ãªåˆ—ã‚’è½ã¨ã™ãªã©ã®ä½¿ã„æ–¹ãŒã•ã‚Œã¦ã„ã¾ã™ã€‚

https://speakerdeck.com/tockn/prisma-ormwo2nian-yun-yong-sitepei-tutanouhauwogong-you-suru?slide=160

loggerã§ã‚‚åŒæ§˜ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§ã€ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```ts
import http, { IncomingHttpHeaders, IncomingMessage, ServerResponse } from 'http';
import { IMeta, Logger } from 'tslog';
import z from 'zod';

const reqSchema = z.object({
  requestId: z.string(),
  nestedExample: z.object({
    level1: z.object({
      level2: z.object({
        level3: z.string(),
      }),
    }),
  }),
});

const server = http.createServer(handle);

function handle(req: IncomingMessage, res: ServerResponse): void {
  const logger = new Logger({ type: "json", hideLogPositionForProduction: true });

    logger.info('Request Start', reqSchema.parse({
        secret: "secret",
        requestId: 'test-id',
        nestedExample: { level1: { level2: { level3: 'Deep Value' } } },
    }));
  res.end('hello world');
}

server.listen(3000);
```

![alt text](/images/tslog/tslog-zod.png)

ã“ã®ã‚ˆã†ã«zodã‚’ä½¿ã£ã¦ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ã“ã¨ã§ã€ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã•ã¦ã“ã‚Œã§ã€ãƒ­ã‚°ã«ç§˜åŒ¿æƒ…å ±ã‚’å«ã¾ãªã„ã‚ˆã†ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚
ãŒã€loggerå†…éƒ¨ã®å®Ÿè¡Œé †åºçš„ã«objectã‚’ä½œã‚‹æ®µéšã§ã®ãƒ‘ãƒ¼ã‚¹ã ã¨ã€å¾Œç¶šã®å‡¦ç†ã§ä½•ã‹ã—ã‚‰ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå…¥ã‚Šã†ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
ç§˜åŒ¿æƒ…å ±ãŒæ··å…¥ã™ã‚‹å¯èƒ½æ€§ã¯ä½ã„ã¨ã¯æ€ã„ã¾ã™ãŒã€metadataå´ã§ã®æ€ã„å‡¦ç†(ä¾‹ãˆã°Stackãƒ•ãƒ¬ãƒ¼ãƒ ãªã©)ã‚’å«ã‚ã‚‹å‡¦ç†ãŒä½•ã‚‰ã‹ã®æ‹å­ã§onã«ãªã£ã¦ã—ã¾ã£ã¦ã„ãŸå ´åˆã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å•é¡Œã‚’å¼•ãèµ·ã“ã™å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
https://tslog.js.org/#/?id=%e2%9d%97performance


ãªã®ã§2ã®ã‚ˆã†ãªã€tslogã¨ã—ã¦transportæ™‚ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ–¹æ³•ã§æœ€å¾Œã«ãƒ­ã‚°ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼èµ·å› ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å®Ÿè£…(`transportJSON`)ã ã¨ã€æ¸¡ã£ã¦ããŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾`JSON.stringify`ã—ã¦ãŠã‚Šã€ä¸è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã¾ãªã„ã‚ˆã†ã«JSON.stringifyã®å®Ÿè£…ã‚’èª¿æ•´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

https://github.com/fullstack-build/tslog/blob/9a5d15696ae813142b64a21f42987e59e7115448/src/runtime/nodejs/index.ts#L154-L177

ã•ã¦`JSON.stringify`ã¯ç¬¬äºŒå¼•æ•°ã«`replacer`ã‚’æŒã¡ã¾ã™ã€‚
https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify

replacerã¯ä¸€èˆ¬çš„ã«å€¤ã‚’ç½®ãæ›ãˆã‚‹éš›ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
`undifinedã‚„BigInt, Symbol, function`ã®å ´åˆã¯ãã®ã¾ã¾ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ããªã„ã®ã§ã€`replacer`ã§ç½®ãæ›ãˆã‚‹å¯¾å¿œãŒã•ã‚Œã‚‹ã€‚
å®Ÿéš›ã«tslogã®`transportJSON`ã®å®Ÿè£…ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€bigintãŠã‚ˆã³Undefinedã®å ´åˆã¯æ–‡å­—åˆ—ã«ç½®ãæ›ãˆã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã“ã®éƒ¨åˆ†ã«ä»»æ„ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’æ›¸ã„ã¦ã„ãã“ã¨ã‚‚å¯èƒ½ã§ã™ãŒã€ãƒ­ã‚°ã®å‡ºåŠ›ãŒå¢—ãˆã‚‹ãŸã³ã«ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿®æ­£ã‚„ãƒ†ã‚¹ãƒˆãŒå¿…è¦ã«ãªã‚Šã‚ã¾ã‚Šã‚¹ãƒãƒ¼ãƒˆãªæ–¹æ³•ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

ãã“ã§`typia`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
https://typia.io/

typiaã®èª¬æ˜ã¯çœãã¾ã™ãŒã€TypeScriptã®å‹æƒ…å ±ã‚’å…ƒã«ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«Validationã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
ä¸‹è¨˜ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ã€‚
https://zenn.dev/ryoppippi/articles/c4775a3a5f3c11


typiaã«ã¯JSON.stringifyã®replaceréƒ¨åˆ†ã‚’ã‚ˆã—ãªã«ã—ã¦ãã‚Œã‚‹`stringify`ã¨ã„ã†é–¢æ•°ãŒã‚ã‚Šã¾ã™ã€‚
https://typia.io/docs/json/stringify/

ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã«ã‚ˆã£ã¦TypeScriptã®å‹æƒ…å ±ã‚’å…ƒã«ãƒ­ã‚°ã®å‡ºåŠ›ã‚’å¼·åˆ¶ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
overrideã‚’ä½¿ç”¨ã—ã¦`transportJSON`ã‚’typiaã‚’ä½¿ç”¨ã—ãŸstringifyã«å·®ã—æ›¿ãˆã¾ã™ã€‚

```ts
import http, { IncomingMessage, ServerResponse } from "http";
import { Logger } from "tslog";
import { IMeta } from "tslog/dist/types/runtime/nodejs";
import { createStringify } from "typia/lib/json";

type LoggerObj = {
  message: string;
  payload: {
    nestedExample: { level1: { level2: { level3: string } } };
  };
  _meta: IMeta;
};

const stringifyLoggerObj = createStringify<LoggerObj>();

const server = http.createServer(handle);

function tj(json: unknown): void {
  console.log(stringifyLoggerObj(json as LoggerObj));
}

const logger = new Logger({
  type: "json",
  hideLogPositionForProduction: true,
  overwrite: {
    transportJSON: tj,
  },
});

function handle(req: IncomingMessage, res: ServerResponse): void {
  logger.info({
    message: "Request Start",
    payload: {
      secret: "password",
      nestedExample: { level1: { level2: { level3: "hoge" } } },
    },
  });
  res.end("hello world");
}

server.listen(3000);
```

ä¸Šè¨˜ã‚’tscã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã€å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ã«ãªã‚Šã¾ã™ã€‚
![alt text](/images/tslog/tslog-typia.png)

ã“ã®ã‚ˆã†ã«ãã‚‚ãã‚‚å®šç¾©ã•ã‚Œã¦ã„ãªã„å‹æƒ…å ±(ä»Šå›ã®ä¾‹ã ã¨`secret`)ã¯å‡ºåŠ›ã•ã‚Œã¾ã›ã‚“ã€‚
ã“ã‚Œã¯typiaãŒã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«`stringifyLoggerObj`å†…éƒ¨ã§å‹æƒ…å ±ã‚’å…ƒã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¡Œã†ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ãŸã‚ã§ã™ã€‚

:::details ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœ
```js
"use strict";
var __importDefault =
  (this && this.__importDefault) ||
  function (mod) {
    return mod && mod.__esModule ? mod : { default: mod };
  };
Object.defineProperty(exports, "__esModule", { value: true });
const http_1 = __importDefault(require("http"));
const tslog_1 = require("tslog");
const json_1 = require("typia/lib/json");
const stringifyLoggerObj = (() => {
  const $string = json_1.createStringify.string;
  const $tail = json_1.createStringify.tail;
  const $so0 = (input) =>
    `{"message":${$string(input.message)},"payload":${$so1(
      input.payload
    )},"_meta":${$so5(input._meta)}}`;
  const $so1 = (input) => `{"nestedExample":${$so2(input.nestedExample)}}`;
  const $so2 = (input) => `{"level1":${$so3(input.level1)}}`;
  const $so3 = (input) => `{"level2":${$so4(input.level2)}}`;
  const $so4 = (input) => `{"level3":${$string(input.level3)}}`;
  const $so5 = (input) =>
    `{${
      undefined === input.path
        ? ""
        : `"path":${undefined !== input.path ? $so6(input.path) : undefined},`
    }${
      undefined === input.name
        ? ""
        : `"name":${
            undefined !== input.name ? $string(input.name) : undefined
          },`
    }${
      undefined === input.parentNames
        ? ""
        : `"parentNames":${
            undefined !== input.parentNames
              ? `[${input.parentNames.map((elem) => $string(elem)).join(",")}]`
              : undefined
          },`
    }${
      undefined === input.hostname
        ? ""
        : `"hostname":${
            undefined !== input.hostname ? $string(input.hostname) : undefined
          },`
    }"date":${$string(input.date.toJSON())},"logLevelId":${
      input.logLevelId
    },"logLevelName":${$string(input.logLevelName)},"runtime":${$string(
      input.runtime
    )},"runtimeVersion":${$string(input.runtimeVersion)}}`;
  const $so6 = (input) =>
    `{${$tail(
      `${
        undefined === input.fullFilePath
          ? ""
          : `"fullFilePath":${
              undefined !== input.fullFilePath
                ? $string(input.fullFilePath)
                : undefined
            },`
      }${
        undefined === input.fileName
          ? ""
          : `"fileName":${
              undefined !== input.fileName ? $string(input.fileName) : undefined
            },`
      }${
        undefined === input.fileNameWithLine
          ? ""
          : `"fileNameWithLine":${
              undefined !== input.fileNameWithLine
                ? $string(input.fileNameWithLine)
                : undefined
            },`
      }${
        undefined === input.filePath
          ? ""
          : `"filePath":${
              undefined !== input.filePath ? $string(input.filePath) : undefined
            },`
      }${
        undefined === input.fileLine
          ? ""
          : `"fileLine":${
              undefined !== input.fileLine ? $string(input.fileLine) : undefined
            },`
      }${
        undefined === input.fileColumn
          ? ""
          : `"fileColumn":${
              undefined !== input.fileColumn
                ? $string(input.fileColumn)
                : undefined
            },`
      }${
        undefined === input.filePathWithLine
          ? ""
          : `"filePathWithLine":${
              undefined !== input.filePathWithLine
                ? $string(input.filePathWithLine)
                : undefined
            },`
      }${
        undefined === input.method
          ? ""
          : `"method":${
              undefined !== input.method ? $string(input.method) : undefined
            }`
      }`
    )}}`;
  const $io1 = (input) =>
    "object" === typeof input.nestedExample &&
    null !== input.nestedExample &&
    $io2(input.nestedExample);
  const $io2 = (input) =>
    "object" === typeof input.level1 &&
    null !== input.level1 &&
    $io3(input.level1);
  const $io3 = (input) =>
    "object" === typeof input.level2 &&
    null !== input.level2 &&
    $io4(input.level2);
  const $io4 = (input) => "string" === typeof input.level3;
  const $io5 = (input) =>
    input.date instanceof Date &&
    "number" === typeof input.logLevelId &&
    "string" === typeof input.logLevelName &&
    (undefined === input.path ||
      ("object" === typeof input.path &&
        null !== input.path &&
        false === Array.isArray(input.path) &&
        $io6(input.path))) &&
    (undefined === input.name || "string" === typeof input.name) &&
    (undefined === input.parentNames ||
      (Array.isArray(input.parentNames) &&
        input.parentNames.every((elem) => "string" === typeof elem))) &&
    "string" === typeof input.runtime &&
    "string" === typeof input.runtimeVersion &&
    (undefined === input.hostname || "string" === typeof input.hostname);
  const $io6 = (input) =>
    (undefined === input.fullFilePath ||
      "string" === typeof input.fullFilePath) &&
    (undefined === input.fileName || "string" === typeof input.fileName) &&
    (undefined === input.fileNameWithLine ||
      "string" === typeof input.fileNameWithLine) &&
    (undefined === input.filePath || "string" === typeof input.filePath) &&
    (undefined === input.fileLine || "string" === typeof input.fileLine) &&
    (undefined === input.fileColumn || "string" === typeof input.fileColumn) &&
    (undefined === input.filePathWithLine ||
      "string" === typeof input.filePathWithLine) &&
    (undefined === input.method || "string" === typeof input.method);
  return (input) => $so0(input);
})();
const server = http_1.default.createServer(handle);
function tj(json) {
  console.log(stringifyLoggerObj(json));
}
const logger = new tslog_1.Logger({
  type: "json",
  hideLogPositionForProduction: true,
  overwrite: {
    transportJSON: tj,
  },
});
function handle(req, res) {
  logger.info({
    message: "Request Start",
    payload: {
      secret: "password",
      nestedExample: { level1: { level2: { level3: "hoge" } } },
    },
  });
  res.end("hello world");
}
server.listen(3000);
```
:::

ä»¥ä¸Šã®ã‚ˆã†ã«typiaã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€TypeScriptã®å‹æƒ…å ±ã‚’å…ƒã«ãƒ­ã‚°ã®å‡ºåŠ›ã‚’å®‰å…¨ã«æ‰±ã†ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## ãŠã¾ã‘
typiaã¯é€Ÿåº¦é¢ã§ã‚‚å„ªã‚Œã¦ã„ã‚‹ã‚ˆã†ãªã®ã§ã€æ¯”è¼ƒã—ã¦ã¿ã¾ã—ãŸã€‚

:::alert
ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒ(Docker)ã§ã®è¨ˆæ¸¬ã§ã™ã€‚å³å¯†æ€§ã«æ¬ ã‘ã‚‹ã®ã§ã€å‚è€ƒç¨‹åº¦ã«ã—ã¦ãã ã•ã„ã€‚
:::

å®Ÿè¡Œç’°å¢ƒ
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ãŒå‹•ãã‚³ãƒ³ãƒ†ãƒŠ(CPU 1, Memory 512MB)ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ç”¨æ„ã—ã€autocannonã§è² è·ã‚’ã‹ã‘ã‚‹
https://github.com/mcollina/autocannon
åŒä¸€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«é–‰ã˜ã¦å®Ÿè¡Œ

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãƒã‚¹ã‚­ãƒ³ã‚°ã¯è¡Œã‚ãšã€ãƒ”ãƒ¥ã‚¢ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ãƒ¼ã‚¹ã®ã¿ã®æ€§èƒ½ã§æ¤œè¨¼ã™ã‚‹ãŸã‚ã«ãƒã‚¹ã‚¯ã®å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—(maskValuesOfKeysãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§["password"]ã«ãªã£ã¦ã„ã‚‹ã®ã§æ³¨æ„)

æ¯”è¼ƒå¯¾è±¡
A.transportJSONã‚’`JSON.stringify`ã«ã—ãŸå ´åˆ
B.transportJSONã‚’`JSON.stringify` + loggerã«æ¸¡ã™Objectã‚’zodã§ãƒ‘ãƒ¼ã‚¹ã—ãŸå ´åˆ
C.transportJSONã‚’`typia`ã‚’ä½¿ç”¨ã—ãŸ`stringify`ã«ã—ãŸå ´åˆ

è² è·ã®ã‹ã‘æ–¹
æœ€åˆã®3ç§’é–“ã§warmupã‚’è¡Œã„ã€ãã®å¾Œ30ç§’é–“ã«ã‚ãŸã‚Šã€100ã®åŒæ™‚æ¥ç¶šã—ã¤ã¤10ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³åŒ–ã—ã¦é€ä¿¡
ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚Šç›´ã—5å›ç¹°ã‚Šè¿”ã™ã€‚

æ¯”è¼ƒã®ä»•æ–¹
30ç§’é–“ã§ãˆãŸç·å‡¦ç†æ•°ã‹ã‚‰rpsã‚’è¨ˆç®—


:::details è¨ˆæ¸¬ã«ä½¿ç”¨ã—ãŸã‚³ãƒ¼ãƒ‰
```ts
import http, {
  IncomingHttpHeaders,
  IncomingMessage,
  ServerResponse,
} from "http";
import { Logger } from "tslog";
import { IMeta } from "tslog/dist/types/runtime/nodejs";
import { createStringify } from "typia/lib/json";
import z from "zod";

type LoggerObj = {
  0: string;
  1: {
    url: string;
    method: string;
    headers: IncomingHttpHeaders;
    requestId: string;
    nestedExample: { level1: { level2: { level3: string } } };
  };
  _meta: IMeta;
};

const reqSchema = z.object({
  url: z.string(),
  method: z.string(),
  headers: z.record(z.string()),
  requestId: z.string(),
  nestedExample: z.object({
    level1: z.object({
      level2: z.object({
        level3: z.string(),
      }),
    }),
  }),
});

const stringifyRequestInfo = createStringify<LoggerObj>();

const server = http.createServer(handle);

function tj(json: unknown): void {
  // console.log(stringifyRequestInfo(json as LoggerObj)); Cã®ãƒ‘ã‚¿ãƒ¼ãƒ³
  // console.log(JSON.stringify(json)); A/Bã®ãƒ‘ã‚¿ãƒ¼ãƒ³
}

function handle(req: IncomingMessage, res: ServerResponse): void {
  const logger = new Logger({
    type: "json",
    hideLogPositionForProduction: true,
    maskValuesOfKeys:[],
    overwrite: {
      transportJSON: tj,
    },
  });
  const obj = {
    url: req.url,
    method: req.method,
    headers: req.headers,
    requestId: "test-id",
    nestedExample: { level1: { level2: { level3: "test" } } },
  }; // A/Cã®ãƒ‘ã‚¿ãƒ¼ãƒ³
  // const obj2 = reqSchema.parse(obj); // Bã®ãƒ‘ã‚¿ãƒ¼ãƒ³
  logger.info("Request Start", obj);
  res.end("hello world");
}

server.listen(3000);
```

```Dockerfile
FROM node:20

WORKDIR /app

COPY bench .
RUN npm install
ENV NODE_ENV=production
EXPOSE 3000
```

```yaml
services:
  server:
    build: .
    container_name: server_container
    ports:
      - "3000:3000"
    command: ["node", "index.js"]
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    networks:
      - app-network

  autocannon:
    image: node:20
    container_name: autocannon_container
    working_dir: /app
    volumes:
      - .:/app
    depends_on:
      - server
    entrypoint: ["sh", "-c", "npm install -g autocannon && /app/run.sh"]
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 256M
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
```

```sh
#!/usr/bin/env sh

echo "##### Starting Load Test with Autocannon #####"
echo

# ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—å®Ÿè¡Œ
autocannon -c 100 -d 3 -p 10 http://server:3000 > /dev/null 2>&1
# æœ¬ç•ªè² è·ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
autocannon -c 100 -d 30 -p 10 http://server:3000

echo "##### Load Test Completed #####"
echo
```

:::

çµæœ
ä¸‹è¨˜ãŒå˜ä½æ™‚é–“ã‚ãŸã‚Šã«å‡¦ç†ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°ã®Avgã®5å›ã®å¹³å‡ã‚’å–ã£ãŸå€¤ã§ã™ã€‚(å°æ•°ç‚¹ç¬¬ä¸€ä½ã‚’å››æ¨äº”å…¥ã—ã¦ã„ã¾ã™)

| ãƒ†ã‚¹ãƒˆé …ç›®(rps)      | 1å›ç›®  | 2å›ç›®  | 3å›ç›®  | 4å›ç›®  | 5å›ç›®  | å¹³å‡ (Avg) |
|----------------|--------|--------|--------|--------|--------|------------|
| **A (ç´ )**     | 37,845 | 36,756 | 37,708 | 37,166 | 36,679 | **37,231** |
| **B (ç´  + Zod)** | 32,618 | 32,830 | 33,100 | 32,965 | 32,990 | **32,901** |
| **C (Typia)**  | 38,185 | 37,017 | 37,842 | 38,966 | 37,125 | **37,827** |

:::details autocannonã®çµæœä¾‹
```txt
##### Starting Load Test with Autocannon #####

Running 30s test @ http://server:3000
100 connections with 10 pipelining factor


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stat    â”‚ 2.5%  â”‚ 50%   â”‚ 97.5% â”‚ 99%   â”‚ Avg      â”‚ Stdev   â”‚ Max   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Latency â”‚ 15 ms â”‚ 31 ms â”‚ 35 ms â”‚ 37 ms â”‚ 25.92 ms â”‚ 8.21 ms â”‚ 77 ms â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stat      â”‚ 1%      â”‚ 2.5%    â”‚ 50%     â”‚ 97.5%   â”‚ Avg       â”‚ Stdev    â”‚ Min     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Req/Sec   â”‚ 33,023  â”‚ 33,023  â”‚ 38,335  â”‚ 38,975  â”‚ 37,845.34 â”‚ 1,203.14 â”‚ 32,992  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Bytes/Sec â”‚ 4.42 MB â”‚ 4.42 MB â”‚ 5.14 MB â”‚ 5.22 MB â”‚ 5.07 MB   â”‚ 162 kB   â”‚ 4.42 MB â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Req/Bytes counts sampled once per second.
# of samples: 30

1136k requests in 30.03s, 152 MB read
##### Load Test Completed #####
```
:::

Bã®Zodã®ãƒ‘ãƒ¼ã‚¹ã‚’æŒŸã‚“ã å‡¦ç†ã§ã¯æ˜ã‚‰ã‹ã«å‡¦ç†æ€§èƒ½ãŒè½ã¡ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚
ä¸€æ–¹ã§A,Bã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ã»ã¼å¤‰ã‚ã‚‰ãªã„çµæœã¨ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã¯æ¸¡ã•ã‚ŒãŸJSONãŒå°ã•ã„ãŠã‚ˆã³ã€åˆ¥ã®å‡¦ç†ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨ãªã‚Šstringifyã®æ€§èƒ½ã®å·®ã§ã¯ã‚ã¾ã‚Šå½±éŸ¿ãŒãªã‹ã£ãŸãŸã‚ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

Node.jsã®çµ„ã¿è¾¼ã¿ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°ã—ã¦ã¿ãŸçµæœã€Nodeã®ãƒ—ãƒ­ã‚»ã‚¹ã«ãŠã„ã¦ã¯`console.log`ã®å†…éƒ¨é–¢æ•°(`node:internal/console/constructor`)ã‚„ã‚¹ãƒˆãƒªãƒ¼ãƒ é–¢é€£ã®å†…éƒ¨é–¢æ•°`writeGenericã€writeOrBufferã€_write`ãŒæ”¯é…çš„ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
https://nodejs.org/en/learn/getting-started/profiling


:::details ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒªãƒ³ã‚°çµæœ
```txt
Testing v8 version different from logging version
Statistical profiling result from profiles/typia-nomask.log, (16417 ticks, 0 unaccounted, 0 excluded).

 [Shared libraries]:
   ticks  total  nonlib   name
   7829   47.7%          /usr/lib/aarch64-linux-gnu/libc.so.6
   6319   38.5%          /usr/local/bin/node
     82    0.5%          [vdso]
     82    0.5%          /usr/lib/aarch64-linux-gnu/libstdc++.so.6.0.30
      2    0.0%          /usr/lib/aarch64-linux-gnu/libgcc_s.so.1
      1    0.0%          /usr/lib/aarch64-linux-gnu/libm.so.6

 [JavaScript]:
   ticks  total  nonlib   name
    143    0.9%    6.8%  JS: *resOnFinish node:_http_server:968:21
    112    0.7%    5.3%  JS: *$string /app/node_modules/typia/lib/functional/$string.js:17:24
    103    0.6%    4.9%  JS: *$so2 /app/index.js:9:503
    102    0.6%    4.9%  JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
     94    0.6%    4.5%  JS: *BaseLogger /app/node_modules/tslog/dist/cjs/BaseLogger.js:25:16
     89    0.5%    4.2%  JS: *Readable.on node:internal/streams/readable:1125:33
     85    0.5%    4.0%  JS: *$so0 /app/index.js:9:189
     80    0.5%    3.8%  JS: *processTicksAndRejections node:internal/process/task_queues:67:35
     78    0.5%    3.7%  JS: *parserOnIncoming node:_http_server:1028:26
     73    0.4%    3.5%  JS: *endReadable node:internal/streams/readable:1680:21
     66    0.4%    3.1%  JS: *writeOrBuffer node:internal/streams/writable:546:23
     55    0.3%    2.6%  JS: *onwrite node:internal/streams/writable:613:17
     54    0.3%    2.6%  JS: *Readable node:internal/streams/readable:318:18
     53    0.3%    2.5%  JS: *clearBuffer node:internal/streams/writable:742:21
     52    0.3%    2.5%  JS: *Socket._writeGeneric node:net:923:42
     47    0.3%    2.2%  JS: *_write node:internal/streams/writable:451:16
     46    0.3%    2.2%  JS: *parserOnHeadersComplete node:_http_common:71:33
     38    0.2%    1.8%  JS: *log node:internal/console/constructor:384:6
     37    0.2%    1.8%  JS: *updateOutgoingData node:_http_server:753:28
     37    0.2%    1.8%  JS: *Writable.write node:internal/streams/writable:502:36
     35    0.2%    1.7%  JS: *handle /app/index.js:33:16
     30    0.2%    1.4%  JS: *end node:_http_outgoing:1030:45
     29    0.2%    1.4%  JS: *parserOnMessageComplete node:_http_common:136:33
     29    0.2%    1.4%  JS: *_storeHeader node:_http_outgoing:410:22
     24    0.1%    1.1%  JS: *detachSocket node:_http_server:292:62
     24    0.1%    1.1%  JS: *assignSocket node:_http_server:281:62
     23    0.1%    1.1%  JS: *get node:internal/console/constructor:214:14
     22    0.1%    1.0%  JS: *get node:internal/bootstrap/node:100:8
     22    0.1%    1.0%  JS: *_destroy node:_http_incoming:218:55
     21    0.1%    1.0%  JS: *callback node:internal/streams/writable:762:63
     20    0.1%    1.0%  JS: *onFinish node:_http_outgoing:1025:18
     20    0.1%    1.0%  JS: *emitReadable node:internal/streams/readable:817:22
     20    0.1%    1.0%  JS: *ServerResponse node:_http_server:195:24
     17    0.1%    0.8%  JS: *emitReadable_ node:internal/streams/readable:828:23
     16    0.1%    0.8%  JS: *write_ node:_http_outgoing:894:16
     16    0.1%    0.8%  JS: *value node:internal/console/constructor:277:20
     16    0.1%    0.8%  JS: *get node:_http_incoming:109:16
     15    0.1%    0.7%  JS: *resume node:internal/streams/readable:1245:16
     14    0.1%    0.7%  JS: *writeGeneric node:internal/stream_base_commons:148:22
     14    0.1%    0.7%  JS: *resume_ node:internal/streams/readable:1252:17
     14    0.1%    0.7%  JS: *addListener node:events:610:58
     13    0.1%    0.6%  JS: *endReadableNT node:internal/streams/readable:1690:23
     13    0.1%    0.6%  JS: *emitCloseNT node:internal/streams/destroy:132:21
     13    0.1%    0.6%  JS: *afterWriteTick node:internal/streams/writable:691:24
     12    0.1%    0.6%  JS: *writeHead node:_http_server:341:19
     12    0.1%    0.6%  JS: *onDestroy node:internal/streams/destroy:92:21
     11    0.1%    0.5%  JS: *matchKnownFields node:_http_incoming:276:26
     11    0.1%    0.5%  JS: *_dump node:_http_incoming:429:49
     11    0.1%    0.5%  JS: *Readable.read node:internal/streams/readable:645:35
     10    0.1%    0.5%  JS: *$so5 /app/index.js:20:196
      9    0.1%    0.4%  JS: *onParserExecuteCommon node:_http_server:905:31
      9    0.1%    0.4%  JS: *insertGuarded node:internal/timers:340:23
      9    0.1%    0.4%  JS: *Readable.push node:internal/streams/readable:385:35
      8    0.0%    0.4%  JS: *formatWithOptionsInternal node:internal/util/inspect:2185:35
      8    0.0%    0.4%  JS: *<anonymous> node:internal/validators:459:42
      7    0.0%    0.3%  JS: *setStreamTimeout node:internal/stream_base_commons:238:26
      7    0.0%    0.3%  JS: *emitCloseNT node:_http_server:1017:21
      6    0.0%    0.3%  RegExp: [^\t\x20-\x7e\x80-\xff]
      6    0.0%    0.3%  JS: *formatWithOptions node:internal/util/inspect:2164:27
      6    0.0%    0.3%  JS: *<anonymous> node:internal/console/constructor:364:10
      5    0.0%    0.2%  JS: *get node:internal/streams/writable:1008:8
      3    0.0%    0.1%  JS: *onParserExecute node:_http_server:832:25
      3    0.0%    0.1%  JS: *_finish node:_http_server:231:52
      3    0.0%    0.1%  JS: *Writable.uncork node:internal/streams/writable:518:37
      2    0.0%    0.1%  JS: ^resOnFinish node:_http_server:968:21
      2    0.0%    0.1%  JS: *slowCases node:internal/util:207:19
      2    0.0%    0.1%  JS: *setUnrefTimeout node:internal/timers:389:25
      2    0.0%    0.1%  JS: *processPromiseRejections node:internal/process/promises:436:34
      2    0.0%    0.1%  JS: *ReadableState node:internal/streams/readable:260:23
      1    0.0%    0.0%  JS: ^parserOnIncoming node:_http_server:1028:26
      1    0.0%    0.0%  JS: ^onwrite node:internal/streams/writable:613:17
      1    0.0%    0.0%  JS: ^insertGuarded node:internal/timers:340:23
      1    0.0%    0.0%  JS: ^emit node:events:466:44
      1    0.0%    0.0%  JS: ^checkError node:internal/streams/destroy:32:20
      1    0.0%    0.0%  JS: ^_addMetaToLogObj /app/node_modules/tslog/dist/cjs/BaseLogger.js:284:21
      1    0.0%    0.0%  JS: ^$so2 /app/index.js:9:503
      1    0.0%    0.0%  JS: *resetSocketTimeout node:_http_server:1147:28
      1    0.0%    0.0%  JS: *nop node:_http_outgoing:87:13
      1    0.0%    0.0%  JS: *checkListener node:events:275:23
      1    0.0%    0.0%  JS: *Writable.cork node:internal/streams/writable:511:35
      1    0.0%    0.0%  JS: *Socket.resume node:net:759:35

 [C++]:
   ticks  total  nonlib   name

 [Summary]:
   ticks  total  nonlib   name
   2102   12.8%  100.0%  JavaScript
      0    0.0%    0.0%  C++
    678    4.1%   32.3%  GC
  14315   87.2%          Shared libraries

 [C++ entry points]:
   ticks    cpp   total   name

 [Bottom up (heavy) profile]:
  Note: percentage shows a share of a particular caller in the total
  amount of its parent calls.
  Callers occupying less than 1.0% are not shown.

   ticks parent  name
   7829   47.7%  /usr/lib/aarch64-linux-gnu/libc.so.6
   3711   47.4%    JS: *Socket._writeGeneric node:net:923:42
   3706   99.9%      JS: *clearBuffer node:internal/streams/writable:742:21
   2838   76.6%        JS: *assignSocket node:_http_server:281:62
   2836   99.9%          JS: *resOnFinish node:_http_server:968:21
   2836  100.0%            JS: *onFinish node:_http_outgoing:1025:18
    868   23.4%        JS: *Writable.uncork node:internal/streams/writable:518:37
    868  100.0%          JS: *end node:_http_outgoing:1030:45
    868  100.0%            JS: *handle /app/index.js:33:16
   2627   33.6%    JS: *writeGeneric node:internal/stream_base_commons:148:22
   2623   99.8%      JS: *writeOrBuffer node:internal/streams/writable:546:23
   2623  100.0%        JS: *_write node:internal/streams/writable:451:16
   2623  100.0%          JS: *value node:internal/console/constructor:277:20
   2623  100.0%            JS: *log node:internal/console/constructor:384:6
    324    4.1%    JS: *clearBuffer node:internal/streams/writable:742:21
    257   79.3%      JS: *assignSocket node:_http_server:281:62
    256   99.6%        JS: *resOnFinish node:_http_server:968:21
    256  100.0%          JS: *onFinish node:_http_outgoing:1025:18
    256  100.0%            JS: *callback node:internal/streams/writable:762:63
     66   20.4%      JS: *Writable.uncork node:internal/streams/writable:518:37
     66  100.0%        JS: *end node:_http_outgoing:1030:45
     66  100.0%          JS: *handle /app/index.js:33:16
     66  100.0%            JS: *parserOnIncoming node:_http_server:1028:26
    255    3.3%    /usr/local/bin/node
    250   98.0%      JS: *$so0 /app/index.js:9:189
    249   99.6%        JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
    249  100.0%          JS: *handle /app/index.js:33:16
    245   98.4%            JS: *parserOnIncoming node:_http_server:1028:26
      4    1.6%            JS: *emit node:events:466:44
    251    3.2%    JS: *writeOrBuffer node:internal/streams/writable:546:23
    247   98.4%      JS: *_write node:internal/streams/writable:451:16
    247  100.0%        JS: *value node:internal/console/constructor:277:20
    247  100.0%          JS: *log node:internal/console/constructor:384:6
    247  100.0%            /usr/local/bin/node
      3    1.2%      JS: ^_write node:internal/streams/writable:451:16
      3  100.0%        JS: *value node:internal/console/constructor:277:20
      2   66.7%          JS: *log node:internal/console/constructor:384:6
      2  100.0%            /usr/local/bin/node
      1   33.3%          JS: ^log node:internal/console/constructor:384:6
      1  100.0%            /usr/local/bin/node

   6319   38.5%  /usr/local/bin/node
    947   15.0%    JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
    947  100.0%      JS: *handle /app/index.js:33:16
    939   99.2%        JS: *parserOnIncoming node:_http_server:1028:26
    939  100.0%          JS: *parserOnHeadersComplete node:_http_common:71:33
    684   10.8%    JS: *Socket._writeGeneric node:net:923:42
    684  100.0%      JS: *clearBuffer node:internal/streams/writable:742:21
    551   80.6%        JS: *assignSocket node:_http_server:281:62
    549   99.6%          JS: *resOnFinish node:_http_server:968:21
    549  100.0%            JS: *onFinish node:_http_outgoing:1025:18
    133   19.4%        JS: *Writable.uncork node:internal/streams/writable:518:37
    133  100.0%          JS: *end node:_http_outgoing:1030:45
    133  100.0%            JS: *handle /app/index.js:33:16
    584    9.2%    /usr/local/bin/node
    215   36.8%      JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
    215  100.0%        JS: *handle /app/index.js:33:16
    214   99.5%          JS: *parserOnIncoming node:_http_server:1028:26
    214  100.0%            JS: *parserOnHeadersComplete node:_http_common:71:33
    197   33.7%      JS: *$so0 /app/index.js:9:189
    195   99.0%        JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
    195  100.0%          JS: *handle /app/index.js:33:16
    194   99.5%            JS: *parserOnIncoming node:_http_server:1028:26
      2    1.0%        JS: ^<anonymous> /app/index.js:27:1423
      2  100.0%          JS: ^tj /app/index.js:29:12
      2  100.0%            JS: ^log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
    112   19.2%      JS: *$so2 /app/index.js:9:503
    112  100.0%        JS: *$so0 /app/index.js:9:189
    112  100.0%          JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
    112  100.0%            JS: *handle /app/index.js:33:16
     21    3.6%      /usr/local/bin/node
     21  100.0%        JS: *$so0 /app/index.js:9:189
     21  100.0%          JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
     21  100.0%            JS: *handle /app/index.js:33:16
     19    3.3%      JS: *clearBuffer node:internal/streams/writable:742:21
     18   94.7%        JS: *assignSocket node:_http_server:281:62
     18  100.0%          JS: *resOnFinish node:_http_server:968:21
     18  100.0%            JS: *onFinish node:_http_outgoing:1025:18
      1    5.3%        JS: *Writable.uncork node:internal/streams/writable:518:37
      1  100.0%          JS: *end node:_http_outgoing:1030:45
      1  100.0%            JS: *handle /app/index.js:33:16
      9    1.5%      JS: *parserOnIncoming node:_http_server:1028:26
      9  100.0%        JS: *parserOnHeadersComplete node:_http_common:71:33
    382    6.0%    JS: *$so0 /app/index.js:9:189
    380   99.5%      JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
    380  100.0%        JS: *handle /app/index.js:33:16
    379   99.7%          JS: *parserOnIncoming node:_http_server:1028:26
    379  100.0%            JS: *parserOnHeadersComplete node:_http_common:71:33
    361    5.7%    JS: *log node:internal/console/constructor:384:6
    361  100.0%      /usr/local/bin/node
    361  100.0%        JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
    361  100.0%          JS: *handle /app/index.js:33:16
    358   99.2%            JS: *parserOnIncoming node:_http_server:1028:26
    343    5.4%    JS: *writeGeneric node:internal/stream_base_commons:148:22
    342   99.7%      JS: *writeOrBuffer node:internal/streams/writable:546:23
    342  100.0%        JS: *_write node:internal/streams/writable:451:16
    342  100.0%          JS: *value node:internal/console/constructor:277:20
    342  100.0%            JS: *log node:internal/console/constructor:384:6
    211    3.3%    JS: *handle /app/index.js:33:16
    207   98.1%      JS: *parserOnIncoming node:_http_server:1028:26
    207  100.0%        JS: *parserOnHeadersComplete node:_http_common:71:33
    133    2.1%    JS: *Readable.on node:internal/streams/readable:1125:33
     76   57.1%      JS: *assignSocket node:_http_server:281:62
     68   89.5%        JS: *resOnFinish node:_http_server:968:21
     68  100.0%          JS: *onFinish node:_http_outgoing:1025:18
     68  100.0%            JS: *callback node:internal/streams/writable:762:63
      8   10.5%        JS: *parserOnIncoming node:_http_server:1028:26
      8  100.0%          JS: *parserOnHeadersComplete node:_http_common:71:33
     53   39.8%      JS: *value node:internal/console/constructor:277:20
     53  100.0%        JS: *log node:internal/console/constructor:384:6
     53  100.0%          /usr/local/bin/node
     53  100.0%            JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
      4    3.0%      JS: *resOnFinish node:_http_server:968:21
      4  100.0%        JS: *onFinish node:_http_outgoing:1025:18
      4  100.0%          JS: *callback node:internal/streams/writable:762:63
      4  100.0%            JS: *afterWriteTick node:internal/streams/writable:691:24
    108    1.7%    JS: *get node:_http_incoming:109:16
    108  100.0%      JS: *parserOnIncoming node:_http_server:1028:26
    108  100.0%        JS: *parserOnHeadersComplete node:_http_common:71:33
     89    1.4%    JS: *clearBuffer node:internal/streams/writable:742:21
     65   73.0%      JS: *assignSocket node:_http_server:281:62
     64   98.5%        JS: *resOnFinish node:_http_server:968:21
     64  100.0%          JS: *onFinish node:_http_outgoing:1025:18
     64  100.0%            JS: *callback node:internal/streams/writable:762:63
      1    1.5%        JS: ^resOnFinish node:_http_server:968:21
      1  100.0%          JS: *emit node:events:466:44
      1  100.0%            JS: ^onFinish node:_http_outgoing:1025:18
     21   23.6%      JS: *Writable.uncork node:internal/streams/writable:518:37
     21  100.0%        JS: *end node:_http_outgoing:1030:45
     21  100.0%          JS: *handle /app/index.js:33:16
     21  100.0%            JS: *parserOnIncoming node:_http_server:1028:26
      3    3.4%      JS: ^Writable.uncork node:internal/streams/writable:518:37
      3  100.0%        JS: *end node:_http_outgoing:1030:45
      3  100.0%          JS: *handle /app/index.js:33:16
      2   66.7%            JS: *emit node:events:466:44
      1   33.3%            JS: *parserOnIncoming node:_http_server:1028:26
     78    1.2%    JS: *$so2 /app/index.js:9:503
     78  100.0%      JS: *$so0 /app/index.js:9:189
     78  100.0%        JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
     78  100.0%          JS: *handle /app/index.js:33:16
     78  100.0%            JS: *parserOnIncoming node:_http_server:1028:26
     70    1.1%    JS: *parserOnIncoming node:_http_server:1028:26
     70  100.0%      JS: *parserOnHeadersComplete node:_http_common:71:33
     70    1.1%    JS: *parserOnHeadersComplete node:_http_common:71:33
     69    1.1%    JS: *value node:internal/console/constructor:277:20
     69  100.0%      JS: *log node:internal/console/constructor:384:6
     69  100.0%        /usr/local/bin/node
     69  100.0%          JS: *log /app/node_modules/tslog/dist/cjs/BaseLogger.js:88:8
     69  100.0%            JS: *handle /app/index.js:33:16
     64    1.0%    JS: *ServerResponse node:_http_server:195:24
     64  100.0%      JS: *parserOnIncoming node:_http_server:1028:26
     64  100.0%        JS: *parserOnHeadersComplete node:_http_common:71:33
```
:::

ã“ã‚Œä»¥ä¸Šã¯ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ã™ã‚‹ç­‰ã—ã¦console.logã®å‘¼ã³å‡ºã—å›æ•°ã‚’æ¸›ã‚‰ã™ç­‰ã®å·¥å¤«ã‚’ã™ã‚Œã°ã‚‚ã†å°‘ã—ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒä¸ŠãŒã‚Šãã†ã§ã™ã€‚(ç–²ã‚ŒãŸã®ã§ã“ã“ã§çµ‚ã‚ã‚‹)


## ã¾ã¨ã‚
- tslogã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ãƒã‚¹ã‚­ãƒ³ã‚°ã‚’è¡Œã„ãªãŒã‚‰æ§‹é€ åŒ–ãƒ­ã‚°ã‚’å‡ºåŠ›ã§ãã‚‹
- typiaã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«å‹æƒ…å ±ã‹ã‚‰ãƒ­ã‚°ã®æ§‹é€ ã‚’æ±ºå®šã§ãã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’ä¸¡ç«‹ã—ãªãŒã‚‰ãƒ­ã‚°ã‚’å‡ºåŠ›ã§ãã‚‹

