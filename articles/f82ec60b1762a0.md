---
title: "Terraformã¨API Managementã‚’ä½¿ç”¨ã—ãŸAzure OpenAIã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [openai, azure, api-management, terraform]
published: false
publication_name: aishift
---

ã“ã‚“ã«ã¡ã¯ã€[sugar-cat](https://twitter.com/sugar235711)ã§ã™ã€‚

æ˜¨ä»ŠLLMã®æ´»ç”¨ãŒå½“ãŸã‚Šå‰ã¨ãªã‚Šã¾ã—ãŸãŒã€æœ¬æ ¼çš„ã«æ´»ç”¨ã™ã‚‹ãŸã‚ã«ã¯**å„ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ¢ãƒ‡ãƒ«ã”ã¨ã®æ¨™æº–åŒ–**ã€**ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¸ã®å¯¾å¿œ**ã€**å¯ç”¨æ€§ã®å‘ä¸Š**ãªã©ã€æ§˜ã€…ãªè¦ç´ ã‚’è€ƒæ…®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€Terraformã‚’ä½¿ç”¨ã—ã¦Azure OpenAIã¨Azure API Managementã®çµ„ã¿åˆã‚ã›ã«ã‚ˆã‚Šã€**Azureç’°å¢ƒå†…ã§æ¯”è¼ƒçš„å®‰ä¾¡ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚’å®Ÿç¾ã™ã‚‹æ–¹æ³•ã®ä¸€ä¾‹**ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚â€»å„ã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°ãªèª¬æ˜ã¯çœç•¥ã—ã¾ã™ã€‚
ãªãŠã€API Managementã¯Basicã¾ãŸã¯Standardãƒ—ãƒ©ãƒ³ã‚’æƒ³å®šã—ã¦ãŠã‚Šã€VNetçµ±åˆãŒå¿…è¦ãªPrivate Endpointç­‰ã¯ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ã€‚

## API Managementã¨Azure OpenAI

æ—¢å‡ºã®æƒ…å ±ã§ã™ãŒã€Azure OpenAIã‚’åˆ©ç”¨ã™ã‚‹éš›ã«API Managementã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ç°¡å˜ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

https://techcommunity.microsoft.com/t5/fasttrack-for-azure/smart-load-balancing-for-openai-endpoints-and-azure-api/ba-p/3991616

API Managementã‚’ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦åˆ©ç”¨ã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«è¤‡æ•°ã®OpenAIã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç™»éŒ²ã™ã‚‹ã“ã¨ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æ•£ã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚
ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ†æ•£ã®è¨­å®šã¯**XMLã§å®šç¾©ã•ã‚ŒãŸãƒãƒªã‚·ãƒ¼ã‚’ç”¨ã„ã¦å®Ÿç¾**ã§ãã¾ã™ã€‚

```mermaid
graph TD
    A[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] -->|HTTPSãƒªã‚¯ã‚¨ã‚¹ãƒˆ| B[API Management]
    B --> C[API Management API]
    C --> D[API Managementãƒãƒªã‚·ãƒ¼]

    subgraph "API Managementãƒãƒªã‚·ãƒ¼"
        D1[ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã®ç¢ºèª]
        D2[æ¡ä»¶ã®è©•ä¾¡]
        D3{ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°}
        D4[ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°]
    end

    D --> D1
    D1 --> D2
    D2 --> D3
    D3 -->|æ¡ä»¶A| E1[OpenAI Service 1]
    D3 -->|æ¡ä»¶B| E2[OpenAI Service 2]
    D3 -->|æ¡ä»¶N| E3[OpenAI Service N]

    E1 -->|ãƒ¬ã‚¹ãƒãƒ³ã‚¹| F[API Management]
    E2 -->|ãƒ¬ã‚¹ãƒãƒ³ã‚¹| F[API Management]
    E3 -->|ãƒ¬ã‚¹ãƒãƒ³ã‚¹| F[API Management]
    F -->|HTTPSãƒ¬ã‚¹ãƒãƒ³ã‚¹| G[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ]
```

API Managementã®ã‚ˆã†ãªãƒãƒãƒ¼ã‚¸ãƒ‰ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’ä»‹ã™ã‚‹ã“ã¨ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®è©³ç´°ã‚’çŸ¥ã‚‹ã“ã¨ãªãã€API Managementã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã¾ã™ã€‚
ã¾ãŸãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚Š**è² è·åˆ†æ•£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆãƒ©ã‚¦ãƒ³ãƒ‰ãƒ­ãƒ“ãƒ³ã€é‡ã¿ä»˜ã‘ã€å„ªå…ˆåº¦ãƒ™ãƒ¼ã‚¹ï¼‰**ã‚’è¨­å®šã—ãŸã‚Šã€**ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼æ©Ÿèƒ½**ã‚’æŒãŸã›ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚
https://learn.microsoft.com/ja-jp/azure/api-management/backends

## Terraformã«ã‚ˆã‚‹å®Ÿè£…

æ¬¡ã«Terraformã‚’ä½¿ç”¨ã—ã¦API Managementã‚’æ§‹ç¯‰ã™ã‚‹éš›ã«å¿…è¦ãªä¸»è¦ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

1. `API Managementã®ãƒªã‚½ãƒ¼ã‚¹`
2. `Azure OpenAIã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ç™»éŒ²`
3. `API Managementã®ãƒãƒªã‚·ãƒ¼`
4. `Azure OpenAIã‚’APIã‚­ãƒ¼ãªã—ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã®Managed ID`

:::details Terraformå…¨ä½“
```tf
/**
 * API Managementç”¨ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
 */

resource "azurerm_resource_group" "aoai_lb_rg" {
  name     = "${var.env}-apim-aolb-rg"
  location = var.location
}

/**
 * API Managementæœ¬ä½“
 */
resource "azurerm_api_management" "aoai_lb_apim" {
  name                = "${var.env}-apim-aolb"
  location            = var.location
  resource_group_name = azurerm_resource_group.aoai_lb_rg.name
  publisher_name      = "xxx"
  publisher_email     = "xxx"
  sku_name = "Basic_1"

  identity {
    type = "UserAssigned"
    identity_ids = [
      azurerm_user_assigned_identity.aoai_lb_identity.id
    ]
  }
}

/**
 * API Managementã‹ã‚‰ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™
 */
resource "azurerm_user_assigned_identity" "aoai_lb_identity" {
  name                = "${var.env}-apim-aolb-identity"
  location            = azurerm_resource_group.aoai_lb_rg.location
  resource_group_name = azurerm_resource_group.aoai_lb_rg.name
}

resource "azurerm_role_assignment" "aoai_lb_role_assignment" {
  for_each             = var.openai_accounts
  scope                = each.value.id
  role_definition_name = "Cognitive Services OpenAI User"
  principal_id         = azurerm_user_assigned_identity.aoai_lb_identity.principal_id
}


/**
 * API Management APIã¨ã—ã¦ä½¿ç”¨ã§ãã‚‹APIã®å®šç¾©
 */
resource "azurerm_api_management_api" "aoai_lb_apim_api" {
  name                = "${var.env}-openai-api"
  resource_group_name = azurerm_resource_group.aoai_lb_rg.name
  api_management_name = azurerm_api_management.aoai_lb_apim.name
  revision            = "1"
  display_name        = "${var.env}-openai-api"
  path                = "openai"
  protocols           = ["https"]

  subscription_required = true
  subscription_key_parameter_names {
    header = "api-key"
    query  = "api-key"
  }

  import {
    content_format = "openapi+json"
    content_value  = file("${path.module}/openapi/openai.json")
  }
}

/**
 * API Management APIã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ä½¿ç”¨ã™ã‚‹OpenAIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
 */
resource "azurerm_api_management_backend" "aoai_lb_apim_backend" {
  for_each = var.openai_accounts

  name                = "${var.env}-openai-backend-${each.key}"
  resource_group_name = azurerm_api_management.aoai_lb_apim.resource_group_name
  api_management_name = azurerm_api_management.aoai_lb_apim.name
  description         = "${var.env}-openai-backend"
  url                 = each.value.endpoint
  protocol            = "http"
}

/**
 * OpenAIã®è² è·åˆ†æ•£ã‚’è¡Œã†ãŸã‚ã®ãƒãƒªã‚·ãƒ¼ã®è¨­å®š
 */
resource "azurerm_api_management_api_policy" "aoai_lb_apim_api_policy" {
  resource_group_name = azurerm_api_management.aoai_lb_apim.resource_group_name
  api_management_name = azurerm_api_management.aoai_lb_apim.name
  api_name            = azurerm_api_management_api.aoai_lb_apim_api.name
  xml_content         = templatefile("${path.module}/policy/openai.tftpl", {
    uris = { for key, value in var.openai_accounts : key => value.endpoint },
    client_id = azurerm_user_assigned_identity.aoai_lb_identity.client_id
  })
}
```
:::

### 1. API Managementã®ãƒªã‚½ãƒ¼ã‚¹

API Managementã«ã¯v1/v2ã®ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã€ãã‚Œãã‚Œã§SLAã‚„ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒ«ã®ä¸Šé™ãŒç•°ãªã‚Šã¾ã™ã€‚
https://azure.microsoft.com/ja-jp/pricing/details/api-management/
â€»ã“ã®è¨˜äº‹ã§ã¯ç´¹ä»‹ã—ã¾ã›ã‚“ãŒã€ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ã«åˆ©ç”¨ã™ã‚‹ã«ã¯Azure OpenAIã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã«å…¬é–‹ã›ãšã€VNetçµ±åˆã‚’è¡Œã†ã“ã¨ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

```tf
resource "azurerm_api_management" "aoai_lb_apim" {
  name                = "${var.env}-apim-aolb"
  location            = var.location
  resource_group_name = azurerm_resource_group.aoai_lb_rg.name
  publisher_name      = "Hoge"
  publisher_email     = "hoge@example.com"
  sku_name = "Basic_1"
}
```

Azure OpenAIã§ã¯ã€å„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã”ã¨ã®OpenAPIãŒå…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/Azure/azure-rest-api-specs/tree/main/specification/cognitiveservices/data-plane/AzureOpenAI/inference/stable

ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ã€API Managementã«APIã‚’ç™»éŒ²ã—ã¾ã™ã€‚importãƒ–ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€OpenAPIã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚

```tf
resource "azurerm_api_management_api" "aoai_lb_apim_api" {
  # ...

  import {
    content_format = "openapi+json"
    content_value  = file("${path.module}/openapi/openai.json")
  }
}
```

OpenAPIã®ä¸­èº«ã¯åŸºæœ¬çš„ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€`servers`ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ãã‚Œãã‚Œã®ç’°å¢ƒã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

```json
"servers": [
    {
        "url": "https://{endpoint}/openai",
        "variables": {
            "endpoint": {
                "default": "https://example.xxx.openai.azure.com" <-ã“ã“
            }
        }
    }
]
```

ã“ã‚Œã‚’èª­ã¿è¾¼ã‚€ã¨API Managementã«APIãŒç™»éŒ²ã•ã‚Œã¾ã™ã€‚

![alt text](/images/azure/apim/apim1.png)

### 2. Azure OpenAIã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ç™»éŒ²

API Managementã‚’ä½œæˆã—ãŸã‚‰ã€å®Ÿéš›ã«ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã—ãŸã„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
`azurerm_cognitive_account`ã‹ã‚‰`openai`ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—ã—ã€ãã‚Œã‚’API Managementã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚

```tf
variable "cognitive_accounts" {
  description = "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨ã®OpenAIã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒãƒƒãƒ—"
  type = map(object({
    endpoint = string
    id       = string
  }))
}

resource "azurerm_api_management_backend" "aoai_lb_apim_backend" {
  for_each = var.cognitive_accounts

  name                = "${var.env}-openai-backend-${each.key}"
  resource_group_name = azurerm_api_management.aoai_lb_apim.resource_group_name
  api_management_name = azurerm_api_management.aoai_lb_apim.name
  description         = "${var.env}-openai-backend"
  url                 = each.value.endpoint
  protocol            = "http"
}
```

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ç™»éŒ²ã™ã‚‹ã¨ã€APIs > Backendsã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
![alt text](/images/azure/apim/apim2.png)

### 3. API Managementã®ãƒãƒªã‚·ãƒ¼

ãƒãƒªã‚·ãƒ¼ã¯å®šç¾©æ¸ˆã¿ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ã‚‚ã¨ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ†æ•£ã•ã›ãŸã‚Šã€Managed Identityã‚’åˆ©ç”¨ã—ã¦èªè¨¼ã‚’è¡Œã†ãŸã‚ã®è¨­å®šã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
XMLã§è¨˜è¿°ã™ã‚‹ãŸã‚ã€Terraformã®`templatefile`ã‚’åˆ©ç”¨ã—ã¦å‹•çš„ã«å€¤ã‚’åŸ‹ã‚è¾¼ã¿ã¾ã™ã€‚

```tf
resource "azurerm_api_management_api_policy" "aoai_lb_apim_api_policy" {
  resource_group_name = azurerm_api_management.aoai_lb_apim.resource_group_name
  api_management_name = azurerm_api_management.aoai_lb_apim.name
  api_name            = azurerm_api_management_api.aoai_lb_apim_api.name
  xml_content         = templatefile("${path.module}/policy/openai.tftpl", {
    uris = { for key, value in var.cognitive_accounts : key => value.endpoint },
    client_id = azurerm_user_assigned_identity.aoai_lb_identity.client_id
  })
}
```

XMLã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦è¨˜è¿°ã—å‹•çš„ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’åŸ‹ã‚è¾¼ã‚ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```xml:openai.tftpl
<policies>
    <inbound>
        <base />
    </inbound>
    <backend>
        <choose>
            <!-- å®šç¾©æ¸ˆã¿ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶ -->
            <when condition="@(true)">
                <set-variable name="backendUrl" value="@{
                    var backends = new System.Collections.Generic.List<string>(){
                        %{ for key, uri in uris }
                        "${uri}",
                        %{ endfor }
                    };
                    return backends[new System.Random().Next(0, backends.Count)];
                }" />
                <set-backend-service base-url="@((string)context.Variables["backendUrl"])" />
            </when>
        </choose>
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
    </on-error>
</policies>
```

ä¸Šè¨˜ã®ã‚ˆã†ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨ã—ã¦è¨˜è¿°ã—ã¦ãŠãã“ã¨ã§ã€å°†æ¥Cognitive AccountãŒè¿½åŠ ã•ã‚ŒãŸã‚Šå¤‰æ›´ã•ã‚ŒãŸéš›ã‚‚ãƒãƒªã‚·ãƒ¼è‡ªä½“ã®ä¿®æ­£ã¯å¿…è¦ã‚ã‚Šã¾ã›ã‚“ã€‚

### 4. Azure OpenAIã‚’APIã‚­ãƒ¼ãªã—ã§åˆ©ç”¨ã™ã‚‹ãŸã‚ã®Managed ID

ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹Azure OpenAIã«ã¯ã€APIã‚­ãƒ¼ã¾ãŸã¯Managed IDã«ã‚ˆã‚‹æ¥ç¶šãŒå¯èƒ½ã§ã™ã€‚
ä»Šå›ã¯APIã‚­ãƒ¼ã®ç®¡ç†ã‚’è¡Œã„ãŸããªã„ãŸã‚ã€Managed IDã«ã‚ˆã‚‹èªè¨¼æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

å¿…è¦ãªUser Assigned Identityã‚’ä½œæˆã—ã€`Cognitive Services OpenAI User`ã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

```tf
resource "azurerm_user_assigned_identity" "aoai_lb_identity" {
  name                = "${var.env}-apim-aolb-identity"
  location            = azurerm_resource_group.aoai_lb_rg.location
  resource_group_name = azurerm_resource_group.aoai_lb_rg.name
}

resource "azurerm_role_assignment" "aoai_lb_role_assignment" {
  for_each             = var.openai_accounts
  scope                = each.value.id
  role_definition_name = "Cognitive Services OpenAI User"
  principal_id         = azurerm_user_assigned_identity.aoai_lb_identity.principal_id
}
```

ãã®å¾Œ1ã§å®šç¾©ã—ãŸ`azurerm_api_management`ãƒªã‚½ãƒ¼ã‚¹ã®`identity`ãƒ–ãƒ­ãƒƒã‚¯ã«User Assigned Identityã‚’å‰²ã‚Šå½“ã¦ã¾ã™ã€‚

```tf
resource "azurerm_api_management" "aoai_lb_apim" {
  # ...
  identity {
    type = "UserAssigned"
    identity_ids = [
      azurerm_user_assigned_identity.aoai_lb_identity.id
    ]
  }
}
```

æœ€å¾Œã«3ã§å®šç¾©ã—ãŸãƒãƒªã‚·ãƒ¼å†…ã§ã€Authorizationãƒ˜ãƒƒãƒ€ãƒ¼ã‚’Managed IDã‹ã‚‰å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã§ä¸Šæ›¸ãã™ã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

```xml
<policies>
    <inbound>
        <!-- Managed IDã®è¨­å®š -->
        <authentication-managed-identity
            resource="https://example.com"
            output-token-variable-name="msi-access-token"
            client-id="${client_id}"
            ignore-error="false" />
        <set-header name="Authorization" exists-action="override">
            <value>@("Bearer " + (string)context.Variables["msi-access-token"])</value>
        </set-header>
    </inbound>
    <!-- ... -->
</policies>
```

ä»¥ä¸Šã®è¨­å®šã‚’è¡Œã†ã“ã¨ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰API Managementã«é€ä¿¡ã•ã‚ŒãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã€API Managementã®ãƒãƒªã‚·ãƒ¼ã«å¾“ã£ã¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã‚’é¸æŠã—ã€Managed IDã«ã‚ˆã‚‹èªè¨¼ã‚’çµŒã¦Azure OpenAIã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### å‹•ä½œç¢ºèª

ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§OpenAIã®SDKã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã†ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ãã®éš›ã€API Managementå´ã§é©å®œã‚¹ã‚³ãƒ¼ãƒ—ã‚’çµã£ãŸã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€å¿…è¦ã«å¿œã˜ã¦ç™ºè¡Œã—ã€`api-key`ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã«ä»˜ä¸ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ã¾ã™ã€‚

```python
import os
from dotenv import load_dotenv
from openai import AzureOpenAI

load_dotenv()

api_key = os.getenv("AZURE_OPENAI_API_KEY")
apim_url = os.getenv("AZURE_OPENAI_APIM_URL")
client = AzureOpenAI(
    azure_endpoint=apim_url,
    api_key=api_key,
    api_version="2023-06-01-preview"
)

response = client.chat.completions.create(
    model="gpt-35-turbo",
    messages=[
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "Does Azure OpenAI support customer managed keys?"}
    ]
)
print(response)
```

ã¾ãŸã€API Managementã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`Ocp-Apim-Subscription-Key`ã‚’ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã¨ã—ã¦èªè­˜ã™ã‚‹ãŸã‚ã€ã‚ã‚‰ã‹ã˜ã‚ä¸Šæ›¸ãã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```tf
resource "azurerm_api_management_api" "aoai_lb_apim_api" {
    # ...

  subscription_required = true
  subscription_key_parameter_names {
    header = "api-key"
    query  = "api-key"
  }
}
```

https://learn.microsoft.com/ja-jp/azure/api-management/api-management-subscriptions#create-and-manage-subscriptions-in-azure-portal

æ®‹å¿µãªãŒã‚‰ã“ã®ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã‚­ãƒ¼ã«ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®ä»•çµ„ã¿ãŒç”¨æ„ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€è‡ªå‰ã§APIã‚’å©ããªã©ã—ã¦å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
https://learn.microsoft.com/en-us/rest/api/apimanagement/subscription/regenerate-primary-key?view=rest-apimanagement-2023-09-01-preview&tabs=HTTP

## ã¾ã¨ã‚

API Managementã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Azure OpenAIã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã‚’ç°¡å˜ã«å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä»–ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¸ã®ä¾å­˜ãŒãªãã€ç¤¾å†…ã®æ¤œè¨¼ç”¨ç’°å¢ƒã§ã‚ã‚Œã°Basicã‚„Standardãƒ—ãƒ©ãƒ³ã§ã‚‚ååˆ†ãªæ€§èƒ½ã‚’ç™ºæ®ã™ã‚‹ãŸã‚ã€å®‰ä¾¡ã«é‹ç”¨ã§ãã¾ã™ã€‚
Azure OpenAIã‚’åˆ©ç”¨ã™ã‚‹éš›ã«ã¯ãœã²æ¤œè¨ã—ã¦ã¿ã¦ãã ã•ã„ã€‚
