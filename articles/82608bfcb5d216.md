---
title: "SQSã§1åˆ†æœªæº€ã®å®šæœŸå®Ÿè¡Œã‚’å®Ÿç¾ã™ã‚‹"
emoji: "ğŸ§"
type: "tech" 
topics: [aws, sqs, lambda, localstack, cron]
published: false
---


ã“ã‚“ã«ã¡ã¯ã€[sugar-cat](https://twitter.com/sugar235711)ã§ã™ã€‚

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã§ã¯ã€çŸ­ã„é–“éš”ã§å®šæœŸçš„ãªå‡¦ç†ã‚’å®Ÿè¡Œã—ãŸã„å ´é¢ãŒã‚ˆãã‚ã‚Šã¾ã™ã€‚
å¤šãã®ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€cronå¼ã‚„rateå¼ã‚’ä½¿ç”¨ã—ã¦å®šæœŸå®Ÿè¡Œã‚’è¨­å®šã§ãã¾ã™ãŒã€**1åˆ†æœªæº€ã®é–“éš”**ã§ã®å®Ÿè¡ŒãŒå¿…è¦ãªå ´åˆã¯å·¥å¤«ãŒå¿…è¦ã§ã™ã€‚

[Amazon EventBridge](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/with-eventbridge-scheduler.html)ãªã©ã§ã¯ã€æœ€å°å˜ä½ãŒã€Œ1åˆ†ã€ã§ã‚ã‚Šã€1åˆ†æœªæº€ã®é »åº¦ã§å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§ç§’å˜ä½ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒã€èµ·å‹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ç®¡ç†ã‚„ã‚¹ã‚±ãƒ¼ãƒ«æ™‚ã®æŒ™å‹•ãªã©ã€è€ƒæ…®ã™ã¹ãäº‹é …ãŒå¢—ãˆã¦ã—ã¾ã„ã¾ã™ã€‚ã§ãã‚‹ã ã‘å˜ç´”åŒ–ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å—ä¿¡ã«å¿œã˜ã¦å‡¦ç†ã‚’è¡Œã†ã ã‘ã«ã—ãŸã„ã§ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€ã“ã†ã—ãŸè¦ä»¶ã‚’ç°¡å˜ã«å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€**SQSã‚’ä½¿ç”¨ã—ã¦1åˆ†æœªæº€ã®å®šæœŸå®Ÿè¡Œã‚’å®Ÿç¾ã™ã‚‹æ–¹æ³•**ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## æ–¹æ³•

ä»Šå›ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã¯ã€SQSã‚­ãƒ¥ãƒ¼ã®**é…å»¶å®Ÿè¡Œ**æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚ã“ã®ä¾‹ã§ã¯AWSã®SQSã‚’ä½¿ç”¨ã—ã¾ã™ãŒã€Google Cloudã‚„Azureã§ã‚‚åŒæ§˜ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã§ãã¾ã™ï¼ˆGoogle Cloud Pub/Subã§ã¯é…å»¶å®Ÿè¡ŒãŒåˆ¶å¾¡ã§ããªã„ãŸã‚ã€Cloud Tasksãªã©ã‚’ä½¿ã†ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ï¼‰ã€‚

### å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ãƒ­ãƒ¼ã§å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

1. **EventBridgeãªã©ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã§Publisherã‚’å‘¼ã³å‡ºã™**
2. PublisherãŒè¤‡æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã€ç•°ãªã‚‹é…å»¶æ™‚é–“ã‚’è¨­å®šã—ã¦ã‚­ãƒ¥ãƒ¼ã«é€ä¿¡
3. **Subscriber**ãŒã‚­ãƒ¥ãƒ¼å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ã—ã€é †æ¬¡å‡¦ç†ã‚’å®Ÿè¡Œ

ä¾‹ãˆã°ã§ã™ãŒã€Publisherã‚’EventSchedulerã§3åˆ†ã”ã¨ã«å‘¼ã³å‡ºã—ã€SQSã«20ç§’ã®é…å»¶ã‚’ã¤ã‘ã¦9å›åˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ãŠãã“ã¨ã§æ“¬ä¼¼çš„ã«20ç§’é–“éš”ã§Subscriberå´ã®å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```mermaid
sequenceDiagram
    autonumber
    participant Scheduler
    participant Publisher
    participant SQS as SQS Queue
    participant Subscriber

    Scheduler ->> Publisher: 3åˆ†ã”ã¨ã«Publisherã‚’å‘¼ã³å‡ºã—
    loop ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã”ã¨ã«ç•°ãªã‚‹é…å»¶æ™‚é–“ã‚’è¨­å®š
        Publisher ->> SQS: è¤‡æ•°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ï¼ˆ20ç§’é–“éš”ã®é…å»¶ã‚’è¨­å®šï¼‰
    end
    loop å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã”ã¨
        SQS ->> Subscriber: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é †æ¬¡é…ä¿¡
        Subscriber ->> Subscriber: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†
    end
```


:::message
ã“ã®ä¾‹ã§ã¯ã€é€šå¸¸ã®SQSã‚­ãƒ¥ãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ãŒã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é‡è¤‡é…ä¿¡ã‚’å³å¯†ã«é˜²ããŸã„å ´åˆã¯FIFOã‚­ãƒ¥ãƒ¼ã‚’ä½¿ã†ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚
https://docs.aws.amazon.com/ja_jp/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-fifo-queues.html
:::


ä»Šå›ã¯LocalStackã‚’ä½¿ç”¨ã—ã¦æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚PublisheråŠã³Subscriberã®Lambdaé–¢æ•°ã‚’ãã‚Œãã‚Œä½œæˆã—ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§Bupulisherã‚’å‘¼ã³å‡ºã—ã€ä¸€å®šé–“éš”ã®ç§’æ•°ã§SubscriberãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚

```go:publisher.go
package main

import (
	"context"
	"encoding/json"
	"fmt"
	"log"
	"time"

	"github.com/aws/aws-lambda-go/lambda"
	"github.com/aws/aws-sdk-go-v2/aws"
	"github.com/aws/aws-sdk-go-v2/config"
	"github.com/aws/aws-sdk-go-v2/credentials"
	"github.com/aws/aws-sdk-go-v2/service/sqs"
	"github.com/aws/aws-sdk-go-v2/service/sqs/types"
)

const queueURL = "http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/test-queue"

type Message struct {
	Timestamp int64  `json:"timestamp"`
	Content   string `json:"content"`
}

func Handler(ctx context.Context) (string, error) {
	cfg, err := config.LoadDefaultConfig(context.TODO(),
		config.WithRegion("us-east-1"),
		config.WithCredentialsProvider(credentials.NewStaticCredentialsProvider("dummy", "dummy", "")),
		config.WithBaseEndpoint("http://sqs.us-east-1.localhost.localstack.cloud:4566"),
	)
	if err != nil {
		log.Fatalf("unable to load SDK config, %v", err)
	}

	svc := sqs.NewFromConfig(cfg)

	var entries []types.SendMessageBatchRequestEntry
	now := time.Now().Unix()

	// 1ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’20ç§’ã”ã¨ã®é…å»¶ä»˜ãã§ã‚­ãƒ¥ãƒ¼ã«æŠ•å…¥
	for i := 1; i <= 9; i++ {
		delaySeconds := int32(i * 20)
		// 20ç§’ã”ã¨ã®é…å»¶
		msg := Message{
			Timestamp: now,
			Content:   fmt.Sprintf("Triggering job %d", i),
		}
		msgBody, _ := json.Marshal(msg)

		entries = append(entries, types.SendMessageBatchRequestEntry{
			Id:           aws.String(fmt.Sprintf("msg_%d", i)),
			MessageBody:  aws.String(string(msgBody)),
			DelaySeconds: delaySeconds,
		})
	}

	// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒãƒƒãƒé€ä¿¡
	_, err = svc.SendMessageBatch(context.TODO(), &sqs.SendMessageBatchInput{
		QueueUrl: aws.String(queueURL),
		Entries:  entries,
	})
	if err != nil {
		log.Printf("Error sending batch: %v", err)
		return "", err
	}
	return "Messages queued successfully", nil
}

func main() {
	lambda.Start(Handler)
}
```

```go:subscriber.go
package main

import (
	"context"
	"encoding/json"
	"log"
	"time"

	"github.com/aws/aws-lambda-go/events"
	"github.com/aws/aws-lambda-go/lambda"
	"github.com/aws/aws-sdk-go-v2/aws"
	"github.com/aws/aws-sdk-go-v2/config"
	"github.com/aws/aws-sdk-go-v2/credentials"
	"github.com/aws/aws-sdk-go-v2/service/sqs"
)

const queueURL = "http://sqs.us-east-1.localhost.localstack.cloud:4566/000000000000/test-queue"

type Message struct {
	Timestamp int64  `json:"timestamp"`
	Content   string `json:"content"`
}

func Handler(ctx context.Context, sqsEvent events.SQSEvent) {
	cfg, err := config.LoadDefaultConfig(context.TODO(),
		config.WithRegion("us-east-1"),
		config.WithCredentialsProvider(credentials.NewStaticCredentialsProvider("dummy", "dummy", "")),
		config.WithBaseEndpoint("http://sqs.us-east-1.localhost.localstack.cloud:4566"),
	)
	if err != nil {
		log.Fatalf("unable to load SDK config, %v", err)
	}

	svc := sqs.NewFromConfig(cfg)

	// å„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†
	for _, record := range sqsEvent.Records {
		var msg Message
		err := json.Unmarshal([]byte(record.Body), &msg)
		if err != nil {
			log.Printf("Error parsing message: %v", err)
			continue
		}

		// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ã¨å‡¦ç†æ™‚é–“ã®è¨ˆæ¸¬
		arrivalTime := time.Now().Unix()
		delay := arrivalTime - msg.Timestamp

		// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‰Šé™¤ï¼ˆACKï¼‰
		_, err = svc.DeleteMessage(context.TODO(), &sqs.DeleteMessageInput{
			QueueUrl:      aws.String(queueURL),
			ReceiptHandle: aws.String(record.ReceiptHandle),
		})
		if err != nil {
			log.Printf("Failed to delete message: %v", err)
			continue
		}
	}
}

func main() {
	lambda.Start(Handler)
}
```

ä¸Šè¨˜ã‚’ãƒ“ãƒ«ãƒ‰ã—ã€localstackã‚’èµ·å‹•ã—ãŸçŠ¶æ…‹ã§Lambdaé–¢æ•°ã¨SQSã‚­ãƒ¥ãƒ¼ã€ãƒˆãƒªã‚¬ãƒ¼ã‚’ä½œæˆã—ã¾ã™ã€‚
```bash
# publiser
awslocal lambda create-function --function-name PublisherFunction \
    --runtime go1.x --handler publisher --zip-file fileb://publisher.zip \
    --role arn:aws:iam::000000000000:role/lambda-role

# subscriber
awslocal lambda create-function --function-name SubscriberFunction \
    --runtime go1.x --handler subscriber --zip-file fileb://subscriber.zip \
    --role arn:aws:iam::000000000000:role/lambda-role

# sqs
awslocal sqs create-queue --queue-name test-queue                

# event source mapping
awslocal lambda create-event-source-mapping --function-name SubscriberFunction \
    --batch-size 9 \
    --event-source-arn arn:aws:sqs:us-east-1:000000000000:test-queue
```


ãƒªã‚½ãƒ¼ã‚¹ä½œæˆå¾Œã«publisherã‚’å‘¼ã³å‡ºã—ã€subscriberå´ã®èµ·å‹•æ™‚é–“ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¾ã™ã€‚

```bash
# invoke
awslocal lambda invoke --function-name PublisherFunction output.json

# log
awslocal logs get-log-events --log-group-name /aws/lambda/SubscriberFunction --log-stream-name 2024/11/02/\[\$LATEST\]b3d025f2eeac8c63595c6b6d61b692cb | \
jq -r '.events[] | select(.message | startswith("START")) | .timestamp' | \
while read timestamp; do date -r $((timestamp / 1000)) +"%Y-%m-%d %H:%M:%S"; done
```

å®Ÿè¡Œã—ãŸçµæœã¯ä¸‹è¨˜ã§ã™ã€‚20ç§’ã”ã¨ã«Subscriberã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
```log
2024-11-02 19:24:38
2024-11-02 19:24:58
2024-11-02 19:25:18
2024-11-02 19:25:38
2024-11-02 19:25:58
2024-11-02 19:26:18
2024-11-02 19:26:38
2024-11-02 19:26:58
2024-11-02 19:27:18
```

å®Ÿéš›ã®ç’°å¢ƒã§ã¯åˆ†æ•£å®Ÿè¡Œã®ãŸã‚ã‚¿ã‚¤ãƒ ãƒ©ã‚°ã‚„Lambdaã®èµ·å‹•æ™‚é–“ãªã©ãŒåˆã‚ã•ã‚Šã€æ­£ç¢ºãªç§’æ•°ã§ã®å‡¦ç†ã¯é›£ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€æ•°ç§’ç¨‹åº¦ã®ãšã‚ŒãŒè¨±å®¹ã§ãã‚‹å ´åˆã«ã¯æœ‰ç”¨ãªæ–¹æ³•ã ã¨æ€ã„ã¾ã™ã€‚

## ã¾ã¨ã‚

SQSã®é…å»¶å®Ÿè¡Œæ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€1åˆ†æœªæº€ã®å®šæœŸå®Ÿè¡Œã‚’ç°¡å˜ã«å®Ÿç¾ã§ãã‚‹ã“ã¨ã§ãã¾ã™ã€‚

