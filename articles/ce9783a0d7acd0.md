---
title: "æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºã§3ãƒ¶æœˆçµŒã£ãŸã®ã§ã€è©¦ã—ãŸæŠ€è¡“ã‚„å–ã‚Šçµ„ã¿ã‚’ã¾ã¨ã‚ã¦ã¿ãŸ"
emoji: "ğŸ’¨"
type: "tech"
topics: ["typescript", "bun", "hono", "drizzle", "casbin"]
published: false
---

ã“ã‚“ã«ã¡ã¯ã€AIShift ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®çŸ³äº•([@sugar235711](https://twitter.com/sugar235711))ã§ã™ã€‚

AIShiftã§ã¯å»å¹´ã®11æœˆã‹ã‚‰`AI Worker`^[https://www.ai-shift.co.jp/3958]ã¨ã„ã†æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã®é–‹ç™ºãŒå§‹ã¾ã‚Šã¾ã—ãŸã€‚ï¼ˆä»¥ä¸‹AI Workerï¼‰
æœ¬æ ¼çš„ã«é–‹ç™ºãŒå§‹ã¾ã‚Š3ãƒ¶æœˆå¼±çµŒã£ãŸã®ã§ã€ãã®é–“ã«è©¦ã—ã¦ããŸæŠ€è¡“ã‚„ãƒãƒ¼ãƒ ã®å–ã‚Šçµ„ã¿ã«ã¤ã„ã¦ã¾ã¨ã‚ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚


# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã§ã¯ã€AI Workerã®ãŠãŠã¾ã‹ãªæ¦‚è¦ãƒ»è¨­è¨ˆã‚’èª¬æ˜ã—ã€ãã‚Œã‚‰ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å®Ÿç¾ã™ã‚‹ä¸Šã§ã©ã®ã‚ˆã†ãªæŠ€è¡“ã‚’è©¦ã—ã¦ããŸã®ã‹ã€æŠ€è¡“ä»¥å¤–ã§ã®ãƒãƒ¼ãƒ ã®å–ã‚Šçµ„ã¿ã«ã¤ã„ã¦ã¾ã¨ã‚ã¾ã™ã€‚

å°‘ã—åˆ†é‡ãŒå¤šã„ã®ã§ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã«ã¤ã„ã¦ã®æƒ…å ±ã‚’æ±‚ã‚ã¦ã„ã‚‹æ–¹ã¯ã€ç›®æ¬¡ã‹ã‚‰æ°—ã«ãªã‚‹éƒ¨åˆ†ã‚’èª­ã‚“ã§ã„ãŸã ã‘ã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

# ä½•ã‚’ä½œã£ã¦ã„ã‚‹ã®ã‹

ã–ã£ãã‚Šã¾ã¨ã‚ã‚‹ã¨ã€`Microsoft Teams/Web`ä¸Šã§å‹•ãAIã‚’æ´»ç”¨ã—ãŸæ¥­å‹™æ”¹å–„ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚
GPTã¨RAGã‚’çµ„ã¿åˆã‚ã›ãŸç¤¾å†…æƒ…å ±æ¤œç´¢ç­‰ã€æ§˜ã€…ãªæ±ç”¨çš„ãªã‚¿ã‚¹ã‚¯ã‚’ä½¿ç”¨ã§ãã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚

![Alt text](/images/aiworker/aiworker.png =600x)


# å…¨ä½“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

AI Workerã¯ç¾çŠ¶ä¸‹è¨˜ã®æ©Ÿèƒ½ç¾¤ã®å®Ÿè£…ãŒå®Œäº†ã—ã¦ãŠã‚Šã€æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹ã«å‘ã‘ã¦é–‹ç™ºã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚

- **RAGã‚’çµ„ã¿åˆã‚ã›ãŸChatGPT Likeã®ãƒãƒ£ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ (Streamã‚’æ‰±ã†)**
- **Entra IDã‚’æ´»ç”¨ã—ãŸãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½**
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã«å¿œã˜ãŸæ©Ÿèƒ½ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**
- **Teamsã®Tabã‚¢ãƒ—ãƒª/Webä¸Šã§ã®å‹•ä½œ**


ç‰¹ã«ãƒãƒ£ãƒƒãƒˆã‚µãƒ¼ãƒ“ã‚¹ã®è‚ã¨ãªã‚‹GPTã¯Azure OpenAIã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€Quotaã®åˆ¶é™å›é¿ã‚„RAGã‚’æ‰±ã†ãŸã‚ã«è¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹ã«åˆ†å‰²ã—ã€AIãƒãƒ¼ãƒ ã¨å…±åŒã§é–‹ç™ºã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

![Alt text](/images/aiworker/overall.png)


ã“ã®è¨˜äº‹ã§ã¯ã€AIãƒãƒ¼ãƒ å´ãŒé–‹ç™ºã—ã¦ã„ã‚‹ã‚µãƒ¼ãƒ“ã‚¹(ä»¥ä¸‹ã€AI Dialog)ã¨ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ä¸­é–“ã«ä½ç½®ã™ã‚‹ã€Œ**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®é–‹ç™º**ã€ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦èª¬æ˜ã—ã¦ã„ãã¾ã™ã€‚


## AI Workerã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

AI Workerã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯ã€ä¸»ã«ä»¥ä¸‹ã®è²¬å‹™ã‚’æ‹…ã£ã¦ã„ã¾ã™ã€‚
- **ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã®ç®¡ç†**
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ãƒ»èªå¯**
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã«å¿œã˜ãŸæ©Ÿèƒ½ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**
- **å±¥æ­´ãƒ»è¨­å®šå€¤ã®ç®¡ç†**
- **AI Dialogã¸ã®ä¸­ç¶™**

è¤‡æ•°ä¼æ¥­æ§˜ã«ä½¿ç”¨ã—ã¦ã„ãŸã ãSaaSã®å½¢å¼ã®ãŸã‚ã€å¿…ç„¶çš„ã«ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã«è€ãˆã†ã‚‹å½¢ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­è¨ˆã‚’è¡Œã†ãªã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†ä½“ç³»ã«é–¢ã—ã¦ã¯ã€ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ‡ãƒ«^[https://www.slideshare.net/AmazonWebServicesJapan/20220107-multi-tenant-database]ã‚’æ¡ç”¨ã—ã€å„ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ†é›¢ã—ã¦ã„ã¾ã™ã€‚

![Alt text](/images/aiworker/bridge.png)


ã•ã‚‰ã«ãƒ†ãƒŠãƒ³ãƒˆã®ä¸­ã«`ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹`ã€`ãƒãƒ¼ãƒ `ã¨ã„ã†æ¦‚å¿µã‚’è¨­ã‘ã¦ã€ãã®ç®¡ç†è€…ã«å¯¾ã—ã¦ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹ã“ã¨ã§ã€å„ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹éšå±¤æ§‹é€ ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡(RBAC)ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

![Alt text](/images/aiworker/usecase.png)



# ã©ã®ã‚ˆã†ãªæŠ€è¡“ã‚’è©¦ã—ã¦ã„ã‚‹ã®ã‹

ã•ã¦ã€ã“ã“ã¾ã§ã§AI Workerã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒã©ã®ã‚ˆã†ãªæ©Ÿèƒ½ã‚’æŒã£ã¦ã„ã‚‹ã®ã‹ã€ã©ã®ã‚ˆã†ãªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ãªã£ã¦ã„ã‚‹ã®ã‹ã®æ¦‚è¦ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚
æ¬¡ã«ä¸Šè¨˜ã®æ©Ÿèƒ½ç¾¤ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ã©ã®ã‚ˆã†ãªæŠ€è¡“ã‚’è©¦ã—ã¦ããŸã®ã‹ã‚’ã¾ã¨ã‚ã¦ã¿ãŸã„ã¨æ€ã„ã¾ã™ã€‚

## æŠ€è¡“é¸å®šã®èƒŒæ™¯

å‰æã¨ã—ã¦ã€AI Workerã®é–‹ç™ºãƒãƒ¼ãƒ ã¯å½“åˆ`PM: 1/ãƒ‡ã‚¶ã‚¤ãƒ³å…¼ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: 1/ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‘`ã®è¨ˆ3äººã§æ§‹æˆã•ã‚Œã¦ãŠã‚Šã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æŠ€è¡“é¸å®šã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ¡ä»¶ä¸‹ã§è¡Œã‚ã‚Œã¾ã—ãŸã€‚

- **ãƒ¡ãƒ³ãƒãƒ¼ã®ã‚¹ã‚­ãƒ«ã‚»ãƒƒãƒˆãŒãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«å¯„ã£ã¦ã„ã‚‹**
- **æœ€å°é™ã®æ©Ÿèƒ½ã‚’æ—©ããƒªãƒªãƒ¼ã‚¹ã—ãŸã„**
- **ã‚³ã‚¹ãƒˆã‚’å¯èƒ½ãªé™ã‚ŠæŠ‘ãˆãŸã„**

ãã®ãŸã‚ã€ãƒ¡ãƒ³ãƒãƒ¼ãŒæ…£ã‚Œã¦ã„ã¦ã‹ã¤ã€ã‚ªãƒ¼ãƒ«ã‚¤ãƒ³ãƒ¯ãƒ³ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¤šãã€~~å¯èƒ½ãªé™ã‚Šæ¥½ã—ã¦~~é–‹ç™ºã‚’é€²ã‚ã‚‰ã‚Œãã†ãªTypeScriptã§é–‹ç™ºã™ã‚‹ã“ã¨ã‚’æ±ºå®šã—ã¾ã—ãŸã€‚
ã¾ãŸå½“åˆã¯AIé–¢é€£ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®ç›¸æ€§ãŒè‰¯ã„Cloudflare Workersã‚’ãƒ™ãƒ¼ã‚¹ã«é–‹ç™ºã‚’é€²ã‚ã‚‹äºˆå®šã ã£ãŸã®ã§ã€ãã‚Œã«åˆã‚ã›ãŸæŠ€è¡“é¸å®šã‚’è¡Œã„ã¾ã—ãŸã€‚

:::details ãªãœCloudflare WorkersãŒAIé–¢é€£ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨ã®ç›¸æ€§ãŒè‰¯ã„ã®ã‹

2023/10/31ã‚ˆã‚Šã€[Cloudflare Workersã®èª²é‡‘ä½“ç³»ãŒå¤‰æ›´](https://blog.cloudflare.com/workers-pricing-scale-to-zero)ã•ã‚Œã€CPUæœªä½¿ç”¨æ™‚ã¯èª²é‡‘ã•ã‚Œãªã„ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä»–ã®FaaSã¨æ¯”è¼ƒã—ã¦ã€CPUæœªä½¿ç”¨æ™‚ã®ã‚³ã‚¹ãƒˆãŒéå¸¸ã«ä½ããªã‚Šã¾ã—ãŸã€‚


Streamingã‚’æ‰±ã†å ´åˆã§ã‚‚ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãŒè¿”ã•ã‚ŒãŸæ™‚ç‚¹ã§ã€idleçŠ¶æ…‹ã¨è¦‹ãªã•ã‚Œã‚‹ãŸã‚ã€Streamingä¸­ã®æ™‚é–“ã‚‚èª²é‡‘ã•ã‚Œã¾ã›ã‚“ã€‚

https://blog.cloudflare.com/workers-optimization-reduces-your-bill/

>since the system now considers a Worker to be idle during response streaming, the response streaming time will no longer be billed.

ãã®ãŸã‚ã€AI Workerã®ã‚ˆã†ãªOpenAIç­‰ã®å¤–éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒé »ç¹ã«ç™ºç”Ÿã—ã€APIã®å‡¦ç†æ™‚é–“ã®å¤§éƒ¨åˆ†ãŒI/O Waitã«ãªã‚‹ã“ã¨ãŒäºˆæƒ³ã•ã‚Œã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€è²»ç”¨ã‚’æŠ‘ãˆã¤ã¤ã€é«˜é€Ÿãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ãŸã‚ã«Cloudflare Workersã¯æœ€é©ãªé¸æŠè‚¢ã§ã—ãŸã€‚
:::

## æ¡ç”¨ã—ãŸæŠ€è¡“
3ãƒ¶æœˆçµŒã£ãŸç¾åœ¨ã€ãƒ“ã‚¸ãƒã‚¹çš„ãªéƒ½åˆã‚‚ã‚ã‚ŠCloudflareã§ã¯ãªã**Azureä¸Šã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹æˆ**ã—ã¦ã„ã¾ã™ã€‚
ã—ã‹ã—ã€ã‚¤ãƒ³ãƒ•ãƒ©é¢ä»¥å¤–ã®æ§‹æˆã¯å¤§ããå¤‰æ›´ã—ã¦ãŠã‚‰ãšã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ»ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã—ã¦é–‹ç™ºã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚

- **Bun(Runtime, Test Runner)**
- **Hono(Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯)**
- **Drizzle(ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼)**
- **MSAL(èªè¨¼ãƒ»èªå¯)**
- **Casbin(RBAC)**
- **Hygen(Code Generator)**
- **DevCycle(Feature Flag)**
- **Biome(Linter/Formatter)**

ã‚¤ãƒ³ãƒ•ãƒ©ã¯Azure Container Appsã¨PostgreSQLã‚’ä½¿ç”¨ã—ã€Terraformã§IaCåŒ–ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

- Azure Container Apps
- PostgreSQL
- Terraform

æœ¬è¨˜äº‹ã§ã¯è©³ã—ãã¯è§¦ã‚Œã¾ã›ã‚“ãŒã€Azureä¸Šã§ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã§ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚

https://zenn.dev/aishift/articles/881504222e1e85

IaCåŒ–ã‚„ã‚¤ãƒ³ãƒ•ãƒ©é¢ã§ã®èª²é¡Œã‚„å–ã‚Šçµ„ã¿ã«ã¤ã„ã¦ã¯åˆ¥é€”ã¾ã¨ã‚ã‚‹äºˆå®šã§ã™ã€‚

# æ¡ç”¨ã—ã¦ã¿ã¦è‰¯ã‹ã£ãŸã“ã¨ãƒ»å›°ã£ãŸã“ã¨

AI Workerã§ã¯TypeScriptã‚’ä¸­å¿ƒã¨ã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¡ç”¨ã—ã€é–‹ç™ºã‚’é€²ã‚ã¦ãã¾ã—ãŸã€‚
ãã‚Œãã‚Œã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ¡ç”¨ã—ã¦ã¿ã¦è‰¯ã‹ã£ãŸã“ã¨ã€å›°ã£ãŸã“ã¨ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

Bunã€Honoã«é–¢ã—ã¦ã¯LTã‚’ã—ãŸéš›ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚‚å…¬é–‹ã—ã¦ã„ã¾ã™ã®ã§ã€èˆˆå‘³ãŒã‚ã‚‹æ–¹ã¯ã“ã¡ã‚‰ã‚‚ã”è¦§ãã ã•ã„ã€‚
https://speakerdeck.com/sugarcat7/xin-gui-sabisuno-batukuendokai-fa-debunxhonowoshi-ishi-mete-2keyue-jing-tutahua


## Bun(Runtime, Test Runner)

Bunã¯JavaScript Runtime, Bundler, Test Runner...ç­‰ã‚’åŒåŒ…ã—ãŸAll-in-Oneã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

https://bun.sh/

AI Workerã§ã¯ã€ä¸»ã«Runtimeã€TestRunnerã€Package Managerã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

### è‰¯ã‹ã£ãŸã“ã¨

#### Workspaceã®ä½¿ã„å¿ƒåœ°/ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®é–‹ç™ºä½“é¨“ãŒè‰¯ã„

AI Workerã§ã¯ã€ãƒ¢ãƒãƒ¬ãƒä¸Šã§Projectã‚’æ§‹æˆã—ã¦ãŠã‚Šã€Bunã®Workspaceæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ä¸€ã¤ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

![Alt text](/images/aiworker/workspace.png =300x)

å¤§ä½“ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè‚¥å¤§åŒ–ã—ã¦ãã‚‹ã¨ã€ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã§ç®¡ç†ã—ã¦ã„ã‚‹ã¨1å›ã®packageã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚„ãƒ“ãƒ«ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ãã‚‹ã‚‚ã®ã§ã™ãŒã€ä»Šã®ã¨ã“ã‚installã‚‚10ç§’å‰å¾Œ(npmã®å ´åˆ2åˆ†)ã§æ¸ˆã‚“ã§ãŠã‚Šã€éå¸¸ã«é–‹ç™ºä½“é¨“ãŒè‰¯ã„ã§ã™ã€‚

![Alt text](/images/aiworker/pk.png =400x)


#### Bun Shellç­‰ã®çµ„ã¿è¾¼ã¿æ©Ÿèƒ½ã‚„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè±Šå¯Œ

`v1.0.24`ã§è¿½åŠ ã•ã‚ŒãŸ`Bun Shell`ã«ã‚ˆã£ã¦ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§å‹•ãã‚·ã‚§ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç°¡å˜ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚
AI Workerã§ã¯CI/CDã§ä½¿ç”¨ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’TypeScriptã¨[zx](https://github.com/google/zx)ã‚’ä½¿ç”¨ã—ã¦ç®¡ç†ã—ã¦ã„ã¾ã—ãŸãŒã€Bunãƒã‚¤ãƒ†ã‚£ãƒ–ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ç½®ãæ›ãˆã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

https://bun.sh/blog/bun-v1.0.24

ã¾ãŸã€Containerã§Bunã‚’ä½¿ç”¨ã™ã‚‹éš›ã®Dockerfileã®æ§‹æˆã‚‚å…¬å¼ãŒæä¾›ã—ã¦ã„ã‚‹ãŸã‚ã€ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚‚ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

https://bun.sh/guides/ecosystem/docker

### å›°ã£ãŸã“ã¨

#### Lifecycle scriptsãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹

Bun v1.0.16ã¾ã§ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¨ã¦ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®Lifecycle scriptsãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã—ãŸ(protobufjsãªã©ã®postinstallã§ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ)

ãã®ãŸã‚ã€ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆã«å¯¾ã—ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ‰‹æ›¸ãã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

![Alt text](/images/aiworker/lifecycle.png)

`v1.0.17`ã§Top500ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆåŒ–ã•ã‚Œã‚‹ä¿®æ­£ãŒå…¥ã£ãŸãŸã‚ã€ä»Šã®ã¨ã“ã‚å¤§ããªå•é¡Œã«ã¯ãªã‚‰ãšã«ä½¿ãˆã¦ã„ã¾ã™ã€‚

https://bun.sh/blog/bun-v1.0.17#bun-install-now-runs-lifecycle-scripts-for-the-top-500-npm-packages


#### lockbãƒ•ã‚¡ã‚¤ãƒ«ã®æ‰±ã„

`bun install`ã‚’è¡Œã†ã¨`bun.lockb`ã¨ã„ã†ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
ãƒã‚¤ãƒŠãƒªã®ã¾ã¾ã ã¨lockfileã®å·®åˆ†ç¢ºèªãŒé›£ã—ã„ã§ã™ã€‚

:::message
å…¬å¼ã§ã¯yarn.lockã‚‚åãå‡ºã™è¨­å®šã‚’ã—ã¦diffã‚’å–ã‚‹ã®ã‚’æ¨å¥¨ã—ã¦ã„ã‚‹ãã†ã§ã™
:::

https://bun.sh/docs/install/lockfile


ä¸­èº«ã‚’è¦‹ã‚‹ã¨ã„ã†è¦³ç‚¹ã ã‘ã§è¨€ãˆã°ã€æœ‰å¿—ã§é–‹ç™ºã•ã‚Œã¦ã„ã‚‹extentionãŒã‚ã‚‹ã®ã§ã€ã“ã‚Œã‚’ä½¿ã†ã¨ç›´æ¥lockbãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚(diffã¯ç¢ºèªã§ãã¾ã›ã‚“)

https://marketplace.visualstudio.com/items?itemName=jaaxxx.bun-lockb


## Hono(Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯)

æœ€è¿‘è©±é¡Œã®Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚
Expressã®å¾Œç¶™ã¨è¨€ã‚ã‚Œã¦ãŠã‚Šã€Webæ¨™æº–ã«å¾“ã£ãŸå®Ÿè£…ã¨è»½é‡ã§é«˜é€ŸãŒå£²ã‚Šã®All-in-Oneã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

https://hono.dev/

AI Workerã§ã¯ã€Honoã¨ThirdPartyã®`@hono/zod-openapi`ã‚’ä½¿ç”¨ã—ã€OpenAPIã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ãŸã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚


### è‰¯ã‹ã£ãŸã“ã¨


#### ã‚¹ã‚­ãƒ¼ãƒé§†å‹•ã§ã®é–‹ç™ºãŒã—ã‚„ã™ã„

`@hono/zod-openapi`ã‚’ä½¿ç”¨ã™ã‚‹ã¨zodã®ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰APIã®Routerã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

:::details ã‚³ãƒ¼ãƒ‰ä¾‹

```typescript
// zod
import { z } from '@hono/zod-openapi'
import { createRoute } from '@hono/zod-openapi'
import { OpenAPIHono } from '@hono/zod-openapi'

const ParamsSchema = z.object({
  id: z
    .string()
    .min(3)
    .openapi({
      param: {
        name: 'id',
        in: 'path',
      },
      example: '1212121',
    }),
})

const UserSchema = z
  .object({
    id: z.string().openapi({
      example: '123',
    }),
    name: z.string().openapi({
      example: 'John Doe',
    }),
    age: z.number().openapi({
      example: 42,
    }),
  })
  .openapi('User')

const route = createRoute({
  method: 'get',
  path: '/users/{id}',
  request: {
    params: ParamsSchema,
  },
  responses: {
    200: {
      content: {
        'application/json': {
          schema: UserSchema,
        },
      },
      description: 'Retrieve the user',
    },
  },
})

// entry point
const app = new OpenAPIHono()

app.openapi(route, (c) => {
  const { id } = c.req.valid('param')
  return c.json({
    id,
    age: 20,
    name: 'Ultra-man',
  })
})

// The OpenAPI documentation will be available at /doc
app.doc('/doc', {
  openapi: '3.0.0',
  info: {
    version: '1.0.0',
    title: 'My API',
  },
})
```

:::

https://hono.dev/snippets/zod-openapi

ã•ã‚‰ã«`@hono/swagger-ui`ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨ã€SwaggerUIã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```typescript
app.get('/ui', swaggerUI({ url: '/doc' }))
```
https://hono.dev/snippets/swagger-ui

:::message
â€»OpenAPIã®ä»•æ§˜æ›¸è‡ªä½“ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹æ©Ÿèƒ½ã¯ãªã„ãŸã‚ã€yamlç­‰ã®å½¢å¼ã§OpenAPIã®ä»•æ§˜æ›¸ã®å½¢å¼ãŒæ¬²ã—ã„å ´åˆã¯åˆ¥é€”å‡ºåŠ›ãŒå¿…è¦ã§ã™ã€‚
:::

AI Workerã§ã¯ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã€å„routerå†…ã§ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã€æœ€çµ‚çš„ã«Entry Pointã«é›†ç´„ã•ã›ã¦APIã®å®Ÿè£…ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
```bash
./service/api/routes
â”œâ”€â”€ index.ts
â”œâ”€â”€ message.ts
â”œâ”€â”€ rag.ts
â”œâ”€â”€ team.ts
â”œâ”€â”€ tenant.ts
â”œâ”€â”€ thread.ts
â”œâ”€â”€ user.ts
â””â”€â”€ workspace.ts
...
```

- handlerã‚’å„routeã‹ã‚‰å‘¼ã³å‡ºã™

```typescript:routes/thread.ts
const threadApi = new OpenAPIHono()

const threadInjector = new ThreadInjector()

threadApi.openapi(listThreadsRoute, (c) => threadInjector.threadHandler.list(c))
threadApi.openapi(getThreadRoute, (c) => threadInjector.threadHandler.get(c))
threadApi.openapi(updateThreadRoute, (c) => threadInjector.threadHandler.update(c))
threadApi.openapi(deleteThreadRoute, (c) => threadInjector.threadHandler.delete(c))

export { threadApi }
```

- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œã†ã€‚
```typescript:cmd/index.ts
const app = new OpenAPIHono()

app.use('*', logger(), cors(), jwt(), acl())

app.route('/users', userApi)
app.route('/threads', threadApi)
app.route('/messages', messageApi)

// ....
```



#### ä¾¿åˆ©ãªHelper/MiddlewareãŒå¤šã„

Honoã«ã¯ä¾¿åˆ©ãªHelper/MiddlewareãŒå¤šãç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€Streamã‚’æ‰±ã†ã®ã«ç‰¹åŒ–ã—ãŸHelperã‚„Corsã‚„JWTã‚’æ‰±ã„ã‚„ã™ãã—ã¦ãã‚Œã¦ã„ã‚‹MiddlewareãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ã€‚

```typescript:example.ts
import { Hono } from 'hono'
import { poweredBy } from 'hono/powered-by'
import { logger } from 'hono/logger'
import { basicAuth } from 'hono/basic-auth'

const app = new Hono()

app.use('*', poweredBy())
app.use('*', logger())

app.use(
  '/auth/*',
  basicAuth({
    username: 'hono',
    password: 'acoolproject',
  })
)
```

ã¾ãŸã€ThirdPartyã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚‚è±Šå¯Œã§ã€å‰è¿°ã®openapié–¢é€£ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãªã©ã‚‚å……å®Ÿã—ã¦ã„ã¾ã™ã€‚
https://hono.dev/middleware/third-party


AI Workerã§ã¯Streamã‚’å¤šãæ‰±ã†ãŸã‚ã€Honoã®Streamé–¢é€£ã®æ©Ÿèƒ½ã‚’ã‚ˆãä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

ä¾‹ãˆã°Honoã«ã¯SSEã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹`streamSSE`ã¨ã„ã†é–¢æ•°ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã«å¯¾ã—ã¦æƒ…å ±ã‚’ä»˜åŠ ã—ãŸã‚Šã€åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®streamã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«SSEã¨ã—ã¦ãã®ã¾ã¾æµã™å‡¦ç†ãŒç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚


```typescript:example.ts
for await (const chunk of sseStream.data) {
    const chunkStr = chunk.toString()
    const jsonObjects = chunkStr.split('data: ').filter((str: string) => str.trim())

    for (let jsonObj of jsonObjects) {
        jsonObj = jsonObj.trim().replace(/\n/g, '\\n')
        const c: ChunkContent = JSON.parse(jsonObj)
        if (!c) {
            throw new Error('No chunk')
        }
        c.hoge = hoge // <- streamã«æƒ…å ±ã‚’ä»˜åŠ 
        stream.writeSSE({ data: JSON.stringify(c) })
    }
}
```

https://hono.dev/helpers/streaming




#### ContextãŒä½¿ã„ã‚„ã™ã„

Honoã§ã¯Request/Responseã‚’Contextã‚’ä½¿ã£ã¦ã‚„ã‚Šã¨ã‚Šã—ã¾ã™ã€‚

https://hono.dev/api/context

Goè¨€èªã®Contextã¨åŒã˜ã‚ˆã†ãªä½¿ã„æ–¹ãŒã§ãã€Middlewareã§ã‚»ãƒƒãƒˆã—ãŸå€¤ã‚’ä»–ã®Middlewareã‚„Handlerã§å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

AI Workerã§ã¯ã€JWTã‹ã‚‰å¾—ãŸãƒ†ãƒŠãƒ³ãƒˆIDç­‰ã®æƒ…å ±ã‚’Contextã«ã‚»ãƒƒãƒˆã—ã¦ã€ãã‚Œã‚’ä½¿ã£ã¦ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

ä¸‹è¨˜ã¯Handlerã®ä¸€éƒ¨å®Ÿè£…ã§ã€`tenantId: c.get('tenantId')`ã®ã‚ˆã†ã«Contextã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

```typescript:infra/http/server/thread.ts
export class ThreadHandler implements IThreadHandler {
  private threadUsecase: ThreadInteractor
  constructor(threadUsecase: ThreadInteractor) {
    this.threadUsecase = threadUsecase
  }

  async get(c: Context): Promise<TypedResponse<ThreadResponse | ErrorResponse>> {
    // ....
    const input: GetThread = {
      tenantId: c.get('tenantId'), // Contextã‹ã‚‰å€¤ã‚’å–å¾—
    }

    const result = await this.threadUsecase.get(input)

    if (!result.isSuccess) {
      const errorResponse: ErrorResponse = {
        message: result.getError().message,
      }
      return c.json(errorResponse, result.getError().code)
    }
    return c.json(ThreadResponseSchema.parse(result.getValue()), 200)
  }
  // ...
}
```

ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã®å®Ÿè£…ã‚’è¡Œã£ã¦ã„ã‚‹å ´åˆã¯ã€Contextã‚’ä¼æ¬ã•ã›ã‚‹ã“ã¨ã§ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã§ã®å€¤ã®å—ã‘æ¸¡ã—ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€å®Ÿè£…ãŒã—ã‚„ã™ã„ã§ã™ã€‚


### å›°ã£ãŸã“ã¨

#### JWTæ¤œè¨¼ã®AlgorismãŒHMACã®ã¿

Honoã®Helperã‚’ä½¿ç”¨ã—ã¦JWTã®æ¤œè¨¼ã‚’è¡ŒãŠã†ã¨æ€ã£ãŸæ™‚ã«ã€RSAã®æ¤œè¨¼ãŒè¡Œãˆã¾ã›ã‚“ã§ã—ãŸã€‚

https://hono.dev/helpers/jwt

AI Workerã§ã¯èªè¨¼èªå¯ã«EntraIDã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€APIã®åˆ©ç”¨æ™‚ã«ã¯Entraã®å…¬é–‹éµã§JWTã®æ¤œè¨¼ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
ãã®ãŸã‚ã€PublicKeyã‚’ä½¿ç”¨ã—ãŸVerifyã«é–¢ã—ã¦ã¯Auth0ç­‰ã§åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒª([jsonwebtoken](https://github.com/auth0/node-jsonwebtoken)/[jwks-rsa](https://github.com/auth0/node-jwks-rsa))ã‚’å…¥ã‚Œã¦ã€JWTã®æ¤œè¨¼ã‚’è¡Œã†ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```typescript:verify.ts
import { AppError, StatusCode } from '@/core/error'
import { Result, toAsyncResult } from '@/core/result'
import { decode } from 'hono/jwt'
import { JwtPayload, verify } from 'jsonwebtoken'
import { JwksClient } from 'jwks-rsa'

/**
 *
 * Access token verification content includes:
 *  - Issuer verification: This is done by checking the issuer URL which should be https://login.microsoftonline.com/{tenantid}/v2.0
 *  - Tenant ID verification: The 'tid' from the access token payload is set to the tenantID part. We then confirm the exact match with the value embedded later and the 'iss' of the payload.
 *  - Signature verification: The signature key is obtained from https://login.microsoftonline.com/${tenantId}/discovery/v2.0/keys. We then get and verify the target public key from the 'kid' of the JWT header.
 */
const validateJwtToken = async (token: string): Promise<Result<string | JwtPayload>> => {
  const { header, payload } = decode(token)
  const issuerUrl = `https://login.microsoftonline.com/${payload.tid}/v2.0`
  if (issuerUrl !== payload.iss) {
    return Result.fail(new AppError(StatusCode.UNAUTHORIZED, 'Invalid issuer'))
  }
  const jwksUri = `https://login.microsoftonline.com/${payload.tid}/discovery/v2.0/keys`
  const jwksClient = new JwksClient({ jwksUri })

  const keys = (await jwksClient.getKeys()) as any[]
  const target = keys.find((k) => k.kid === header.kid)
  if (!target) {
    return Result.fail(new AppError(StatusCode.UNAUTHORIZED, 'Invalid signature'))
  }
  const pk = `-----BEGIN CERTIFICATE-----\n${target.x5c.at(0)}\n-----END CERTIFICATE-----`

  return Result.ok(await verify(token, pk, { algorithms: ['RS256'] }))
}
```

## Drizzle

`Drizzle ORM`/`Drizzle Kit`/`Drizzle Studio`ã«åˆ†ã‹ã‚Œã€ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æ©Ÿæ§‹ãªã©ãŒåŒåŒ…ã•ã‚ŒãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªç¾¤ã§ã™ã€‚

https://orm.drizzle.team/docs/overview



ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã«é–¢ã—ã¦ã¯SQLãƒ©ã‚¤ã‚¯ã«ã‹ã‘ã‚‹ã“ã¨ã‚„ã€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚TypeScriptã§æ›¸ãã“ã¨ãŒã§ãã‚‹ã®ãŒæ°—ã«å…¥ã‚Šä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚


### è‰¯ã‹ã£ãŸã“ã¨

#### ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ãŒTypeScriptã§æ›¸ã‘ã‚‹

Drizzleã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’TypeScriptã§æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚
MySQL, PostgreSQL, SQLiteãã‚Œãã‚Œã«å¯¾å¿œã—ã¦ãŠã‚Šã€ãã‚Œãã‚Œã®DBMSã®ã‚«ãƒ©ãƒ ã«å¯¾å¿œã—ãŸå‹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

AI Workerã§ã¯PostgreSQLã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ãŸã‚ã€PostgreSQLã«å¯¾å¿œã—ãŸå‹ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

```typescript
import { InferInsertModel, InferSelectModel, sql } from 'drizzle-orm'
import { pgTable, text, uuid } from 'drizzle-orm/pg-core'

export const UserTable = pgTable('user', {
  id: uuid('id').primaryKey(),
  name: text('name').notNull(),
  email: text('email').notNull().unique(),
})

export type User = InferSelectModel<typeof UserTable>
export type InsertUser = InferInsertModel<typeof UserTable>
```

ã¾ãŸ`drizzle-kit`ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€DDLã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¸‹è¨˜ã¯è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸDDLã®ä¸€éƒ¨ã§ã€Postgreså›ºæœ‰ã®uuidå‹ã‚’ä½¿ç”¨ã—ãŸDDLãŒç”Ÿæˆã•ã‚Œã‚‹ãªã©ã€å„DBMSã«ä¾å­˜ã—ãŸDDLã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```sql
CREATE TABLE IF NOT EXISTS "user" (
	"id" uuid PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"email" text NOT NULL,
	CONSTRAINT "user_email_unique" UNIQUE("email")
);
```

https://orm.drizzle.team/kit-docs/overview#migration-files


ã•ã‚‰ã«ã€ç”Ÿæˆã•ã‚ŒãŸDDLã‹ã‚‰ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã“ã¨ã‚‚ã§ãã¾ã™ã€‚

```typescript
import { drizzle } from "drizzle-orm/postgres-js";
import { migrate } from "drizzle-orm/postgres-js/migrator";
import postgres from "postgres";
const sql = postgres("...", { max: 1 })
const db = drizzle(sql);
await migrate(db, { migrationsFolder: "drizzle" });
await sql.end();
```
https://orm.drizzle.team/kit-docs/overview#running-migrations

ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’DrizzleçµŒç”±ã§è¡Œã†ã¨ã€DrizzleDBãŒè‡ªå‹•ã§ä½œæˆã•ã‚Œã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å±¥æ­´ãŒä¿å­˜ã•ã‚Œã¾ã™ã€‚

```sql
CREATE TABLE drizzle."__drizzle_migrations" (
	id serial4 NOT NULL,
	hash text NOT NULL,
	created_at int8 NULL,
	CONSTRAINT "__drizzle_migrations_pkey" PRIMARY KEY (id)
);
```

### å›°ã£ãŸã“ã¨

#### ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç†

åŸºæœ¬çš„ã«Drizzleã¯ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ãªã®ã§ã€ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã®ç®¡ç†ã¯è‡ªåˆ†ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

AI Workerã§ã¯ã€Azureã®Containerä¸Šã‹ã‚‰Managedã®Postgresã¨æ¥ç¶šã™ã‚‹ãŸã‚ã€`node-postgres`ã®`Pool`ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

https://node-postgres.com/apis/pool

ãƒ–ãƒªãƒƒã‚¸ãƒ¢ãƒ‡ãƒ«ã®è¨­è¨ˆä¸Šã€ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«DBã‚’åˆ†ã‘ç®¡ç†ã—ã¦ã„ã‚‹ã®ã§ã€å„ãƒ†ãƒŠãƒ³ãƒˆDBã®Poolã‚’è‰¯ã„æ„Ÿã˜ã«ä½¿ã„å›ã—ã¦ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

åŸºæœ¬çš„ã«ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã§DBClient Classã‚’æ‰±ã„ã€ãƒ†ãƒŠãƒ³ãƒˆDBã”ã¨ã«Poolã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆã—ä½¿ã„å›ã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
ã‚·ãƒ³ã‚°ãƒ«ãƒˆãƒ³ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã€[Mutex](https://github.com/DirtyHairy/async-mutex)ã‚’ä½¿ç”¨ã—ã¦æ’ä»–åˆ¶å¾¡ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

```typescript:infra/database/client.ts
export class DBContext {
  private _tx: NodePgDatabase
  constructor(tx: NodePgDatabase) {
    this._tx = tx
  }

  // Getter for the transaction
  get db() {
    return this._tx
  }
}

export class DBClient {
  private cache: Map<string, { db: NodePgDatabase; pool: Pool }> = new CacheStore()
  private mutex = new Mutex()
  // To handle as a singleton
  private static _instance: DBClient
  static get instance() {
    if (!DBClient._instance) {
      DBClient._instance = new DBClient()
    }
    return DBClient._instance
  }
  // ....
  // Sets the database client for a specific tenant ID
  async poolClient(tenantId: string): Promise<Result<{ db: NodePgDatabase; pool: Pool }>> {
    const release = await this.mutex.acquire()
    try {
      if (!this.cache.has(tenantId)) {
        const result = await this.initializeTenantPool(tenantId)
        if (!result.isSuccess) {
          return Result.fail(result.getError())
        }
      }
      const clientInfo = this.cache.get(tenantId)
      if (!clientInfo) {
        return Result.fail(
          new AppError(
            StatusCode.INTERNAL_SERVER_ERROR,
            `Client for tenant ${tenantId} is not initialized`
          )
        )
      }
      return Result.ok(clientInfo)
    } finally {
      release()
    }
  }
  //....
}
```

ä¸Šè¨˜ã®DBClientã‚’ä½¿ç”¨ã—ã¦ã€transactionã”ã¨ã«ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã—ã€å®Ÿè¡Œå¾Œã«ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹TransactionManagerã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

:::message
connectionã‚’å®šæœŸçš„ã«ãƒªãƒªãƒ¼ã‚¹ã—ãªã„ã¨ã€poolä½œæˆæ™‚ã«æŒ‡å®šã—ãŸæœ€å¤§æ¥ç¶šæ•°ã‚’è¶…ãˆã¦ã—ã¾ã„ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã—ã¾ã†ãŸã‚ã€ãƒªãƒªãƒ¼ã‚¹å‡¦ç†ã¯å¿…é ˆã§ã™ã€‚

https://node-postgres.com/features/pooling
:::

```typescript:infra/database/transaction.ts
import { Result } from '@/core/result'
import { ITransactionManager } from '@/internal/domain/repository/transaction'
import { DBClient, DBContext } from './client'

export class TransactionManager implements ITransactionManager {
  private client: DBClient

  constructor(client: DBClient) {
    this.client = client
  }

  async withTransaction<T>(
    tenantId: string,
    operation: (context: DBContext) => Promise<Result<T>>
  ): Promise<Result<T>> {
    const p = await this.client.poolClient(tenantId)
    if (!p.isSuccess) {
      return Result.fail(p.getError())
    }
    const poolClient = p.getValue()
    const conn = await poolClient.pool.connect()
    try {
      const db = await poolClient.db
      const res = await db.transaction(async (tx) => {
        const ctx = new DBContext(tx)
        const op = await operation(ctx)
        if (!op.isSuccess) {
          try {
            await tx.rollback()
          } catch (_e) {
            // ....
          }
          return Result.fail(op.getError())
        }
        return op
      })

      return res
    } finally {
      await conn.release()
    }
  }
}


```

ã“ã®TransactionManagerã‚’ä½¿ç”¨ã—ã€usecaseå±¤ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å¼µã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ãƒ†ãƒŠãƒ³ãƒˆDBã®åˆ‡ã‚Šæ›¿ãˆã¨ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ã®ç®¡ç†ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

```typescript:usecase/thread.ts
export class UserInteractor implements IUserInteractor {
  private transactionManager: ITransactionManager
  private userRepository: IUserRepository

  constructor(
    transactionManager: ITransactionManager,
    userRepository: IUserRepository,
  ) {
    this.transactionManager = transactionManager
    this.userRepository = userRepository
  }
  // ...
  async create(input: CreateUser): Promise<Result<User>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      const user = new User(input.userId, input.name, input.email, input.role)
      const repoResult = await this.userRepository.create(ctx, user)
      return repoResult
    })
  }
}
```

#### DMLã®ç”Ÿæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„

Drizzleã¯DDLã®ç”Ÿæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ãŒã€DMLã®è‡ªå‹•ç”Ÿæˆã¯ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥ãªã©ã€DDLåŒæ§˜ã€DMLã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã¯ã—ãŸã„ã¨ã“ã‚ã§ã™ã€‚

ä¸€ã¤ã®æ–¹æ³•ã¨ã—ã¦ã¯ã€`drizzle-kit generate:pg --custom`ã®ã‚ˆã†ã«`--custom`ãƒ•ãƒ©ã‚°ã‚’ã¤ã‘ã‚‹ã“ã¨ã§ã€ç©ºã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€æ‰‹å‹•ã§DMLã‚’æ›¸ãã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚

https://orm.drizzle.team/kit-docs/commands

```sql
-- Custom SQL migration file, put you code below! --

-- Insert default roles
--> statement-breakpoint
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

--> statement-breakpoint
INSERT INTO "role" ("id", "name", "permissions") VALUES
(uuid_generate_v4(), 'TenantAdmin', '...');
```


## Casbin(RBAC)

Casbinã¯ACLã‚„RBAC(Role Based Access Control)ã®ã‚ˆã†ãªã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ãƒ¢ãƒ‡ãƒ«ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹èªè¨¼ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

https://casbin.org/ja/

AI Workerã§ã¯ã€Casbinã‚’ä½¿ç”¨ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©é™ã«å¿œã˜ãŸã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡(RBAC)ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

Casbinã¯ãƒ¢ãƒ‡ãƒ«ã¨ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©ã—ã€å®šç¾©ã«åŸºã¥ã„ã¦ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
ãƒãƒªã‚·ãƒ¼ã«é–¢ã—ã¦ã¯ã€csvã‚„DBã«ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã€AI Workerã§ã¯å˜ç´”ãªéšå±¤æ§‹é€ (`TenantAdmin` -> `WorkspaceAdmin` -> `Member`)ã‚’å®šç¾©ã—ãŸãƒãƒªã‚·ãƒ¼ã‚’csvã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚



### è‰¯ã‹ã£ãŸã“ã¨

#### ãƒ¢ãƒ‡ãƒ«ã¨ãƒãƒªã‚·ãƒ¼ã®å®šç¾©ãŒã—ã‚„ã™ã„

ä¸€åº¦ãƒ¢ãƒ‡ãƒ«ã¨ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©ã—ã¦ã—ã¾ãˆã°ã€ãã‚Œã«åŸºã¥ã„ã¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã”ã¨ã§ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

:::message
`confãƒ•ã‚¡ã‚¤ãƒ«`ã«`sub: èª°ãŒ`, `obj: ä½•ã‚’`, `act: ã©ã†ã™ã‚‹ã‹`ã‚’å®šç¾©ã—ã€`policyãƒ•ã‚¡ã‚¤ãƒ«`ã«ã¯ãã‚Œã«å¯¾ã™ã‚‹`è¨±å¯ãƒ»æ‹’å¦`ã‚’å®šç¾©ã—ã¾ã™ã€‚
:::

```conf:model.conf
[request_definition]
r = sub, obj, act

[policy_definition]
p = sub, obj, act, eft

[role_definition]
g = _, _

[policy_effect]
e = subjectPriority(p.eft) || deny

[matchers]
m = g(r.sub, p.sub) && keyMatch5(r.obj, p.obj) && (r.act == p.act || p.act == "*")

```

ä¸‹è¨˜ã¯csvã§ã®ãƒãƒªã‚·ãƒ¼ã®å®šç¾©ä¾‹ã§ã™ã€‚
`TenantAdmin` -> `WorkspaceAdmin` -> `Member`ã®éšå±¤æ§‹é€ ã‚’æŒã¤ãƒãƒªã‚·ãƒ¼ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚


```csv:policy.csv
p, TenantAdmin, /*, *, allow

p, WorkspaceAdmin, /tenant_setting/workspaces, GET, allow
p, WorkspaceAdmin, /users , GET, allow

p, Member, /tenant_setting/workspaces, *, deny

g, Member, WorkspaceAdmin
```

`TenantAdmin`ã¯å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ãŒã€`WorkspaceAdmin`ã¯ `/tenant_setting/workspaces`ã¨`/users`ã«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€`Member`ã¯`g, Member, WorkspaceAdmin`ã§`WorkspaceAdmin`ã®æ¨©é™ã‚’ç¶™æ‰¿ã—ãªãŒã‚‰ã€`/tenant_setting/workspaces`ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚ˆã†ã«å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

ã“ã®ã‚ˆã†ã«ã€`model.conf`ã®`role_definition`ã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€éšå±¤æ§‹é€ ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’ç°¡å˜ã«å®Ÿç¾ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚


### å›°ã£ãŸã“ã¨

#### ãƒãƒªã‚·ãƒ¼ã®ç®¡ç†ãŒé¢å€’

ç¾çŠ¶ã¯csvã§ãƒãƒªã‚·ãƒ¼ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ãŒã€ãƒãƒªã‚·ãƒ¼ãŒå¢—ãˆã¦ããŸã‚Šã€PathValueã«å¿œã˜ã¦å‹•çš„ã«ãƒãƒªã‚·ãƒ¼ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã€csvå˜ä½“ã®ç®¡ç†ã¯é›£ã—ããªã£ã¦ãã¾ã™ã€‚

ä»£æ›¿æ¡ˆã¨ã—ã¦ã¯DBã«ãƒãƒªã‚·ãƒ¼ã‚’ä¿å­˜ã—ã€å‹•çš„ãªå€¤ã«å¯¾ã—ã¦ãƒãƒªã‚·ãƒ¼ã«ã‚‚å¯¾å¿œã§ãã‚‹ã‚ˆã†ã«ã§ãã¾ã™ã€‚
https://casbin.org/ja/docs/policy-storage/

ã—ã‹ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç­‰ã‚’ã†ã¾ãæ´»ç”¨ã—ãªã„ã¨APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãŸã³ã«DBã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒèµ°ã£ãŸã‚Šã€Casbinã«ä¾å­˜ã—ãŸDBã®ã‚¹ã‚­ãƒ¼ãƒã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€å˜ç´”ãªãƒãƒªã‚·ãƒ¼ã®ç®¡ç†ã«é–¢ã—ã¦ã¯csvã§ã®ç®¡ç†ãŒç¾çŠ¶ã§ã¯é©ã—ã¦ã„ã‚‹ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚



## DevCycle(Feature Flag)

DevCycleã¯Feature Flagã‚’æä¾›ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚

https://devcycle.com/

Feature Flagã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã€Œ**æ–°æ©Ÿèƒ½**ã€ã‚’ãƒ•ãƒ©ã‚°åŒ–ã—å‹•çš„ã«ç®¡ç†ã™ã‚‹ãŸã‚ã®ä»•çµ„ã¿ã§ã™ã€‚

```typescript
æ–°æ©Ÿèƒ½B = true

if (æ–°æ©Ÿèƒ½B == true)
  æ–°ã—ã„æ©Ÿèƒ½Bã‚’æä¾›()
else
  å¤ã„æ©Ÿèƒ½Aã‚’æä¾›()
```

DevCycleã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªç‰¹å¾´ãŒã‚ã‚Šã¾ã™ã€‚

>50msä»¥ä¸‹ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: é«˜é€Ÿãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ã€‚
SDKã®è±Šå¯Œã•: å°å…¥ãŒå®¹æ˜“ã€‚
æ–™é‡‘ä½“å‹: MAUèª²é‡‘ã§ã™ãŒã€ä¾¡æ ¼é¢ã§è‰¯å¿ƒçš„ãªæ–™é‡‘ã€‚
ä½¿ã„ã‚„ã™ã•: DXãƒ»UXãŒç›´æ„Ÿçš„ã€‚
ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°: SSEçµŒç”±
OpenFeatureå¯¾å¿œ: ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã‚’é˜²ã’ã‚‹ã€‚
IDEã®Extension: VSCodeã®Extensionã‚’ä½¿ã†ã¨ç®¡ç†ç”»é¢ã‚’é–‹ã‹ãªãã¦è‰¯ã„ã€‚é–‹ç™ºåŠ¹ç‡ãŒã•ã‚‰ã«å‘ä¸Šã€‚
Edge Flags: Edge DBæ©Ÿèƒ½ã®æä¾›ã€‚æ›´æ–°ã‚ã£ãŸãƒ‡ãƒ¼ã‚¿ä¸€éƒ¨ã®ã¿ã§ã€å…¨ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹å¿…è¦ãªã„ã€‚
Local Bucketing: Edgeã‚ˆã‚Šã‚‚æ›´ã«é«˜é€Ÿãªãƒ­ãƒ¼ã‚«ãƒ«å‡¦ç†ã€‚

è©³ã—ãã¯å¼Šãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼([@gunta85](https://twitter.com/gunta85))ã®è¨˜äº‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
https://zenn.dev/gunta/articles/79f77bdc285874



### è‰¯ã‹ã£ãŸã“ã¨

#### SDKã®æä¾›

DevCycleã¯SDKã‚’æä¾›ã—ã¦ãŠã‚Šã€ãã‚Œã‚‰ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§Feature Flagã®ç®¡ç†ã‚’ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚


AI Workerã§ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¸¡æ–¹ã§DevCycleã‚’æ´»ç”¨ã—ã¦ãŠã‚Šã€ãã‚Œãã‚Œã«å¯¾å¿œã—ãŸSDKãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€åŒä¸€ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ãŸã¾ã¾ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§Feature Flagã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¦ã„ã¾ã™ã€‚

https://docs.devcycle.com/sdk/client-side-sdks/javascript/
https://docs.devcycle.com/sdk/server-side-sdks/node/


#### é–‹ç™ºåŠ¹ç‡ãŒå‘ä¸Š

ç¾åœ¨AI Workerã¯ãƒªãƒªãƒ¼ã‚¹å‰ã®æ®µéšã§ã™ãŒã€èªè¨¼ã‚„æ¨©é™ã¾ã‚ã‚Šã®ã‚¹ã‚¿ãƒ–ã¨æœ¬å®Ÿè£…ã®åˆ‡ã‚Šæ›¿ãˆç­‰ã€æ®µéšçš„ã«å‹•ä½œç¢ºèªã—ã¦è¡ŒããŸã„å ´åˆã«DevCycleã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ç’°å¢ƒã‚’å£Šã•ãšæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã„ãã“ã¨ãŒã§ãã¦ã„ã¾ã™ã€‚

```typescript
export const jwt = (): MiddlewareHandler => {
  return async (c, next) => {

    // devcycleã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦,JWTã®æ¤œè¨¼ã®æœ‰ç„¡ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    const jwtVerifyEnabled = devcycleClient.variableValue(devcycleUser(), 'jwt-verify', false)

    if (!jwtVerifyEnabled) {
      await next()
    }

    const token = c.req.header('Authorization')
    if (!token?.startsWith(BEARER_PREFIX)) {
      return c.json({ error: 'Token not found or invalid format' }, 401)
    }

    // ...
  }
}
```

### å›°ã£ãŸã“ã¨

#### Feature Flagã®ç®¡ç†ã®ãƒ«ãƒ¼ãƒ«

DevCycleã«é™ã£ãŸå•é¡Œã§ã¯ãªã„ã§ã™ãŒã€ãƒ¡ãƒ³ãƒãƒ¼é–“ã§ã®Flagã®on/offã«ã‚ˆã‚‹å½±éŸ¿ã®å…±é€šèªè­˜ã‚„ã€å¤ã„Flagã®å‰Šé™¤ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãªã©ã€ã‚ã‚‹ç¨‹åº¦ãƒãƒ¼ãƒ å†…ã§Feature Flagã®ç®¡ç†ãƒ«ãƒ¼ãƒ«ã‚’å®šã‚ã¦ãŠã‹ãªã„ã¨Feature Flagã®ç®¡ç†ãŒé›£ã—ããªã‚Šã¾ã™ã€‚

ãã®ãŸã‚ã€AI Workerã§ã¯Feature Flagã¨ãƒ–ãƒ©ãƒ³ãƒç®¡ç†ã®ãƒ«ãƒ¼ãƒ«ç­–å®šç­‰ã€Feature Flagã‚’æ´»ç”¨ã—ãŸé–‹ç™ºç”Ÿç”£æ€§å‘ä¸Šã®ãŸã‚ã®å–ã‚Šçµ„ã¿ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

![Alt text](/images/aiworker/slack.png)

https://site.developerproductivity.dev/2023-state-of-devops-report/


## Biome(Linter/Formatter)

Biomeã¯Rustè£½ã®Linter/Formatterã‚’æä¾›ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

https://biomejs.dev/ja/

ãƒ¢ãƒãƒ¬ãƒã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®TSç’°å¢ƒã«å¯¾ã—ã¦è¨­å®šå†…å®¹ã‚’ä¸€å…ƒç®¡ç†ãŒã§ãã€ã‹ã¤ã€é«˜é€ŸãªLinter/Formatterã‚’æä¾›ã—ã¦ãã‚Œã‚‹ãŸã‚ã€AI Workerã§ã¯Biomeã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚


### è‰¯ã‹ã£ãŸã“ã¨

#### è¨­å®šãŒç°¡å˜

ç‰¹ã«linterã§ã™ãŒã€`eslint`ã®ã‚ˆã†ã«å¿…è¦ãªãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’å…¥ã‚Œã¦è¨­å®šã‚’æ›¸ãå¿…è¦ãŒãªãã€`"all": true`ã‚’è¨­å®šã—ã¦å…¨ã¦ã®ãƒ«ãƒ¼ãƒ«ã®é©ç”¨ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚

VSCodeç­‰ã®extentionsã‚‚ç”¨æ„ã•ã‚Œã¦ãŠã‚Šã€biomeã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ã“ã¨ã§ã€ã‚¨ãƒ‡ã‚£ã‚¿ä¸Šã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãªformattingãŒå¯èƒ½ã§ã™ã€‚

https://biomejs.dev/ja/reference/vscode/

## Hygen(code generator)

Hygenã¯ã‚³ãƒ¼ãƒ‰ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã™ã€‚
`ejs`ã‚’ä½¿ã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’è‡ªä½œã—ã€å¯¾è©±å½¢å¼ã§ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://www.hygen.io/

AI Workerã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ãƒ™ãƒ¼ã‚¹ã¨ã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¨ãªã£ã¦ãŠã‚Šã€`internal`é…ä¸‹ã®å®šå‹çš„ãªã‚³ãƒ¼ãƒ‰ã¯å…¨ã¦è‡ªå‹•ç”Ÿæˆã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚


```
.
â”œâ”€â”€ cmd
â”‚   â””â”€â”€ server
â”‚       â””â”€â”€ index.ts
â”œâ”€â”€ internal
â”‚   â”œâ”€â”€ domain
â”‚   â”‚   â”œâ”€â”€ model
â”‚   â”‚   â”‚   â””â”€â”€ thread.ts
â”‚   â”‚   â”œâ”€â”€ repository
â”‚   â”‚   â”‚   â””â”€â”€ thread.ts
â”‚   â”œâ”€â”€ infra
â”‚   â”‚   â”œâ”€â”€ database
â”‚   â”‚   â”‚   â”œâ”€â”€ repository
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ thread.ts
â”‚   â”‚   â”œâ”€â”€ http
â”‚   â”‚       â”œâ”€â”€ injector
â”‚   â”‚       â”‚   â””â”€â”€ thread.ts
â”‚   â”‚       â””â”€â”€ server
â”‚   â”‚           â””â”€â”€ thread.ts
â”‚   â””â”€â”€ usecase
â”‚       â”œâ”€â”€ config.ts
â”‚       â”œâ”€â”€ input
â”‚       â”‚   â””â”€â”€ thread.ts
â”‚       â”œâ”€â”€ output
â”‚       â”‚   â””â”€â”€ thread.ts
â”‚       â””â”€â”€ thread.ts
â”œâ”€â”€ routes
â”‚   â”œâ”€â”€ thread.ts
â”‚   â””â”€â”€ ....

```



### è‰¯ã‹ã£ãŸã“ã¨

#### å¯¾è©±å½¢å¼ã®ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒã§ãã‚‹

Hygenã¯å¯¾è©±å½¢å¼ã§ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã¯ç¾çŠ¶è¤‡é›‘ãªè¨­å®šã‚’è¡Œã£ã¦ã¯ã„ã¾ã›ã‚“ãŒã€`prompt`ã«å¯¾ã—ã¦è³ªå•ã‚’ã‚ã‚‰ã‹ã˜ã‚å®šç¾©ã—ã¦ãŠãã“ã¨ã§ã€å…¥åŠ›å€¤ã‚’å…ƒã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã‚³ãƒ¼ãƒ‰ç”ŸæˆãŒã§ãã¾ã™ã€‚

```js:prompt.js
module.exports = {
  prompt: async ({ inquirer }) => {
    const questions = [
      {
        type: 'input',
        name: 'entity',
        message: 'What is the name of the entity?',
      },
    ]

    const entityAnswer = await inquirer.prompt(questions)

    return { ...entityAnswer }
  },
}
```
![Alt text](/images/aiworker/hygen.png =600x)

:::details ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰
interfaceã®å®šç¾©ã‚„ã€å„å±¤ã®å®Ÿè£…ã®ã‚¹ã‚¿ãƒ–ãŒç”Ÿæˆã§ãã¾ã™ã€‚
é–‹ç™ºè€…ã¯ç”Ÿæˆã•ã‚ŒãŸã‚¹ã‚¿ãƒ–ã‚’å…ƒã«å®Ÿè£…ã‚’é€²ã‚ã‚‹ã“ã¨ã§ã€å®Ÿè£…ã®ä¸€è²«æ€§ã‚’ä¿ã¤ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript:internal/domain/model/task.ts
export class Task {
  // FIXME: implement
  id: string;

  constructor({ id }: { id: string }) {
    this.id = id;
  }
}
```

```typescript:internal/domain/repository/task.ts
import { Result } from "@/core/result";
import { Pagination } from '@/internal/domain/model/pagination'
import { Task } from '@/internal/domain/model/task'
import { DBContext } from '@/internal/infra/database/client'
import { BaseListOptions } from './base'

export interface TasksWithPagination {
  tasks: Task[]
  pagination: Pagination
}

export class ListTaskQuery implements BaseListOptions {
  public limit: number
  public page: number
  public Preload?: boolean
  public ForUpdate?: boolean
  constructor({
    limit,
    page,
    Preload,
    ForUpdate,
  }: {
    limit: number
    page: number
    Preload?: boolean
    ForUpdate?: boolean
  }) {
    this.limit = limit
    this.page = page
    this.Preload = Preload
    this.ForUpdate = ForUpdate
  }
}

export class GetTaskQuery {
  public id: string
  public Preload?: boolean
  public ForUpdate?: boolean
  constructor({
    id,
    Preload,
    ForUpdate,
  }: {
    id: string
    Preload?: boolean
    ForUpdate?: boolean
  }) {
    this.id = id
    this.Preload = Preload
    this.ForUpdate = ForUpdate
  }
}

export interface ITaskRepository {
  create(ctx: DBContext, task: Task): Promise<Result<Task>>;
  getById(ctx: DBContext, query: GetTaskQuery): Promise<Result<Task>>;
  update(ctx: DBContext, task: Task): Promise<Result<Task>>;
  delete(ctx: DBContext, id: string): Promise<Result<Task>>;
  getAll(ctx: DBContext, query: ListTaskQuery): Promise<Result<TasksWithPagination>>;
}

```

```typescript:internal/infra/database/repository/task.ts
import { AppError, StatusCode } from '@/core/error'
import { Result } from '@/core/result'
import { Task } from '@/internal/domain/model/task'
import {
  ITaskRepository,
  ListTaskQuery,
  GetTaskQuery,
  TasksWithPagination
} from '@/internal/domain/repository/task'
import { DBContext } from '@/internal/infra/database/client'
import { InsertTask, TaskTable } from '@/schema/db/tenant.schema'
import { count, eq } from 'drizzle-orm'

export class TaskRepository implements ITaskRepository {
  async create(ctx: DBContext, task: Task): Promise<Result<Task>> {
    const { db } = ctx
    const dbTask: InsertTask = { ...task };
    const result = await db.insert(TaskTable).values(dbTask).returning().execute();
    const res = result.at(0)
    if (!res) {
      return Result.fail(new AppError(StatusCode.INTERNAL_SERVER_ERROR, 'Failed to create Team'))
    }
    return Result.ok(new Task({ id: res.id, /* other properties */ }))
  }

  async getById(ctx: DBContext, getQuery: GetTaskQuery): Promise<Result<Task>> {
    const { db } = ctx
    const result = await db.select().from(TaskTable).where(eq(TaskTable.id, getQuery.id)).execute()
    const res = result.at(0)
    if (!res) {
      return Result.fail(new AppError(StatusCode.INTERNAL_SERVER_ERROR, 'Failed to create Team'))
    }

    return Result.ok(new Task({ id: res.id, /* other properties */ }))
  }

  async update(ctx: DBContext, task: Task): Promise<Result<Task>> {
    const { db } = ctx
    const result = await db.update(TaskTable).set({ ...task }).where(eq(TaskTable.id, task.id)).returning().execute();
    const res = result.at(0)
    if (!res) {
      return Result.fail(new AppError(StatusCode.INTERNAL_SERVER_ERROR, 'Failed to update Team'))
    }
    return Result.ok(new Task({ id: res.id, /* other properties */ }))
  }

  async delete(ctx: DBContext, id: string): Promise<Result<Task>> {
    const { db } = ctx
    const result = await db.delete(TaskTable).where(eq(TaskTable.id, id)).returning().execute();
    const res = result.at(0)
    if (!res) {
      return Result.fail(new AppError(StatusCode.INTERNAL_SERVER_ERROR, 'Failed to update Team'))
    }
    return Result.ok(new Task({ id: res.id, /* other properties */ }))
  }

  async getAll(ctx: DBContext, listQuery: ListTaskQuery): Promise<Result<TasksWithPagination>> {
    const { db } = ctx
    const query = db.select().from(TaskTable)
    if (listQuery.limit && listQuery.page > 0) {
      query.limit(listQuery.limit)
      query.offset(listQuery.limit * (listQuery.page - 1))
    }
    const result = await query.execute();
    const total = await db.select({ value: count() }).from(TaskTable).execute();
    const totalVal = total.at(0)?.value || 0;
    const ar = result.map((t) => new Task({ id: t.id, /* other properties */ }));
    return Result.ok({
      tasks: ar,
      pagination: {
        currentPage: listQuery.page,
        prevPage: listQuery.page - 1,
        nextPage: listQuery.page + 1,
        totalPage: Math.ceil(totalVal / listQuery.limit),
        totalCount: totalVal,
        hasNext: listQuery.page < Math.ceil(totalVal / listQuery.limit),
      },
    });
  }
}
```
```typescript:internal/infra/http/injector/task.ts
import { DBClient } from '@/internal/infra/database/client';
import { TaskRepository } from '@/internal/infra/database/repository/task';
import { TransactionManager } from '@/internal/infra/database/transaction';
import { TaskInteractor } from '@/internal/usecase/task';
import { TaskHandler } from '@/internal/infra/http/server/task';

export class TaskInjector {
  private txManager: TransactionManager = new TransactionManager(DBClient.instance);
  private taskRepository = new TaskRepository();
  private taskUsecase = new TaskInteractor(this.txManager, this.taskRepository);

  get handler(): TaskHandler {
    return new TaskHandler(this.taskUsecase);
  }
}

```
```typescript:internal/infra/http/server/task.ts
import {
  CreateTask,
  DeleteTask,
  GetTask,
  UpdateTask,
  ListTasks,
} from '@/internal/usecase/input/task'
import { Context, TypedResponse } from 'hono'
import { ErrorResponse } from '@/schema/shared'
import {
  TaskRequestSchema,
  TaskResponseSchema,
  TaskResponse,
  TasksResponse
} from '@/schema/shared';
import {
  TaskInteractor,
} from '@/internal/usecase/task';

export type ITaskHandler = {
  create: (c: Context) => Promise<TypedResponse<TaskResponse | ErrorResponse>>,
  get: (c: Context) => Promise<TypedResponse<TaskResponse | ErrorResponse>>,
  list: (c: Context) => Promise<TypedResponse<TasksResponse | ErrorResponse>>,
  update: (c: Context) => Promise<TypedResponse<TaskResponse | ErrorResponse>>,
  delete: (c: Context) => Promise<TypedResponse<{ message: string } | ErrorResponse>>
}

export class TaskHandler implements ITaskHandler {
  private taskUsecase: TaskInteractor;

  constructor(taskUsecase: TaskInteractor) {
    this.taskUsecase = taskUsecase;
  }

  async create(c: Context): Promise<TypedResponse<TaskResponse | ErrorResponse>> {
    // Request parsing and validation
    const validationResult = TaskRequestSchema.safeParse(c.req.json());
    if (!validationResult.success) {
      const errorResponse: ErrorResponse = {
        message: JSON.stringify(validationResult.error.flatten()),
      }
      return c.json(errorResponse, 400)
    }

    // Create input for usecase
    const input: CreateTask = {
      tenantId: c.get('tenantId'),
    }
    const result = await this.taskUsecase.create(input);

    if (!result.isSuccess) {
      const errorResponse: ErrorResponse = { message: result.getError().message }
      return c.json(errorResponse, result.getError().code);
    }

    return c.json(TaskResponseSchema.parse(result.getValue()), 200);
  }

  async get(c: Context): Promise<TypedResponse<TaskResponse | ErrorResponse>> {
    // FIXME: Request parsing and validation
    const validationParamResult = TaskRequestParamSchema.safeParse(c.req.param())
    if (!validationParamResult.success) {
      const errorResponse: ErrorResponse = {
        message: JSON.stringify(validationParamResult.error.flatten()),
      }
      return c.json(errorResponse, 400)
    }

    // Create input for usecase
    const input: GetTask = {
      tenantId: c.get('tenantId'),
    };
    const result = await this.taskUsecase.get(input);

    if (!result.isSuccess) {
      const errorResponse: ErrorResponse = { message: result.getError().message }
      return c.json(errorResponse, result.getError().code);
    }

    return c.json(TaskResponseSchema.parse(result.getValue()), 200);
  }

  async list(c: Context): Promise<TypedResponse<TasksResponse | ErrorResponse>> {
    const validationParamResult = PaginationQuerySchema.safeParse(c.req.query())
    if (!validationParamResult.success) {
      const errorResponse: ErrorResponse = {
        message: JSON.stringify(validationParamResult.error.flatten()),
      }
      return c.json(errorResponse, 400)
    }
    const input: ListTasks = {
      tenantId: c.get('tenantId'),
      limit: validationParamResult.data.limit,
      page: validationParamResult.data.page,
    }
    const result = await this.taskUsecase.list(input);
    if (!result.isSuccess) {
      const errorResponse: ErrorResponse = {
        message: result.getError().message,
      }
      return c.json(errorResponse, result.getError().code)
    }

    const t = result.getValue()
    const tasksResponse: TasksResponse = {
      tasks: t.tasks.map((t) => TaskResponseSchema.parse(t)),
      pagination: {
        current_page: t.pagination.currentPage,
        total_page: t.pagination.totalPage,
        total_count: t.pagination.totalCount,
        has_next: t.pagination.hasNext,
        prev_page: t.pagination.prevPage,
        next_page: t.pagination.nextPage,
      },
    }
    return c.json(tasksResponse, 200)
  }

  async update(c: Context): Promise<TypedResponse<TaskResponse | ErrorResponse>> {
    // Request parsing and validation
    const validationResult = TaskRequestSchema.safeParse(c.req.json());
    if (!validationResult.success) {
      const errorResponse: ErrorResponse = {
        message: JSON.stringify(validationResult.error.flatten()),
      }
      return c.json(errorResponse, 400)
    }

    const validationParamResult = TaskRequestParamSchema.safeParse(c.req.param())
    if (!validationParamResult.success) {
      const errorResponse: ErrorResponse = {
        message: JSON.stringify(validationParamResult.error.flatten()),
      }
      return c.json(errorResponse, 400)
    }

    // Create input for usecase
    const input: UpdateTask = {
      tenantId: c.get('tenantId'),
    };
    const result = await this.taskUsecase.update(input);

    if (!result.isSuccess) {
      const errorResponse: ErrorResponse = { message: result.getError().message }
      return c.json(errorResponse, result.getError().code);
    }

    return c.json(TaskResponseSchema.parse(result.getValue()), 200);
  }

  async delete(c: Context): Promise<TypedResponse<{ message: string } | ErrorResponse>> {
    // FIXME: Request parsing and validation
    const validationParamResult = TaskRequestParamSchema.safeParse(c.req.param())
    if (!validationParamResult.success) {
      const errorResponse: ErrorResponse = {
        message: JSON.stringify(validationParamResult.error.flatten()),
      }
      return c.json(errorResponse, 400)
    }
    // Create input for usecase
    const input: DeleteTask = {
      tenantId: c.get('tenantId'),
      id: validationParamResult.data.team_id,
    }
    const result = await this.taskUsecase.delete(input);

    if (!result.isSuccess) {
      const errorResponse: ErrorResponse = { message: result.getError().message }
      return c.json(errorResponse, result.getError().code);
    }

    return c.json({ message: 'success' }, 200);
  }
}

```
```typescript:internal/usecase/input/task.ts
export type GetTask = {
  tenantId: string
  id: string
}

export type ListTasks = {
  tenantId: string
  limit: number
  page: number
}

export type UpdateTask = {
  tenantId: string
  id: string
  // TODO: Add other fields that are required for updating a Task
}

export type DeleteTask = {
  tenantId: string
  id: string
}

export type CreateTask = {
  tenantId: string
  // TODO: Add other fields that are required for creating a new Task
}

```
```typescript:internal/usecase/output/task.ts
import { Pagination } from '@/internal/domain/model/pagination'
import { Task } from '@/internal/domain/model/task'

export type ListTasks = {
  tasks: Task[]
  pagination: Pagination
}

```
```typescript:internal/usecase/task.ts
import { Result } from '@/core/result'
import { Task } from '@/internal/domain/model/task'
import { GetTaskQuery, ITaskRepository, ListTaskQuery } from '@/internal/domain/repository/task'
import { ITransactionManager } from '@/internal/domain/repository/transaction'
import { CreateTask, GetTask, ListTasks, UpdateTask, DeleteTask } from './input'
import { ListTasks as OListTasks } from './output'

export type ITaskInteractor = {
  create(param: CreateTask): Promise<Result<Task>>
  get(param: GetTask): Promise<Result<Task>>
  list(param: ListTasks): Promise<Result<OListTasks>>
  update(param: UpdateTask): Promise<Result<Task>>
  delete(param: DeleteTask): Promise<Result<Task>>
}

export class TaskInteractor implements ITaskInteractor {
  private transactionManager: ITransactionManager
  private taskRepository: ITaskRepository

  constructor(transactionManager: ITransactionManager, taskRepository: ITaskRepository) {
    this.transactionManager = transactionManager
    this.taskRepository = taskRepository
  }

  async create(input: CreateTask): Promise<Result<Task>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      // TODO: Add logic to create a new Task
      const repoResult = await this.taskRepository.create(ctx, new Task(...));
      return repoResult
    })
  }

  async get(input: GetTask): Promise<Result<Task>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      const getQuery = new GetTaskQuery({
        id: input.id,
      })
      const repoResult = await this.taskRepository.getById(ctx, getQuery)
      return repoResult
    })
  }

  async list(input: ListTasks): Promise<Result<OListTasks>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      // TODO: Add logic to list Tasks
      const listQuery = new ListTaskQuery({
        userId: input.userId,
        limit: input.limit,
        page: input.page,
      })
      const repoResult = await this.taskRepository.getAll(ctx, listQuery);
      return Result.ok({ tasks: repoResult.getValue().tasks, pagination: repoResult.getValue().pagination });
    })
  }

  async update(input: UpdateTask): Promise<Result<Task>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      const getQuery = new GetTaskQuery({
        id: input.id,
      })
      const getRepoResult = await this.taskRepository.getById(ctx, getQuery)
      if (!getRepoResult.isSuccess) {
        return Result.fail(getRepoResult.getError())
      }
      const updatedTask = getRepoResult.getValue()
      // TODO: Update the Task as needed
      const repoResult = await this.taskRepository.update(ctx, updatedTask)
      return repoResult
    })
  }

  async delete(input: DeleteTask): Promise<Result<Task>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      const repoResult = await this.taskRepository.delete(ctx, input.id)
      return repoResult
    })
  }
}

```
:::

### å›°ã£ãŸã“ã¨

#### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå¿…è¦

ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è¿½åŠ ã‚„å‘½åä¿®æ­£ç­‰ã«ä¼´ã†ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå¿…è¦ã§ã™ã€‚
ä¿®æ­£ãŒç™ºç”Ÿã—ãŸæ®µéšã§å¾Œå›ã—ã«ã›ãšã«ç´°ã‹ããƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’è¡Œã†ã“ã¨ãŒé‡è¦ã§ã™ã€‚

:::details ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä¾‹
`ejs`ã®ãŸã‚å‹•çš„ãªå€¤ã®åŸ‹ã‚è¾¼ã¿ç­‰ã«å¯¾å¿œã—ã¦ã„ã¾ã™ãŒã€åŸ‹ã‚è¾¼ã‚“ã çµæœã€ã‹ãªã‚Šå¯èª­æ€§ãŒæ‚ªããªã£ã¦ã—ã¾ã†ã®ã§IDEã®ã‚µãƒãƒ¼ãƒˆã‚„Copilotç­‰ã®ã‚µãƒãƒ¼ãƒˆã¯å¿…é ˆã§ã™ã€‚
```ejs
---
to: internal/usecase/<%= h.inflection.underscore(entity.toLowerCase()) %>.ts
---
import { Result } from '@/core/result'
import { <%= h.inflection.classify(entity) %> } from '@/internal/domain/model/<%= h.inflection.underscore(entity.toLowerCase()) %>'
import { Get<%= h.inflection.classify(entity) %>Query, I<%= h.inflection.classify(entity) %>Repository, List<%= h.inflection.classify(entity) %>Query } from '@/internal/domain/repository/<%= h.inflection.underscore(entity.toLowerCase()) %>'
import { ITransactionManager } from '@/internal/domain/repository/transaction'
import { Create<%= h.inflection.classify(entity) %>, Get<%= h.inflection.classify(entity) %>, List<%= h.inflection.classify(entity) %>s, Update<%= h.inflection.classify(entity) %>, Delete<%= h.inflection.classify(entity) %> } from './input'
import { List<%= h.inflection.classify(entity) %>s as OList<%= h.inflection.classify(entity) %>s } from './output'

export type I<%= h.inflection.classify(entity) %>Interactor = {
  create(param: Create<%= h.inflection.classify(entity) %>): Promise<Result<<%= h.inflection.classify(entity) %>>>
  get(param: Get<%= h.inflection.classify(entity) %>): Promise<Result<<%= h.inflection.classify(entity) %>>>
  list(param: List<%= h.inflection.classify(entity) %>s): Promise<Result<OList<%= h.inflection.classify(entity) %>s>>
  update(param: Update<%= h.inflection.classify(entity) %>): Promise<Result<<%= h.inflection.classify(entity) %>>>
  delete(param: Delete<%= h.inflection.classify(entity) %>): Promise<Result<<%= h.inflection.classify(entity) %>>>
}

export class <%= h.inflection.classify(entity) %>Interactor implements I<%= h.inflection.classify(entity) %>Interactor {
  private transactionManager: ITransactionManager
  private <%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository: I<%= h.inflection.classify(entity) %>Repository

  constructor(transactionManager: ITransactionManager, <%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository: I<%= h.inflection.classify(entity) %>Repository) {
    this.transactionManager = transactionManager
    this.<%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository = <%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository
  }

  async create(input: Create<%= h.inflection.classify(entity) %>): Promise<Result<<%= h.inflection.classify(entity) %>>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      // TODO: Add logic to create a new <%= h.inflection.classify(entity) %>
      const repoResult = await this.<%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository.create(ctx, new <%= h.inflection.classify(entity) %>(...));
      return repoResult
    })
  }

  async get(input: Get<%= h.inflection.classify(entity) %>): Promise<Result<<%= h.inflection.classify(entity) %>>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      const getQuery = new Get<%= h.inflection.classify(entity) %>Query({
        id: input.id,
      })
      const repoResult = await this.<%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository.getById(ctx, getQuery)
      return repoResult
    })
  }

  async list(input: List<%= h.inflection.classify(entity) %>s): Promise<Result<OList<%= h.inflection.classify(entity) %>s>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      // TODO: Add logic to list <%= h.inflection.pluralize(entity) %>
      const listQuery = new List<%= h.inflection.classify(entity) %>Query({
        userId: input.userId,
        limit: input.limit,
        page: input.page,
      })
      const repoResult = await this.<%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository.getAll(ctx, listQuery);
      return Result.ok({ <%= h.inflection.pluralize(entity.toLowerCase()) %>: repoResult.getValue().<%= h.inflection.pluralize(entity.toLowerCase()) %>, pagination: repoResult.getValue().pagination });
    })
  }

  async update(input: Update<%= h.inflection.classify(entity) %>): Promise<Result<<%= h.inflection.classify(entity) %>>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      const getQuery = new Get<%= h.inflection.classify(entity) %>Query({
        id: input.id,
      })
      const getRepoResult = await this.<%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository.getById(ctx, getQuery)
      if (!getRepoResult.isSuccess) {
        return Result.fail(getRepoResult.getError())
      }
      const updated<%= h.inflection.classify(entity) %> = getRepoResult.getValue()
      // TODO: Update the <%= h.inflection.classify(entity) %> as needed
      const repoResult = await this.<%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository.update(ctx, updated<%= h.inflection.classify(entity) %>)
      return repoResult
    })
  }

  async delete(input: Delete<%= h.inflection.classify(entity) %>): Promise<Result<<%= h.inflection.classify(entity) %>>> {
    return this.transactionManager.withTransaction(input.tenantId, async (ctx) => {
      const repoResult = await this.<%= h.inflection.camelize(entity.toLowerCase(), true) %>Repository.delete(ctx, input.id)
      return repoResult
    })
  }
}
```
:::


#### æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®éƒ¨åˆ†çš„ãªæ›´æ–°ãŒé›£ã—ã„

Hygenã¯ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸Šæ›¸ãã‚’è¡Œã†ãŸã‚ã€æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ã®ã¿ã‚’æ›´æ–°ã™ã‚‹ã“ã¨ãŒé›£ã—ã„ã§ã™ã€‚
ãã®ãŸã‚æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ã®ã¿ã‚’æ›´æ–°ã™ã‚‹å ´åˆã¯ã€æ‰‹å‹•ã§ã®ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚

:::message
è©¦ã—ã¦ã¯ã„ã¾ã›ã‚“ãŒã€`hygen`ã‚’`nx`ã®ã‚«ã‚¹ã‚¿ãƒ generatorã¨ã—ã¦ä½¿ç”¨ã—ã¤ã¤ã€`nx`ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚Œã°ã€åŒã˜`ejs`ã‚’ä½¿ç”¨ã—ãªãŒã‚‰æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸€éƒ¨ã®ã¿ã‚’æ›´æ–°ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

https://nx.dev/extending-nx/recipes/modifying-files

:::

# æŠ€è¡“é¸å®šä»¥å¤–ã®å–ã‚Šçµ„ã¿

ã“ã“ã¾ã§ã§ã€AI Workerã§æ¡ç”¨ã—ã¦ã„ã‚‹æŠ€è¡“ã«é–¢ã—ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ã—ã‹ã—ã€å¼Šãƒãƒ¼ãƒ ã§ã¯æ–°ã—ã„ã‚‚ã®ã‚’å–ã‚Šå…¥ã‚Œã‚‹ã ã‘ã§ãªãã€ã©ã®ã‚ˆã†ã«ãƒ¡ãƒ³ãƒãƒ¼ã«æµ¸é€ã•ã›ã‚‹ã‹ã€ã©ã®ã‚ˆã†ã«ãƒ¡ãƒ³ãƒãƒ¼ãŒä½¿ã„ã‚„ã™ã„ç’°å¢ƒã‚’ä½œã‚‹ã‹ç­‰ã€æŠ€è¡“ä»¥å¤–ã®é–‹ç™ºç’°å¢ƒã®å‘ä¸Šã¸ã®å–ã‚Šçµ„ã¿ã‚‚è¡Œã£ã¦ã„ã¾ã™ã€‚

ä»£è¡¨çš„ãªå–ã‚Šçµ„ã¿ã¨ã—ã¦ã¯ä»¥ä¸‹ãŒã‚ã‚Šã¾ã™ã€‚

- **ADRã®å°å…¥**
- **æŠ€è¡“å…±æœ‰ä¼šã®é–‹å‚¬**


## ADRã®å°å…¥

ADRã¯Architecture Decision Recordã®ç•¥ã§ã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ„æ€æ±ºå®šã‚’è¨˜éŒ²ã™ã‚‹ãŸã‚ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã™ã€‚

AI Workerã§ã¯æ—¥ã€…ã®é–‹ç™ºã®ãƒ«ãƒ¼ãƒ«ã‚„æ©Ÿèƒ½è¿½åŠ ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªç­‰ã®é¸å®šéç¨‹ã®çµæœã‚’æ®‹ã—ã€ãƒãƒ¼ãƒ ã§å¾Œã‹ã‚‰æŒ¯ã‚Šè¿”ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

![Alt text](/images/aiworker/adr.png)

:::message
é‹ç”¨ã¯å½¢éª¸åŒ–ã—ãªã„ã‚ˆã†ã«ã€Github Discussionsã‚’ä½¿ç”¨ã—ã¦ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã«ADRã‚’æ®‹ã—è­°è«–ãŒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
:::


## æŠ€è¡“å…±æœ‰ä¼šã®é–‹å‚¬

AIShiftã§ã¯æ¯é€±ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€ãŠã‚ˆã³ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§æŠ€è¡“å…±æœ‰ä¼šã‚’é–‹å‚¬ã—ã¦ã„ã¾ã™ã€‚

AIShiftã¯ã€AI Workerä»¥å¤–ã«ã‚‚Chat Botã‚„Voice Botã®é–‹ç™ºé‹ç”¨ã‚’è¡Œã†ãƒãƒ¼ãƒ ã‚‚ã‚ã‚Šã€ãã‚Œãã‚Œã®ãƒãƒ¼ãƒ å†…ã§æŠ€è¡“çš„ãªçŸ¥è¦‹ãŒé–‰ã˜ã¦ã—ã¾ã‚ãªã„ã‚ˆã†ã«ã€æ¨ªè»¸æ–½ç­–ã¨ã—ã¦ã®å‹‰å¼·ä¼šã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

![Alt text](/images/aiworker/frontend.png)

AI Workerãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰([@ytaisei_](https://twitter.com/ytaisei_))ãŒé‹å–¶ã‚’è¡Œã£ã¦ãã‚Œã¦ãŠã‚Šã€å„ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã”ã¨ã«æ¡ç”¨ã—ã¦ã„ã‚‹æŠ€è¡“ã®å…±æœ‰ã‚„ã€è©±é¡Œã®æŠ€è¡“ã®ã‚­ãƒ£ãƒƒãƒã‚¢ãƒƒãƒ—ã‚’ã–ã£ãã°ã‚‰ã‚“ã«è¡Œã£ã¦ã„ã¾ã™ã€‚

![Alt text](/images/aiworker/news.png)




# ã¾ã¨ã‚

ã“ã®è¨˜äº‹ã§ã¯AI Workerã§æ¡ç”¨ã—ã¦ã„ã‚‹æŠ€è¡“ã¨ãƒãƒ¼ãƒ å†…ã§ã®å–ã‚Šçµ„ã¿ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¾ã—ãŸã€‚

ã¾ã ãƒãƒ¼ãƒ è‡ªä½“ã¯ç™ºè¶³ã—3ãƒ¶æœˆç¨‹åº¦ã§ã€ã§ãã¦ã„ãªã„ã“ã¨ã‚‚å¤šã„ã§ã™ãŒã€æ—¥ã€…æ–°ã—ã„æŠ€è¡“ã¨å‘ãåˆã„ãªãŒã‚‰æ¤œè¨¼ã‚’è¡Œã„ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã«å–ã‚Šå…¥ã‚Œã¦ã„ã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¡¨é¢çš„ãªéƒ¨åˆ†ã®ã¿ã—ã‹è§¦ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€å„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è©³ç´°ã‚„ã‚¤ãƒ³ãƒ•ãƒ©é¢ã«ã¤ã„ã¦ã¯éšæ™‚è¨˜äº‹ã«ã—ã¦æŠ•ç¨¿ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚


# æœ€å¾Œã«

AI Shiftã§ã¯ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®æ¡ç”¨ã«åŠ›ã‚’å…¥ã‚Œã¦ã„ã¾ã™ï¼
å°‘ã—ã§ã‚‚èˆˆå‘³ã‚’æŒã£ã¦ã„ãŸã ã‘ã¾ã—ãŸã‚‰ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«é¢è«‡ã§ãŠè©±ã—ã¾ã›ã‚“ã‹ï¼Ÿ
ï¼ˆã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ»19æ™‚ä»¥é™ã®é¢è«‡ã‚‚å¯èƒ½ã§ã™ï¼ï¼‰

ã€é¢è«‡ãƒ•ã‚©ãƒ¼ãƒ ã¯ã“ã¡ã‚‰ã€‘
https://hrmos.co/pages/cyberagent-group/jobs/1826557091831955459



