---
title: "Agones GameServerç·¨"
emoji: "ğŸ®"
type: "idea" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [agones, kubernetes, gameserver]
published: false
---

ã“ã‚“ã«ã¡ã¯ã€[@sugar235711](https://twitter.com/sugar235711)ã§ã™ã€‚
ã“ã®è¨˜äº‹ã¯ã€Œã²ã¨ã‚Šã§æ°—ã«ãªã‚‹OSSã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å…¨éƒ¨èª­ã‚“ã§ä½•ã‹ã™ã‚‹ Advent Calendar 2025ã€2æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
https://qiita.com/advent-calendar/2025/sugarcat

- [å…¨ä½“ç·¨](https://zenn.dev/king/articles/4e55f030aa01ee)
- [GameServerç·¨](https://zenn.dev/king/articles/003f7b79409b4a) â†ä»Šã“ã“
- Fleetç·¨
- GameServerAllocationç·¨
- FleetAutoscalerç·¨
- Metricsç·¨

### GameServerã«é–¢ã—ã¦
Agonesã§ã¯Custom Resourceã¨ã—ã¦GameServerã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

![image](https://agones.dev/site/diagrams/system-diagram.dot.png)

https://agones.dev/site/docs/advanced/system-diagram/



ã“ã®è¨˜äº‹ã§ã¯GameServer CRDã«ç„¦ç‚¹ã‚’å½“ã¦ã¦å†…éƒ¨å®Ÿè£…ã‚’çœºã‚ã¦ã„ãã¾ã™ã€‚
GameServerã®å®šç¾©ã‚’çœºã‚ã¦ã¿ã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã§è¡Œãˆã‚‹ç‰¹å¾´çš„ãªè¨­å®šã¯ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã™ã‚‹Port Allocationã®è¨­å®šã‚„ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®æŒ‡å®šã€GameServerè‡ªä½“ã«å¯¾ã—ã¦Roomæ•°ã‚„ã‚­ãƒ£ãƒ‘ã‚·ãƒ†ã‚£ã®è¨­å®šãŒã§ãã‚‹ç‚¹ãªã©ãŒæ™®é€šã®Deploymentç­‰ã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚


```yaml
apiVersion: "agones.dev/v1"
kind: GameServer
# GameServer Metadata
# https://v1-32.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.32/#objectmeta-v1-meta
metadata:
  # generateName: "gds-example" # generate a unique name, with the given prefix
  name: "gds-example" # set a fixed name
spec:
  # if there is more than one container, specify which one is the game server
  container: example-server
  ports:
    # ...
    # portPolicy has four options:
    # - "Dynamic" (default) the system allocates a free hostPort for the gameserver, for game clients to connect to
    # - "Static", user defines the hostPort that the game client will connect to. Then onus is on the user to ensure that the
    # port is available. When static is the policy specified, `hostPort` is required to be populated
    # - "Passthrough" dynamically sets the `containerPort` to the same value as the dynamically selected hostPort.
    #      This will mean that users will need to lookup what port has been opened through the server side SDK.
    # - "None" means the `hostPort` is ignored and if defined, the `containerPort` (optional) is used to set the port on the GameServer instance.
    portPolicy: Static
    # The name of the container to open the port on. Defaults to the game server container if omitted or empty.
    container: simple-game-server
    # the port that is being opened on the game server process
    containerPort: 7654
    # the port exposed on the host, only required when `portPolicy` is "Static". Overwritten when portPolicy is "Dynamic".
    hostPort: 7777
    # protocol being used. Defaults to UDP. TCP and TCPUDP are other options
    # - "UDP" (default) use the UDP protocol
    # - "TCP", use the TCP protocol
    # - "TCPUDP", uses both TCP and UDP, and exposes the same hostPort for both protocols.
    #       This will mean that it adds an extra port, and the first port is set to TCP, and second port set to UDP
    protocol: UDP
 
  counters: # counters are int64 counters that can be incremented and decremented by set amounts. Keys must be declared at GameServer creation time.
    rooms: # arbitrary key.
      count: 1 # initial value can be set.
      capacity: 100 # (Optional) Defaults to 1000 and setting capacity to max(int64) may lead to issues and is not recommended. See GitHub issue https://github.com/googleforgames/agones/issues/3636 for more details.
  lists: # lists are lists of values stored against this GameServer that can be added and deleted from. Keys must be declared at GameServer creation time.
    players: # an empty list, with a capacity set to 10.
      capacity: 10 # capacity value, defaults to 1000.
    rooms: # note that it is allowed to have the same key name with one used in counters
      capacity: 333
      values: # initial values can also be set for lists
        - room1
        - room2
        - room3
```
https://agones.dev/site/docs/reference/gameserver/

Kubernetes APIã«å¯¾ã—ã¦é€ä¿¡ã•ã‚Œã¦ã„ã‚‹GameServerã®å®šç¾©ã¯ä»¥ä¸‹ã§ç¢ºèªã§ãã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/apis/agones/v1/gameserver.go#L218-L247


GameServerã¯å†…éƒ¨ã§Stateã‚’æŒã£ã¦ãŠã‚Šã€Podèµ·å‹•æ™‚ã‹ã‚‰Shutdonwnã¾ã§ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/apis/agones/v1/gameserver.go#L39-L71

çŠ¶æ…‹é·ç§»ã¯ã–ã£ãã‚Šä¸‹è¨˜ãŒè¡Œã‚ã‚Œã€GameServerã®StateãŒé·ç§»ã—ã¦ã„ãã¾ã™ã€‚
- Specã§æŒ‡å®šã•ã‚ŒãŸDynamic Policyã«ã‚ˆã‚‹Port Allocation
- Podä½œæˆ
- SDKã«ã‚ˆã‚‹Ready/Shutdownã‚·ã‚°ãƒŠãƒ«ã®å—ä¿¡

![GameServer States](https://agones.dev/site/diagrams/gameserver-states.dot.png)

ã¾ãšControllerã®Runãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯WorkQueueã«å¯¾ã—ã¦ç™»éŒ²ã•ã‚ŒãŸ`syncGameServer`ãŒå‘¼ã³å‡ºã•ã‚Œã¦ãŠã‚Šã€ãã®ä¸­ã®Stateé·ç§»ã®ä¸»è¦ãªéƒ¨åˆ†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚
- Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆAdd/Update/Deleteï¼‰ã‚’ç›£è¦–
- çŠ¶æ…‹å¤‰åŒ–ãŒã‚ã£ãŸå ´åˆã®ã¿WorkQueueã«ã‚¨ãƒ³ã‚­ãƒ¥ãƒ¼ã—ã€Reconciliation Loopã‚’å®Ÿè¡Œ

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/controller.go#L176-L186

ãã‚Œãã‚Œã®Stateã«å¿œã˜ã¦Enqueueã•ã‚Œå‡¦ç†ãŒè¡Œã‚ã‚Œã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/controller.go#L230-L244

ã¾ãš`syncGameServerPortAllocationState`ã®å†…éƒ¨ã§Port Allocationã®å‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/controller.go#L543-L564

ã“ã®`Allocate`ãƒ¡ã‚½ãƒƒãƒ‰ã§Dynamic Policyã«åŸºã¥ã„ã¦Portã®å‰²ã‚Šå½“ã¦ãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã€‚
```go
gsCopy := c.portAllocator.Allocate(gs.DeepCopy())
```

Allocaterã¯å„ãƒãƒ¼ãƒ‰ã®Portã‚’èª¿ã¹å¿…è¦PortåŠã³ãƒãƒªã‚·ãƒ¼ãŒæº€ãŸã›ã‚‹Portã‚’æ¢ã—ã€è¦‹ã¤ã‹ã‚Œã°`gameServerRegistry`ã¸ç™»éŒ²ã—ã¦ã„ã¾ã™ã€‚
å‰²ã‚Šå½“ã¦ãŸGameServerã¯ã‚­ãƒ¼ã¯UIDã§ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚
```go
UID types.UID `json:"uid,omitempty" protobuf:"bytes,5,opt,name=uid,casttype=k8s.io/kubernetes/pkg/types.UID"`
```
è¤‡æ•°ã®GameServerãŒåŒã˜ãƒãƒ¼ãƒ‰ã§åŒã˜Portã‚’ä½¿ç”¨ã—ãªã„ã‚ˆã†ã«ã€`mutex.Lock()`ãŒä½¿ç”¨ã•ã‚Œã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªå®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/portallocator/portallocator.go#L226

ã¾ãŸãƒãƒ¼ãƒˆä¸è¶³æ™‚ã«ä»®æƒ³çš„ã«Portã‚’å‰²ã‚Šå½“ã¦ã¦ãŠãã€Podã®çŠ¶æ…‹ã‚’Pendingã«ã™ã‚‹ã“ã¨ã§å†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã‚’ä¿ƒã™ä»•çµ„ã¿ã‚‚å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/portallocator/portallocator.go#L273-L277

ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Œäº†ã™ã‚‹ã¨Podä½œæˆ(`syncGameServerCreatingState`)ãŒè¡Œã‚ã‚Œã¾ã™ã€‚
å†…éƒ¨ã§`agones-gameserver-sidecar`ã®ã‚³ãƒ³ãƒ†ãƒŠãŒæ³¨å…¥ã•ã‚Œã¾ã™ã€‚
ã“ã‚Œã¯GameServerãƒ—ãƒ­ã‚»ã‚¹ãŒAgonesã¨é€šä¿¡ã™ã‚‹ãŸã‚ã®APIã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦å‹•ä½œã—ã¾ã™ã€‚
gRPCã¨HTTPã®ä¸¡æ–¹ã§é€šä¿¡ãŒå¯èƒ½ã§GameServerå´ã®SDKçµŒç”±ã§åˆ©ç”¨ã•ã‚Œã€å†…éƒ¨é€šä¿¡å‘ã‘ã®Proxyã¨ã—ã¦å‹•ä½œã—ã¦ã„ã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/controller.go#L716-L757

ã¾ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©ã®ã‚³ãƒ³ãƒ†ãƒŠã‚‚PodSpecã«è¿½åŠ ã•ã‚Œã€PodãŒä½œæˆã•ã‚Œã¾ã™ã€‚
https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/controller.go#L664

ãã‚Œãã‚Œã®ã‚³ãƒ³ãƒ†ãƒŠã«å¯¾ã—ã¦é©åˆ‡ãªæ¨©é™ã‚’æŒã¤ServiceAccountãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã‚‹ã‚ˆã†ã«GameServerå´ã®ãƒˆãƒ¼ã‚¯ãƒ³(`/var/run/secrets/kubernetes.io/serviceaccount`)ã‚’ç©ºã®Volumeã§ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã„ã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/apis/agones/v1/gameserver.go#L887-L899


å‚è€ƒ
https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/
https://qiita.com/knqyf263/items/ecc799650fe247dce9c5#service-account-admission-controller

ãã®å¾ŒPodèµ·å‹•ã«åˆã‚ã›ã¦çŠ¶æ…‹ãŒé·ç§»ã—ã¦ã„ãã¾ã™ã€‚SDK <-> SidecarçµŒç”±ã§Kubernetes APIã‚µãƒ¼ãƒãƒ¼ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒè¡Œã‚ã‚Œã¦ã„ãã¾ã™ã€‚

https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/controller.go#L946-L949

```
SDKå‘¼ã³å‡ºã—
  â†“ localhost:9357 (gRPC)
Sidecar
  â†“ WorkerQueue
Sidecar Worker
  â†“
PATCH /apis/agones.dev/v1/namespaces/{ns}/gameservers/{name}
Content-Type: application/json-patch+json
Authorization: Bearer <token>

Body: [
  {"op": "test", "path": "...", "value": "..."},
  {"op": "replace", "path": "...", "value": "..."}
]
  â†“
Kubernetes API Server
  â†“ GameServer CRDæ›´æ–°
Informer (Controller)
  â†“
Controller ã® Reconciliation Loop
```

æ“ä½œè‡ªä½“ã«ã¯Code Generatorã§ä½œæˆã•ã‚ŒãŸClientSetãŒä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚

å‚è€ƒ
https://github.com/kubernetes/code-generator
https://zenn.dev/ryooftheryo/articles/d103d973fc0cdd


ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ãŒã€ã“ã®GameServer Controllerå†…ã§åˆ¥Goroutineã¨ã—ã¦åˆ¥ã®ControllerãŒå‹•ä½œã—ã¦ã„ã¾ã™ã€‚
ã“ã‚Œã‚‰ã¯åŸºæœ¬çš„ã«Podã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’ç®¡ç†ã—ã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç­‰ã®æ›´æ–°ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚
https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md#objects

- `healthController`
Podã®ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚„ãƒãƒ¼ãƒˆå‰²ã‚Šå½“ã¦å¤±æ•—ã‚’æ¤œçŸ¥ã—ã€GameServerã‚’UnhealthyçŠ¶æ…‹ã«ç§»è¡Œã—ã¦ã„ã¾ã™ã€‚
https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/health.go#L204-L264

- `migrationController`
PodãŒãƒãƒ¼ãƒ‰é–“ã§ç§»è¡Œã•ã‚ŒãŸå ´åˆã«ã€GameServerã®ã‚¢ãƒ‰ãƒ¬ã‚¹/ãƒãƒ¼ãƒˆæƒ…å ±ã‚’æ›´æ–°
https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/migration.go#L183-L232

- `missingPodController`
PodãŒå‰Šé™¤ã•ã‚ŒãŸã®ã«GameServerãŒæ®‹ã£ã¦ã„ã‚‹å ´åˆã«Unhealthyã«ç§»è¡Œ
https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/missing.go#L125-L170

- `succeededController`
PodãŒSucceededçŠ¶æ…‹ã«ãªã£ãŸå ´åˆã€GameServerã‚’ShutdownçŠ¶æ…‹ã«ç§»è¡Œï¼ˆSidecar Containers featureç”¨ï¼‰
https://github.com/googleforgames/agones/blob/67c4b6b39b9f4a0b6c473e303acb38c2cccf150e/pkg/gameservers/succeeded.go#L116-L166


### ã¾ã¨ã‚

GameServerã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«ã¤ã„ã¦ã¿ã¦ã„ãã¾ã—ãŸã€‚
æ˜æ—¥ã¯Fleetç­‰ã®GameServerç¾¤ã‚’ç®¡ç†ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«ã¤ã„ã¦ã¿ã¾ã™ã€‚