---

title: "Honoã¨Casbinã§èªå¯åˆ¶å¾¡ã‚’å®Ÿè£…ã™ã‚‹"  
emoji: "â¤ï¸â€ğŸ”¥"  
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢  
topics: []  
published: false  

---

ã“ã‚“ã«ã¡ã¯ã€[sugar-cat](https://twitter.com/sugar235711)ã§ã™ã€‚

å…ˆæ—¥ã€Honoã®3rd PartyãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«Casbinã‚’çµ„ã¿è¾¼ã¿ã¾ã—ãŸã€‚  
https://github.com/honojs/middleware/pull/676
https://github.com/honojs/middleware/tree/main/packages/casbin

ã“ã®è¨˜äº‹ã§ã¯ã€Honoã¨Casbinã‚’çµ„ã¿åˆã‚ã›ãŸèªå¯åˆ¶å¾¡ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

Honoã‚„Casbinã«ã¤ã„ã¦ã¯ã€æ—¢ã«å¤šãã®è§£èª¬è¨˜äº‹ãŒã‚ã‚Šã¾ã™ã®ã§ã€è©³ã—ãã¯ãã¡ã‚‰ã‚’ã”å‚ç…§ãã ã•ã„ã€‚  
https://future-architect.github.io/articles/20221004a/  
https://zenn.dev/aishift/articles/a3dc8dcaac6bfa

## ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¨ã¯ï¼Ÿ

ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã¨ã¯ã€ã‚·ã‚¹ãƒ†ãƒ ã‚„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®`ç‰¹å®šã®ãƒªã‚½ãƒ¼ã‚¹`ã«å¯¾ã—ã¦ã€`èª°ãŒ`ã€`ä½•ã‚’`è¡Œãˆã‚‹ã‹ã‚’åˆ¶å¾¡ã™ã‚‹ä»•çµ„ã¿ã§ã™ã€‚
ãŸã¨ãˆã°ã€ã€Œè‡ªåˆ†ãŒä½œæˆã—ãŸè¨˜äº‹ã¯è‡ªåˆ†ã ã‘ãŒç·¨é›†ã§ãã‚‹ã€ã¨ã„ã†ã‚ˆã†ãªãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã§ãã¾ã™ã€‚

ã“ã®ä»•çµ„ã¿ã¯ä»¥ä¸‹ã®3ã¤ã®è¦ç´ ã§æ§‹æˆã•ã‚Œã¾ã™ã€‚

1. **èª°ãŒï¼ˆWhoï¼‰**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚„ã‚°ãƒ«ãƒ¼ãƒ—ãªã©
2. **ä½•ã«å¯¾ã—ã¦ï¼ˆWhatï¼‰**: ã‚¢ã‚¯ã‚»ã‚¹å¯¾è±¡ã¨ãªã‚‹ãƒªã‚½ãƒ¼ã‚¹
3. **ã©ã®ã‚ˆã†ãªæ“ä½œã‚’ã™ã‚‹ã‹ï¼ˆHowï¼‰**: èª­ã¿è¾¼ã¿ã€æ›¸ãè¾¼ã¿ã€å‰Šé™¤ãªã©ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

ã“ã‚Œã«ã‚ˆã‚Šã€ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç‰¹å®šã®æ“ä½œã ã‘ã‚’è¨±å¯ã™ã‚‹è¨­å®šãŒã§ãã€ã‚µãƒ¼ãƒ“ã‚¹ã®å®‰å…¨æ€§ã‚’é«˜ã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
èªå¯ã«é–¢ã—ã¦ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ãŒè©³ã—ã„ã®ã§ã€ãœã²ã”ä¸€èª­ãã ã•ã„ã€‚  
https://zenn.dev/she_techblog/articles/6eff1f28d107be

## Casbin Middleware for Honoã®ä½¿ã„æ–¹

ãã‚Œã§ã¯ã€Honoã¨Casbinã‚’çµ„ã¿åˆã‚ã›ã¦ã€å®Ÿéš›ã«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«`casbin`ã‚’çµ„ã¿è¾¼ã‚€ã“ã¨ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°éƒ¨åˆ†ã§èªå¯åˆ¶å¾¡ãŒå¯èƒ½ã§ã™ã€‚

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã¾ãšã€å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚Honoæœ¬ä½“ã€Honoç”¨ã®CasbinãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã€ãã—ã¦Casbinè‡ªä½“ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
npm i hono @hono/casbin casbin
```

### Casbinãƒ¢ãƒ‡ãƒ«ã¨ãƒãƒªã‚·ãƒ¼ã®è¨­å®š

Casbinã‚’ä½¿ç”¨ã™ã‚‹ã«ã¯ã€ã¾ãšã€Œãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã€ã¨ã€Œãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚’è¨­å®šã—ã¾ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã¯ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã€ãƒãƒªã‚·ãƒ¼ã¯èª°ãŒã©ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã—ã¦ã©ã®ã‚ˆã†ãªæ“ä½œãŒã§ãã‚‹ã‹ã‚’å®šç¾©ã—ã¾ã™ã€‚

#### model.confï¼ˆãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

```conf
[request_definition]
r = sub, obj, act

[policy_definition]
p = sub, obj, act

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = r.sub == p.sub && keyMatch(r.obj, p.obj) && (r.act == p.act || p.act == "*")
```

ã“ã®ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãƒãƒªã‚·ãƒ¼ã€ãƒãƒªã‚·ãƒ¼ã®åŠ¹æœã€ãã—ã¦ãƒãƒƒãƒãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€`sub`ï¼ˆèª°ãŒï¼‰ã€`obj`ï¼ˆä½•ã«å¯¾ã—ã¦ï¼‰ã€`act`ï¼ˆã©ã®æ“ä½œã‚’è¡Œã†ã‹ï¼‰ã‚’ã‚‚ã¨ã«ãƒãƒƒãƒãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ã‚’è¨­å®šã—ã€ãƒãƒªã‚·ãƒ¼ãŒè¨±å¯ã•ã‚Œã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚

#### policy.csvï¼ˆãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰

```csv
p, alice, /dataset1/*, *
p, bob, /dataset1/*, GET
```

ã“ã®ãƒãƒªã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼`alice`ãŒ`/dataset1`ä»¥ä¸‹ã®ã™ã¹ã¦ã®æ“ä½œã‚’è¡Œãˆã‚‹ä¸€æ–¹ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼`bob`ã¯`GET`ãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

## Basicèªè¨¼ã¨ã®é€£æº

æ¬¡ã«ã€Honoã®Basicèªè¨¼æ©Ÿèƒ½ã‚’åˆ©ç”¨ã—ã¦ã€èªè¨¼å¾Œã«Casbinã‚’ç”¨ã„ãŸèªå¯åˆ¶å¾¡ã‚’è¡Œã†æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€`Authorization: Basic {Base64Encoded(username:password)}`ã®å½¢å¼ã§èªè¨¼æƒ…å ±ã‚’é€ä¿¡ã—ã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼`alice`ã¨`bob`ã«ç•°ãªã‚‹ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```ts
import { Hono } from 'hono'
import { basicAuth } from 'hono/basic-auth'
import { newEnforcer } from 'casbin'
import { casbin } from '@hono/casbin'
import { basicAuthorizer } from '@hono/casbin/helper'

const app = new Hono()

app.use('*',
  basicAuth({
    username: 'alice', password: 'password',
  }, {
    username: 'bob', password: 'password',
  }),
  casbin({
    newEnforcer: newEnforcer('model.conf', 'policy.csv'),
    authorizer: basicAuthorizer
  })
)

app.get('/dataset1/test', (c) => c.text('dataset1 test')) // aliceã¨bobãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
app.post('/dataset1/test', (c) => c.text('dataset1 test')) // aliceã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`alice`ã¯`/dataset1/test`ã«å¯¾ã—ã¦ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ãŒã€`bob`ã¯`GET`ãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚

ã“ã“ã§`authorizer: basicAuthorizer`ã®ã‚ˆã†ã«ã€æ±ç”¨çš„ãªhelperã¨ã—ã¦`basicAuthorizer`ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚
ã“ã®å‡¦ç†ã§ã¯ã€Authorization Headerã®å†…å®¹ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã€Casbinã®Enforcerã«æ¸¡ã™ãŸã‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚  
https://github.com/honojs/middleware/blob/main/packages/casbin/src/helper/basic-auth.ts

å†…éƒ¨ã§ã¯ã€Honoã®çµ„ã¿è¾¼ã¿Basicèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚  
https://github.com/honojs/hono/blob/c0d782cd649525ce40489906a24d83607deede29/src/utils/basic-auth.ts#L1-L26

## JWTèªè¨¼ã¨ã®é€£æº

æ¬¡ã«ã€JWTã‚’åˆ©ç”¨ã—ãŸèªå¯åˆ¶å¾¡ã®ä¾‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ä½•ã‚‰ã‹ã®IdPã§èªè¨¼å¾Œã«ç™ºè¡Œã•ã‚ŒãŸTokenï¼ˆJWTï¼‰ã‚’åˆ©ç”¨ã—ã¦èªå¯åˆ¶å¾¡ã‚’è¡Œã†ã‚·ãƒŠãƒªã‚ªã§ä½¿ç”¨ã§ãã¾ã™ã€‚

ä»¥ä¸‹ã®ä¾‹ã§ã¯ã€JWTã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å†…ã®`sub`ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ã—ã¦åˆ©ç”¨ã—ã€èªå¯åˆ¶å¾¡ã‚’è¡Œã„ã¾ã™ã€‚

```ts
import { Hono } from 'hono'
import { jwt } from 'hono/jwt'
import { newEnforcer } from 'casbin'
import { casbin } from '@hono/casbin'
import { jwtAuthorizer } from '@hono/casbin/helper'

const app = new Hono()

app.use('*',
  jwt({ secret: 'it-is-very-secret' }),
  casbin({
    newEnforcer: newEnforcer('model.conf', 'policy.csv'),
    authorizer: jwtAuthorizer
  })
)

app.get('/dataset1/test', (c) => c.text('dataset1 test')) // aliceã¨bobãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
app.post('/dataset1/test', (c) => c.text('dataset1 test')) // aliceã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
```

`jwtAuthorizer`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯JWTå†…ã®`sub` Claimã‚’ã‚‚ã¨ã«èªå¯åˆ¶å¾¡ã‚’è¡Œã„ã¾ã™ã€‚
ã¾ãŸã€ç‰¹å®šã®Claimã‚’`model.conf`ã®`sub`ã«å‰²ã‚Šå½“ã¦ãŸã„å ´åˆã¯ã€`claimMapping`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```ts
const claimMapping = {
  ServiceRole: 'role', // keyã¯äººé–“ãŒç†è§£ã—ã‚„ã™ã„åå‰ã€valueã¯JWTã®Claimå
}
casbin({
  newEnforcer: newEnforcer('model.conf', 'policy.csv'),
  authorizer: (c, e) => jwtAuthorizer(c, e, claimMapping)
})
```

å†…éƒ¨çš„ã«`claimMapping`ã§æŒ‡å®šã—ãŸå€¤ã‚’å…¨ã¦Enforcerã«æ¸¡ã™å®Ÿè£…ã¨ãªã£ã¦ã„ã‚‹ãŸã‚ã€ã‚ˆã‚Šè¤‡é›‘ãªãƒ¢ãƒ‡ãƒ«ã§è¤‡æ•°ã®Claimã‚’è©•ä¾¡ã—ãŸã„å ´åˆã«ã‚‚ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚  
https://github.com/honojs/middleware/blob/1ed5c7d7fad739be31d7a0b2280b8517b4637f3b/packages/casbin/src/helper/jwt.ts#L32-L35

## ã‚«ã‚¹ã‚¿ãƒ èªå¯ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè£…

ã‚‚ã¡ã‚ã‚“ã€`authorizer`ã¯è‡ªåˆ†ã§å®Ÿè£…ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚

```ts
import { Hono } from 'hono'
import { newEnforcer } from 'casbin'
import { casbin } from '@hono/casbin'

const app = new Hono()

app.use('*', casbin({
  newEnforcer: newEnforcer

('model.conf', 'policy.csv'),
  authorizer: async (c, enforcer) => {
    const { user, path, method } = c
    return await enforcer.enforce(user, path, method)
  }
}))
```

## ã¾ã¨ã‚

Honoã¨Casbinã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ãªèªå¯åˆ¶å¾¡ã‚’ç°¡å˜ã«å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚