---
title: "æ–°è¦ã‚µãƒ¼ãƒ“ã‚¹ã®ç«‹ã¡ä¸Šã’ã‹ã‚‰10ãƒ¶æœˆçµŒã£ãŸã®ã§è‰²ã€…ã¾ã¨ã‚ã¦ã¿ãŸ"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["googlecloud", "kubernetes", "terraform", "hono", "clerk"]
published: false
publication_name: aishift
---

ã“ã‚“ã«ã¡ã¯ã€[sugar-cat](https://twitter.com/sugar235711)ã§ã™ã€‚

AIShiftã§ã¯ã€æ˜¨å¹´11æœˆã‹ã‚‰ã€ŒAI Workerã€^[https://www.ai-shift.co.jp/3958]ï¼ˆä»¥ä¸‹ã€AI Workerï¼‰ã¨ã„ã†æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã®é–‹ç™ºã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚
ç´„10ãƒ¶æœˆãŒçµŒéã—æ§˜ã€…ãªã“ã¨ãŒã‚ã‚Šã¾ã—ãŸãŒã€ä»Šå›ã¯ç§ãŒè¡Œã£ãŸ**æ©Ÿèƒ½é–‹ç™ºä»¥å¤–**ã§ã€å¤–éƒ¨å…¬é–‹ãŒå¯èƒ½ãªå–ã‚Šçµ„ã¿ã‚’ã–ã£ãã‚Šã¨ã¾ã¨ã‚ã¾ã™ã€‚ã¾ã ã¾ã é–‹ç™ºé€”ä¸Šã®éƒ¨åˆ†ã‚‚å¤šãã€è‡³ã‚‰ãªã„ç‚¹ãŒå¤šã„ã§ã™ãŒã€ãªã‚“ã‚‰ã‹å½¹ç«‹ã¤ã¨å¬‰ã—ã„ã§ã™ã€‚

3ãƒ¶æœˆæ™‚ç‚¹ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã”è¦§ãã ã•ã„ã€‚ã©ã®ã‚ˆã†ãªæŠ€è¡“ã‚’ä½¿ã„ã€ä½•ã‚’ä½œã£ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ã„ã¾ã™ã€‚
https://zenn.dev/aishift/articles/ce9783a0d7acd0


## Google Cloudã¸ã®ã‚µãƒ¼ãƒ“ã‚¹å±•é–‹

å¼Šãƒãƒ¼ãƒ ã§ã¯ã€ã‚‚ã¨ã‚‚ã¨**Microsoft Azure**ã®ã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ™ãƒ¼ã‚¹ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ãƒ»é‹ç”¨ã—ã¦ã„ã¾ã—ãŸã€‚ã—ã‹ã—ã€ãƒ“ã‚¸ãƒã‚¹è¦ä»¶ã®å¤‰æ›´ã«ä¼´ã„ã€**Google Cloudã¨ä½µç”¨ã—ã¦**ã‚µãƒ¼ãƒ“ã‚¹ã‚’å±•é–‹ã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚

### æ—¢å­˜ã®Azureæ§‹æˆ
ã‚‚ã¨ã‚‚ã¨ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯**Azure Container Apps**ã‚’åŸºç›¤ã«æ§‹æˆã—ã¦ãŠã‚Šã€ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ã®æ‰‹é–“ã‚’æœ€å°é™ã«æŠ‘ãˆã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹ç™ºã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã—ãŸã€‚

![alt text](/images/aiworkerv2/1.png)

ã—ã‹ã—ã€é–‹ç™ºã®é€”ä¸­ã§`IaCåŒ–`ã«ä¼´ã†å•é¡Œã‚„`Azureå›ºæœ‰ã®çŸ¥è­˜`ã«ã‚ˆã‚‹å•é¡Œã«ç›´é¢ã™ã‚‹å ´é¢ãŒå¤šãã‚ã‚Šã€ã“ã‚Œã‚‰ã®èª²é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã€`Kubernetes`ï¼ˆä»¥ä¸‹ã€k8sï¼‰ã¸ã®ç§»è¡Œã‚’æ±ºå®šã—ã¾ã—ãŸã€‚

:::message
Azure Container Appsã®è©±ã«ã¤ã„ã¦ã¯ä»¥ä¸‹ã®è¨˜äº‹ã‚’ã”å‚ç…§ãã ã•ã„ã€‚
https://zenn.dev/aishift/articles/01ac0622cff568
:::

ãã“ã§ã€ã‚‚ã¨ã‚‚ã¨AI Shiftã§åˆ©ç”¨ã—ã¦ã„ãŸ`Google Kubernetes Engine`ï¼ˆä»¥ä¸‹ã€`GKE`ï¼‰ã‚’æ´»ç”¨ã—ã€Google Cloudä¸Šã§ã®å±•é–‹ã¨åˆã‚ã›ã¦k8sã¸ã®ç§»è¡Œã‚’é€²ã‚ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

### Google Cloudã¸ã®ç§»è¡Œæ‰‹é †
Google Cloudã¸ã®å±•é–‹ã«ã‚ãŸã‚Šã€Azureã§ã®å‹•ä½œç’°å¢ƒã‚’Google Cloudä¸Šã§å†ç¾ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®æ‰‹é †ã§ä½œæ¥­ã‚’é€²ã‚ã¾ã—ãŸã€‚

1. **å®šç¾©æ¸ˆã¿ã®Azureãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰å¯¾å¿œã™ã‚‹Google CloudãŠã‚ˆã³k8sãƒªã‚½ãƒ¼ã‚¹ã®èª¿æŸ»**
2. **Terraformã‚„ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’åˆ©ç”¨ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆ**
3. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¿®æ­£**
4. **CI/CDã®ä¿®æ­£**

---
#### 1. Azureãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰Google CloudãŠã‚ˆã³k8sãƒªã‚½ãƒ¼ã‚¹ã®èª¿æŸ»

k8sã‚’åˆ©ç”¨ã™ã‚‹ã«ã‚ãŸã‚Šã€ãƒªã‚½ãƒ¼ã‚¹ã‚’**Terraformã§ç®¡ç†ã™ã‚‹ã‹ã€ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã§ç®¡ç†ã™ã‚‹ã‹ã®æ£²ã¿åˆ†ã‘**ãŒå¿…è¦ã¨ãªã‚Šã¾ã—ãŸã€‚å¼Šãƒãƒ¼ãƒ ã§ã¯ã€ä»–ã®ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¸ã®ç§»è¡Œã‚‚è¦‹æ®ãˆã¦ã€æ¬¡ã®æ–¹é‡ã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

- k8så´ã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãƒªã‚½ãƒ¼ã‚¹ï¼ˆä¾‹: Deployment, Service, Ingressãªã©ï¼‰: **ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã§ç®¡ç†**
- Google Cloudã®åŸºç›¤ãƒªã‚½ãƒ¼ã‚¹ï¼ˆä¾‹: Database, Storage, k8sã®Node Poolãªã©ï¼‰: **Terraformã§ç®¡ç†**

ã¾ãŸã€å…ƒã€…AI Shiftã§é‹ç”¨ã—ã¦ã„ãŸã‚¯ãƒ©ã‚¹ã‚¿ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’åŒå±…ã•ã›ã€åŸºæœ¬çš„ã«**ãƒªã‚½ãƒ¼ã‚¹é¡ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã«åˆã‚ã›ã¦ç®¡ç†**ã§ãã‚‹ã‚ˆã†ãªå½¢ã«ã—ã¦ã„ã¾ã™ã€‚

---
#### 2. Terraform/ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’åˆ©ç”¨ã—ãŸãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

å¼Šãƒãƒ¼ãƒ ã§ã¯ã€**1ã¤ã®ãƒªãƒã‚¸ãƒˆãƒª**ã§**Terraform**ã¨**k8sã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ**ã‚’ç®¡ç†ã•ã‚Œã¦ãŠã‚Šã€ç¾åœ¨ã¯1ãƒªãƒã‚¸ãƒˆãƒªï¼1ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å½¢ã«ãªã£ã¦ã„ã¾ã™ã€‚

ç¾åœ¨ã®Terraformã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã¯1ã¤ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã—ã‹ãªã„ãŸã‚ã€rootã«`modules`ã‚’é…ç½®ã—ã€**ç’°å¢ƒå›ºæœ‰ã®ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª`(environments/{env})`ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆ†å‰²**ã—ã¦ã„ã¾ã™ã€‚

```bash
.
â””â”€â”€ terraform
    â”œâ”€â”€ environments
    â”‚   â”œâ”€â”€ dev
    â”‚   â”œâ”€â”€ prod
    â”‚   â””â”€â”€ stage
    â””â”€â”€ modules
        â””â”€â”€ gcp
            â”œâ”€â”€ xxx
            â””â”€â”€ yyy
```

åŸºæœ¬çš„ã«ã¯ã€Google CloudãŒæ¨å¥¨ã™ã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã£ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚
https://cloud.google.com/docs/terraform/best-practices-for-terraform?hl=ja#subdirectories

ã“ã®æ–¹æ³•ã ã¨ã€å˜ä¸€ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ã®ç®¡ç†ã¯ç°¡å˜ã§ã™ãŒã€å°†æ¥çš„ã«ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰å±•é–‹ã‚’è¡Œã†å ´åˆã€ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãŒç•°ãªã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã”ã¨ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ‰±ã†éš›ã®**Stateç®¡ç†**ãŒèª²é¡Œã«ãªã‚‹ã¨æ€ã£ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€**k8sã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆç®¡ç†ã«ã¯`Kustomize`ã‚’ä½¿ç”¨**ã—ã€ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã”ã¨ã«ï¼ˆä¾‹: APIã€DB Migrationç”¨ã®Jobãªã©ï¼‰ã‚·ãƒ³ãƒ—ãƒ«ã«åˆ†å‰²ã—ã¦ã„ã¾ã™ã€‚

```bash
.
â””â”€â”€ manifests
    â”œâ”€â”€ argocd
    â”‚   â”œâ”€â”€ base
    â”‚   â””â”€â”€ overlays
    â”‚       â”œâ”€â”€ dev
    â”‚       â”œâ”€â”€ prod
    â”‚       â””â”€â”€ stage
    â””â”€â”€ app1
        â”œâ”€â”€ base
        â””â”€â”€ overlays
            â”œâ”€â”€ dev
            â”œâ”€â”€ prod
            â””â”€â”€ stage
```

ç‰¹ç­†ã™ã‚‹ç‚¹ã¯ã‚ã¾ã‚Šãªã„ã§ã™ãŒã€CRDã¨ã—ã¦**ExternalSecretOperatorã‚’ä½¿ç”¨ã—ã¦Secretã®ç®¡ç†**ã‚’è¡Œã„ã€**ArgoCDã‚’æ´»ç”¨ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤**ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

![alt text](/images/aiworkerv2/2.png)

---
#### 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¿®æ­£

Google Cloudç’°å¢ƒã§ã‚‚Azureç’°å¢ƒã¨åŒæ§˜ã®å‹•ä½œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä¿®æ­£ã‚’è¡Œã„ã¾ã—ãŸã€‚
å¹¸ã„ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’é€šã˜ã¦æŠ½è±¡åŒ–ã—ã¦ã„ãŸãŸã‚ã€ã‚¤ãƒ³ãƒ•ãƒ©å±¤ã®å®Ÿè£…éƒ¨åˆ†ã‚’ä¿®æ­£ã™ã‚‹ã ã‘ã§å®Œäº†ã—ã¾ã—ãŸã€‚

```ts:interface-example.ts
interface IStorageClient {
  retrieveBlob(params: RetrieveBlobParams): Promise<Result<Buffer>>
  uploadBlobsInBatch(params: UploadBlobBatchParams): Promise<Result<void>>
  deleteBlobsInBatch(params: DeleteBlobParams): Promise<Result<void>>
  generatePresignedUrls(
    params: GeneratePresignedUrlsParams
  ): Promise<Result<GetPresignedUrlsResponse>>
}
```

---
#### 4. CI/CDã®ä¿®æ­£

å¼Šç¤¾ã§ã¯**GitHub Actionsã‚’ä½¿ç”¨ã—ã¦CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰**ã—ã¦ã„ã¾ã™ã€‚Azureå‘ã‘ã«ãƒ“ãƒ«ãƒ‰ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’Azure Container Registryã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã€Rolloutã—ã¦ã„ã¾ã—ãŸãŒã€Google Cloudã¸ã®ç§»è¡Œã«ä¼´ã„ã€Artifact Registryã«ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

```yaml:sample.yaml
name: 'Deploy to GKE'
description: 'Composite action to deploy to GKE'
inputs:
   #  ....

runs:
  using: 'composite'
  steps:
    - name: Get Bun version
      id: get_bun_version
      shell: bash
      run: echo "BUN_VERSION=$(grep 'bun = ' .prototools | cut -d '"' -f 2)" >> $GITHUB_ENV

    - name: Authorize Docker
      shell: bash
      run: gcloud auth configure-docker ${{ inputs.artifact_repository }} --quiet

    - name: Build and push Docker image to Artifact Registry
      shell: bash
      run: |
        IMAGE_TAG=$(git rev-parse --short "$GITHUB_SHA")
        docker build --target ${{ inputs.target }} --build-arg BUN_VERSION=${{ env.BUN_VERSION }} -t ${{ inputs.artifact_repository }}/${{ inputs.gcp_project }}/${{ inputs.repository_name }}/${{ inputs.image_name }}:${{ inputs.image_tag }} -f ${{ inputs.dockerfile }} .
        docker tag ${{ inputs.artifact_repository }}/${{ inputs.gcp_project }}/${{ inputs.repository_name }}/${{ inputs.image_name }}:${{ inputs.image_tag }} ${{ inputs.artifact_repository }}/${{ inputs.gcp_project }}/${{ inputs.repository_name }}/${{ inputs.image_name }}:latest
        docker push ${{ inputs.artifact_repository }}/${{ inputs.gcp_project }}/${{ inputs.repository_name }}/${{ inputs.image_name }}:${{ inputs.image_tag }}
      working-directory: ${{ inputs.working_directory }}
```

è¤‡æ•°ã®ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚’ä¸¦åˆ—ã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã«ã€**Composite Action**ã«åˆ‡ã‚Šå‡ºã—ã€åˆ©ç”¨å´ã§matrixã‚’æŒ‡å®šã—ã¦ä¸¦åˆ—å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚


```yaml:sample.yaml
  gke-deploy-dev:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: generate-image-tag
    strategy:
      matrix:
        include:
          - image_name: app1
            target: app1
            directory: packages/xxx
          - image_name: app2
            target: app2
            directory: packages/yyy

    permissions:
      contents: "read"
      id-token: "write"
    environment: Development
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
      - uses: ./.github/actions/gcloud-setup
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GHA_SERVICE_ACCOUNT }}
      - uses: ./.github/actions/deploy-to-gke
        with:
          image_name: ${{ matrix.image_name }}
          image_tag: ${{ needs.generate-image-tag.outputs.image_tag }}
          target: ${{ matrix.target }}
          working_directory: ${{ github.workspace }}/${{ matrix.directory }}
        #   ...
```

åŸºæœ¬çš„ã«CI/CDç”¨ã«Workload Identityã‚’å‰²ã‚Šå½“ã¦æœ€å°æ¨©é™ã®åŸå‰‡ã«å¾“ã„ã€Service Accountã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
:::message
ç¾åœ¨ã ã¨`Direct Workload Identity Federation`ã¨ã„ã†æ©Ÿèƒ½ãŒä½¿ç”¨ã§ãã€Service Accountã‚’ä½¿ç”¨ã›ãšã«ç›´æ¥èªè¨¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ã®ã§ã€ã“ã¡ã‚‰ã‚’ä½¿ã†ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚
https://github.com/google-github-actions/auth/releases/tag/v2.0.0
:::

---
### k8sãƒªã‚½ãƒ¼ã‚¹ã‚’ArgoCDã§ç®¡ç†

Google Cloudã¸ã®å±•é–‹ã«éš›ã—ã€k8sä¸Šã«ãƒªã‚½ãƒ¼ã‚¹ã‚’æ§‹ç¯‰ã—ã¾ã—ãŸã€‚å¼Šç¤¾ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ—¢å­˜ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã§**Namespace**ã‚’åˆ†ã‘ã¦é‹ç”¨ã—ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€ArgoCDã§ã¯Projectã”ã¨ã«Namespaceã‚’ç®¡ç†ã—ã€ç‰¹å®šã®Namespaceã«å¯¾ã™ã‚‹æ“ä½œæ¨©é™ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã§ã€ãƒªã‚½ãƒ¼ã‚¹ã‚’è«–ç†çš„ã«åŒºåˆ†ã—ã¦ã„ã¾ã™ã€‚

![alt text](/images/aiworkerv2/3.png)

ã•ã‚‰ã«ã€ArgoCDã®Applicationç®¡ç†ã«ã¯**ApplicationSet**ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
https://argo-cd.readthedocs.io/en/stable/user-guide/application-set/

devç’°å¢ƒã§ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé »ç¹ã«è¡Œã‚ã‚Œã€çŸ­æ™‚é–“ã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ãŒè¨±å®¹ã•ã‚Œã‚‹ãŸã‚ã€AutoSyncã‚’æœ‰åŠ¹åŒ–ã—ã¦ãƒªã‚½ãƒ¼ã‚¹ã®åŒæœŸã‚’è‡ªå‹•åŒ–ã—ã¦ã„ã¾ã™ã€‚

```yaml:sample.yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: hoge-namespace-dev-application-set
spec:
  generators:
    - list:
        elements:
          - path: app1

  template:
    metadata:
      name: '{{path}}-dev'
      namespace: default
    spec:
      source:
        path: deployment/k8s/manifests/{{path}}/overlays/dev
        repoURL: xxx
        targetRevision: development
      destination:
        namespace: hoge-namespace
        server: xxx
      project: 'hoge-namespace-dev'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ã®è‡ªå‹•åŒ–ã«ã¤ã„ã¦

ã‚‚ã¨ã‚‚ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯**latestã‚¿ã‚°**ã‚’ä½¿ç”¨ã—ã¦é‹ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€éšœå®³æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚„ãƒªã‚½ãƒ¼ã‚¹ã®çŠ¶æ…‹ç¢ºèªãŒé›£ã—ã‹ã£ãŸãŸã‚ã€ã‚¿ã‚°ã‚’å›ºå®šã™ã‚‹æ–¹å¼ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

ç¾åœ¨ã¯ã€**GitHub Actionsã‚’ä½¿ç”¨ã—ã¦ã‚¿ã‚°ã‚’æ›´æ–°**ã—ã€**è‡ªå‹•çš„ã«Pull Requestã‚’ä½œæˆã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å°å…¥**ã™ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå®¹æ˜“ã«ãªã‚‹ã‚ˆã†æ§‹æˆã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ArgoCDãŒè‡ªå‹•çš„ã«Rolloutã‚’å®Ÿè¡Œã§ãã€æŸ”è»Ÿãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ãƒ­ãƒ¼ã«å¯¾å¿œå¯èƒ½ã§ã™ã€‚

![alt text](/images/aiworkerv2/4.png)

:::message
ArgoCDã«ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è‡ªå‹•çš„ã«æ›´æ–°ã§ãã‚‹**Image Updater**ã¨ã„ã†æ‹¡å¼µãƒ„ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚CI/CDã«ä½™è¨ˆãªæ¨©é™ã‚’æŒãŸã›ã‚‹å¿…è¦ãŒãªã„ãŸã‚ã€ç‰¹æ®µã®ç†ç”±ãŒãªã„é™ã‚Šã€ã“ã®ãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
https://argocd-image-updater.readthedocs.io/en/stable/
https://zenn.dev/aishift/articles/3fdc453bb36679
:::

### Organization Repositoryã«ãŠã‘ã‚‹è‡ªå‹•ãƒãƒ¼ã‚¸

å¼Šãƒãƒ¼ãƒ ã§ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒªãƒªãƒ¼ã‚¹ãƒ•ãƒ­ãƒ¼ã«**Git Flow**ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ãã®éç¨‹ã§ã€ä¾‹ãˆã°`developmentãƒ–ãƒ©ãƒ³ãƒ`ã‹ã‚‰`stagingãƒ–ãƒ©ãƒ³ãƒ`ã¸ã®ãƒãƒ¼ã‚¸ã‚’è¡Œã†éš›ã«ã€ä»¥ä¸‹ã®2ã¤ã®ä½œæ¥­ã‚’è‡ªå‹•åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

1. **ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒèµ·ããªã„ã‚ˆã†ã«ãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆã‚’ç©ã¿ã€ãƒãƒ¼ã‚¸ã‚’è¡Œã†**
2. **è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹**

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€**GitHub Apps**ã‚’å°å…¥ã—ã¾ã—ãŸã€‚

#### ãªãœGitHub AppsãŒå¿…è¦ã‹
GitHubã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§`GITHUB_TOKEN`ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæä¾›ã•ã‚Œã¦ãŠã‚Šã€ã“ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¦GitHub Actionsã§è‡ªå‹•ãƒãƒ¼ã‚¸ãŒå¯èƒ½ã§ã™ã€‚ã—ã‹ã—ã€`GITHUB_TOKEN`ã‚’ä½¿ç”¨ã—ãŸã‚¿ã‚¹ã‚¯ã§ã¯ã€å†å¸°çš„ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒˆãƒªã‚¬ãƒ¼ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™ã€‚

ãã®ãŸã‚ã€GitHub Appsã‚’ä½œæˆã—ã€ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’è¡Œã„ã€æ¬¡ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
https://docs.github.com/ja/enterprise-cloud@latest/apps/creating-github-apps/authenticating-with-a-github-app/making-authenticated-api-requests-with-a-github-app-in-a-github-actions-workflow

:::message alert
PATï¼ˆPersonal Access Tokenï¼‰ã‚’åˆ©ç”¨ã—ã¦ã‚‚åŒæ§˜ã®å‡¦ç†ãŒå¯èƒ½ã§ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã‚’æŒã¤ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã®ã§ã€GitHub Appsã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
:::

GitHub Appsã‚’çµ„ç¹”ã«å°å…¥å¾Œã€å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€GitHub Appsã‚’ä½¿ç”¨ã—ãŸãƒãƒ¼ã‚¸ãŒå¯èƒ½ã§ã™ã€‚

```yaml:sample.yaml
name: Auto Merge

on:
  pull_request:
    branches:
      - development

permissions:
  pull-requests: write

jobs:
  auto-merger-dev:
    runs-on: ubuntu-latest
    if: ${{ github.head_ref == 'staging' || github.head_ref == 'main' }}
    steps:
      - name: generate access token
        id: create
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.TEST_APP_ID }}
          private-key: ${{ secrets.TEST_APP_PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: staging
          token: ${{ steps.create.outputs.token }}
      - name: Auto-merge
        run: gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{github.event.pull_request.html_url}}
          GH_TOKEN: ${{ steps.create.outputs.token }} # <- ã“ã“
```

GitHub Actionsã‹ã‚‰è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’è¡Œã„ã€ä»–ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãŸã‚ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯å¤šå°‘æ‰‹é–“ãŒã‹ã‹ã‚Šã¾ã™ãŒã€ä¸€åº¦å°å…¥ã™ã‚Œã°éå¸¸ã«ä¾¿åˆ©ã§ã™ã€‚

:::message alert
ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®Actionsã¯ã§ãã‚‹ã ã‘é¿ã‘ã€ä½¿ç”¨ã™ã‚‹å ´åˆã¯Verified Creatorã®Actionsã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
ä»Šå›ã®ä¾‹ã§ã‚‚ã€Verified Creatorã®Actionsã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
https://github.com/marketplace/actions/create-github-app-token

ã¾ãŸã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã™ã‚‹ãŸã‚ã«ã€ä½¿ç”¨ã™ã‚‹Actionsã¯å¯èƒ½ã§ã‚ã‚Œã°**Full Change Hash**ã§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›ºå®šã—ã¦ãŠãã“ã¨ãŒæœ›ã¾ã—ã„ã§ã™ã€‚
:::

### è¨¼æ˜æ›¸ã®ç®¡ç†

å¼Šãƒãƒ¼ãƒ ã§ã¯**DNSã‚’Cloudflare**ã€**è¨¼æ˜æ›¸ã‚’Google Managed Certificate**ã§ç®¡ç†ã—ã¦ã„ã¾ã™ã€‚**ç¾æ™‚ç‚¹ã§ã¯ã€Cloudflareã§DNSç®¡ç†ã®ã¿ã‚’è¡Œã„ã€Proxyãƒ¢ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ã€‚** æœ€çµ‚çš„ã«ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚ˆã‚Šã‚»ã‚­ãƒ¥ã‚¢ã«ã™ã‚‹ãŸã‚ã«Proxyãƒ¢ãƒ¼ãƒ‰ã®ä½¿ç”¨ãŒæœ›ã¾ã—ã„ã§ã™ãŒã€Ingresså‘¨ã‚Šã®æ§‹æˆã‚’å¤§å¹…ã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ç¾çŠ¶ã¯DNSã®ã¿ã§ã®é‹ç”¨ã‚’ç¶šã‘ã¦ã„ã¾ã™ã€‚

![alt text](/images/aiworkerv2/5.png)

:::message
Proxyãƒ¢ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€DNSãƒªã‚¾ãƒ«ãƒãƒ¼ã«ã‚ˆã‚‹åå‰è§£æ±ºã®çµæœã¨ã—ã¦Cloudflareã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿œç­”ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚(CloudflareãŒHTTP(S)ã®çµ‚ç«¯ã«ãªã‚‹)
https://zenn.dev/kameoncloud/articles/6dec28de015f6f
:::

ã¾ãŸã€DNSãƒ¬ã‚³ãƒ¼ãƒ‰è‡ªä½“ã‚‚ç¾çŠ¶ã¯æ‰‹å‹•ç®¡ç†ã¨ãªã£ã¦ã—ã¾ã£ã¦ã„ã‚‹ã®ã§`External DNS`ã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•çš„ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‹•çš„ã«ç®¡ç†ã§ãã‚‹ã‚ˆã†ã«ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚
https://github.com/kubernetes-sigs/external-dns

---

### ãƒ­ã‚®ãƒ³ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®æ”¹å–„ã¨èª²é¡Œ

æ­£ç›´ãªã¨ã“ã‚ã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã«ã¯ã¾ã å¤šãã®æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚ç¾çŠ¶ã€å„ãƒãƒ¼ãƒ ã§ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®å–ã‚Šçµ„ã¿ãŒç•°ãªã‚‹ãŸã‚ã€çµ±ä¸€ã—ãŸã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒå¿…è¦ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

å¼Šãƒãƒ¼ãƒ ã§ã¯ã€Google Cloud Observabilityã‚’åŸºã«æœ€ä½é™ã®ãƒ­ã‚°åé›†ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
https://cloud.google.com/stackdriver/docs?hl=ja

### æ§‹é€ åŒ–ãƒ­ã‚®ãƒ³ã‚°ã¨tslog

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã€`tslog`ã‚’ä½¿ç”¨ã—ã¦æ§‹é€ åŒ–ãƒ­ã‚®ãƒ³ã‚°ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
`pino`ã‚„`winston`ã¨ã¯ç•°ãªã‚Šã€TypeScriptã§è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å•é¡Œç™ºç”Ÿæ™‚ã®æœ¬å®¶ã®ã‚³ãƒ¼ãƒ‰ã®è¿½è·¡ãŒå®¹æ˜“ã§ã‚ã‚Šã€ãƒ­ã‚°ãƒã‚¹ã‚­ãƒ³ã‚°ç­‰ã‚‚ç°¡å˜ã«è¡Œãˆã‚‹ç‚¹ãŒåˆ©ç‚¹ã§ã™ã€‚
https://tslog.js.org/

ã•ã¦ã€ç¾çŠ¶ãƒ­ã‚°åŸºç›¤ã¯Google Cloud Loggingã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€ã“ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ç‰¹å®šã®JSONãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå®šç¾©ã•ã‚Œã¦ãŠã‚Šã€ãã‚Œã«å¾“ã„ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã“ã¨ã§UIä¸Šã®ãƒ­ã‚°ã®è¦–èªæ€§ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚
https://cloud.google.com/logging/docs/structured-logging?hl=ja

![alt text](/images/aiworkerv2/9.png)

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã¯ã€Cloud Providerã«å¿œã˜ã¦ãƒ­ã‚°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã„ã¾ã™ã€‚

```ts:example.ts
interface CustomLogger {
  debug(logObj: InputLogObject): void
  info(logObj: InputLogObject): void
  warn(logObj: InputLogObject): void
  error(logObj: InputLogObject): void
}

interface InputLogObject {
  message: string
  labels?: { [key: string]: string }
  stackTrace?: string
  [key: string]: unknown
}

interface FormattedLogObject {
  message: string
  severity: string
  time: string // RFC3339
  requestId: string
  stack_trace?: string // Error stack trace
}

const createLoggerConfig = (env: LogEnv) =>
  ({
    name: 'app',
    type: env.LOG_TYPE,
    minLevel: env.LOG_MINLEVEL,
    hideLogPositionForProduction: env.LOG_HIDE_POSITION,
  }) satisfies ISettingsParam<FormattedLogObject>

class AppLogger implements CustomLogger {
  private loggerInstance: TSLogger<FormattedLogObject>
  private requestId: string

  constructor(opts: { env: LogEnv; requestId: string }) {
    const loggerConfig = createLoggerConfig(opts.env)
    this.loggerInstance = new TSLogger(loggerConfig)
    this.requestId = opts?.requestId || ''
  }

  private formatLogObject(inputLogObj: InputLogObject, severity: string): FormattedLogObject {
    return {
      ...inputLogObj,
      severity,
      time: getCurrentUTCDate().toISOString(),
      requestId: this.requestId,
      stack_trace: inputLogObj.stackTrace,
    }
  }

  debug(logObj: InputLogObject): void {
    const formattedLogObject = this.formatLogObject(logObj, 'DEBUG')
    this.loggerInstance.debug(formattedLogObject)
  }

  info(logObj: InputLogObject): void {
    const formattedLogObject = this.formatLogObject(logObj, 'INFO')
    this.loggerInstance.info(formattedLogObject)
  }

  warn(logObj: InputLogObject): void {
    const formattedLogObject = this.formatLogObject(logObj, 'WARNING')
    this.loggerInstance.warn(formattedLogObject)
  }

  error(logObj: InputLogObject): void {
    const formattedLogObject = this.formatLogObject(logObj, 'ERROR')
    this.loggerInstance.error(formattedLogObject)
  }
}
```

ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã¯ã€ç‰¹å®šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«é–¢é€£ã™ã‚‹ãƒ­ã‚°ã‚’ä¸€æ‹¬ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«ã€**ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’Loggerã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ**ã«å«ã‚ã¦ã„ã¾ã™ã€‚

å¼Šãƒãƒ¼ãƒ ã§ã¯ã€Webãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«`Hono`ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€middlewareã‚’æ´»ç”¨ã—ã¦Loggerã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’ä»˜ä¸ã—ã€Contextã§å¼•ãå›ã—ã¦ã„ã¾ã™ã€‚
https://zenn.dev/aishift/articles/a3dc8dcaac6bfa#%E6%A7%8B%E9%80%A0%E5%8C%96%E3%83%AD%E3%82%AE%E3%83%B3%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6

ã“ã®Contextã¯ä»Šã¾ã§å„å‡¦ç†ã«ä¼æ¬ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸãŒã€**Hono v4.6.0ã§è¿½åŠ ã•ã‚ŒãŸ`Context Storage Middleware`ã‚’åˆ©ç”¨**ã™ã‚‹ã“ã¨ã§ã€Contextã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
https://hono.dev/docs/middleware/builtin/context-storage

:::message
`Context Storage Middleware`ã¯å†…éƒ¨çš„ã«`AsyncLocalStorage`ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
`AsyncLocalStorage`ã¯éæ¨™æº–APIã§ã¯ã‚ã‚Šã¾ã™ãŒã€Node.jsã€Cloudflare Workersã€Denoã€Bunã¨ã„ã£ãŸä¸»è¦ãªãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§æ—¢ã«å®Ÿè£…ã•ã‚Œã¦ãŠã‚Šã€å°†æ¥çš„ã«ã¯æ¨™æº–åŒ–ãŒæœŸå¾…ã•ã‚Œã‚‹APIã§ã™ã€‚
https://github.com/orgs/honojs/discussions/3409
:::

ã“ã®Contextã«Loggerã‚’è©°ã‚è¾¼ã‚€ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ä¸€æ„ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDã‚’ä»˜ä¸ã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«Loggerã‚’åˆ©ç”¨å¯èƒ½ã«ã—ã¦ã„ã¾ã™ã€‚

## ãƒªã‚½ãƒ¼ã‚¹ã®æœ€é©åŒ– (Memory)

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ç¨‹åº¦å®Œæˆã™ã‚‹ã¨ã€æ¬¡ã«å¿…è¦ãªã®ã¯ãƒªã‚½ãƒ¼ã‚¹ã®æœ€é©åŒ–ã§ã™ã€‚é‹ç”¨ä¸Šç‰¹ã«å•é¡Œã¨ãªã£ãŸã®ã¯ä»¥ä¸‹ã®2ç‚¹ã§ã—ãŸã€‚

1. **ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒé«˜ã„**
2. **ç‰¹å®šã®APIã‚’å©ã„ãŸéš›ã«CPUã¨MemoryãŒæ€¥ä¸Šæ˜‡ã™ã‚‹**

### 1. ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒé«˜ã„

ã“ã®å•é¡Œã®åŸå› ã¯ã€ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãŒå¤§ãã™ãã‚‹ã“ã¨ã§ã—ãŸã€‚ãã®ãŸã‚ã€æ„šç›´ã«ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã®è¦‹ç›´ã—ã‚„ã€ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®æ”¹å–„ã‚’è¡Œã„ã¾ã—ãŸã€‚

```Dockerfile:sample
ARG BUN_VERSION
FROM oven/bun:${BUN_VERSION} as builder
WORKDIR /app
COPY . .
RUN bun install --production --frozen-lockfile
RUN bun build --entrypoints cmd/server/index.ts --target bun --outdir ./out/server

FROM oven/bun:${BUN_VERSION}-slim AS app
ENV TINI_VERSION v0.19.0
ADD https://github.com/krallin/tini/releases/download/${TINI_VERSION}/tini /tini
RUN chmod +x /tini
COPY --from=builder --chown=nonroot:nonroot /app/node_modules/tiktoken/tiktoken_bg.wasm /app/node_modules/tiktoken/tiktoken_bg.wasm
COPY --from=builder --chown=nonroot:nonroot /app/out/server /app
ENV NODE_ENV=production \
  TZ=UTC
EXPOSE 3000
ENTRYPOINT ["/tini", "--"]
CMD ["bun", "/app/index.js"]
```

ã¾ãŸã€**Node.jsåŒæ§˜ã€`PID1`å•é¡ŒãŒå­˜åœ¨ã™ã‚‹ãŸã‚ã€`tini`ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ–ãƒ—ãƒ­ã‚»ã‚¹ã®ç®¡ç†**ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
https://github.com/nodejs/docker-node/blob/main/docs/BestPractices.md#handling-kernel-signals

ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚µã‚¤ã‚ºã‚’å‰Šæ¸›ã§ãã¾ã—ãŸãŒã€ãã‚‚ãã‚‚Bunã¯Node.jsã«æ¯”ã¹ã¦ã€HTTPã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒé«˜ãã€ã¾ãŸ`Testcontainers`ãªã©é–‹ç™ºä¸Šæœ‰ç”¨ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå‹•ä½œã—ãªã„ãªã©åˆ¶ç´„ãŒå¤šã„ãŸã‚ã€ã„ãšã‚ŒNode.jsã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ï¼ˆå€‹äººçš„ãªæ„è¦‹ï¼‰ã€‚

### 2. ç‰¹å®šã®APIã‚’å©ã„ãŸéš›ã«CPUã¨MemoryãŒæ€¥ä¸Šæ˜‡ã™ã‚‹

AIé–¢é€£ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹ç™ºã™ã‚‹ä¸­ã§ã€ç‰¹å®šã®LLMãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹éš›ã«ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡ã‚’è¨ˆç®—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã®éš›ã€`TikToken`ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

https://github.com/dqbd/tiktoken

ã“ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒç”Ÿæˆã™ã‚‹**Tiktokenã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ**ã®ã‚µã‚¤ã‚ºãŒéå¸¸ã«å¤§ããã€ä½¿ç”¨ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ã”ã¨ã«`gpt-4o`ã‚„`gpt-4o-mini`ã¨ã„ã£ãŸç•°ãªã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ãŒæ€¥å¢—ã™ã‚‹åŸå› ã¨ãªã£ã¦ã„ã¾ã—ãŸã€‚

ã“ã®å•é¡Œã®æ ¹æœ¬è§£æ±ºã¯é›£ã—ã„ãŸã‚ã€ä¸å¿…è¦ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆã‚’æŠ‘ãˆã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã®è¨­è¨ˆã‚„ã€å…¨ä½“çš„ãªã‚µãƒ¼ãƒ“ã‚¹è¨­è¨ˆã‚’è¦‹ç›´ã—ã€Tiktokenã‚’ä½¿ç”¨ã™ã‚‹è²¬å‹™ã‚’ç‰¹å®šã®ã‚µãƒ¼ãƒ“ã‚¹ã«å§”è­²ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ã€‚

## DevOps
### ã‚¤ãƒ³ãƒ•ãƒ©å‘¨ã‚Šã®Linterã®å°å…¥

å¼Šãƒãƒ¼ãƒ ã§ã¯ã€**1ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€ã‚¤ãƒ³ãƒ•ãƒ©ã®ã‚³ãƒ¼ãƒ‰ãŒæ··åœ¨ã—ã¦ã„ã¾ã™ã€‚** ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‘¨ã‚Šã®ã‚³ãƒ¼ãƒ‰ã¯`Biome`ã‚’ä½¿ç”¨ã—ã¦çµ±ä¸€çš„ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¨Lintã‚’è¡Œã£ã¦ã„ã¾ã™ãŒã€ã‚¤ãƒ³ãƒ•ãƒ©ã«é–¢ã—ã¦ã¯æ‰‹å‹•ãƒã‚§ãƒƒã‚¯ãŒå¤šã‹ã£ãŸãŸã‚ã€`Terraform Linter`ã®å°å…¥ã‚’è¡Œã„ã¾ã—ãŸã€‚

Terraformã®ãƒã‚§ãƒƒã‚¯ã¯ã€PRä½œæˆæ™‚ã«ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§è¡Œã£ã¦ã„ã¾ã™ã€‚

- `terraform fmt -check -recursive`
- `terraform validate -no-color`
- `terraform plan`

å°†æ¥çš„ã«ã¯`tflint`ã‚’å°å…¥ã—ã€ã‚ˆã‚Šå³å¯†ãªãƒã‚§ãƒƒã‚¯ã‚’è¡Œã„ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«æ²¿ã£ãŸé‹ç”¨ã‚’ç›®æŒ‡ã—ã¦ã„ã¾ã™ã€‚
https://developer.hashicorp.com/terraform/language/style

k8sã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã«é–¢ã—ã¦ã¯ã€`kustomize build`ã‚’å®Ÿè¡Œã—ã€æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ã®ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚å°†æ¥çš„ã«ã¯`kubeconform`ã‚’å°å…¥ã—ã€ã‚¹ã‚­ãƒ¼ãƒãƒã‚§ãƒƒã‚¯ã‚‚è¡Œãˆã‚‹ç’°å¢ƒã®æ§‹ç¯‰ã‚’è€ƒãˆã¦ã„ã¾ã™ã€‚
https://github.com/yannh/kubeconform

### Renovateã®å°å…¥

**ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è‡ªå‹•æ›´æ–°ã‚’è¡Œã†ãŸã‚ã«`Renovate`ã‚’å°å…¥**ã—ã¾ã—ãŸã€‚ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®å‘¨æœŸãŒç•°ãªã‚‹ãŸã‚ã€`Dependabot`ãªã©ã¨æ¯”ã¹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å˜ä½ã®ç´°ã‹ãªè¨­å®šãŒã§ãã€ã•ã‚‰ã«Bunã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚ã€Renovateã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚
https://docs.renovatebot.com/modules/manager/bun/

#### `yarn.lock`ãŒæ›´æ–°ã•ã‚Œãªã„å•é¡Œ

Bunã§ã¯ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«`bun.lockb`ã¨`yarn.lock`ã®ä¸¡æ–¹ã‚’ç”Ÿæˆã§ãã¾ã™ãŒã€Renovateã§ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’æ›´æ–°ã™ã‚‹éš›ã€`yarn.lock`ãŒæ›´æ–°ã•ã‚Œãªã„ã¨ã„ã†å•é¡Œ(ä»•æ§˜)ãŒã‚ã‚Šã¾ã—ãŸã€‚
https://github.com/renovatebot/renovate/issues/20065#issuecomment-1712582023

ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€RenovateãŒç”Ÿæˆã—ãŸPRã«å¯¾ã—ã¦`yarn.lock`ã‚’æ›´æ–°ã™ã‚‹CIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’çµ„ã¿è¾¼ã¿ã€å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚


## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### Cloudflare Accessã¨Clerkã®å°å…¥

**é–‹ç™ºç’°å¢ƒã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯`Cloudflare Access`ã‚’å°å…¥**ã—ã€ç¤¾å†…ç’°å¢ƒã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã®ã¿ã‚’è¨±å¯ã—ã¦ã„ã¾ã™ã€‚

![alt text](/images/aiworkerv2/6.png)

Cloudflare Accessã¯ã€è¤‡æ•°ã®IdPã¨ã®çµ±åˆãŒå¯èƒ½ã§ã€50äººã¾ã§ã¯ç„¡æ–™ã§åˆ©ç”¨ã§ãã¾ã™ã€‚
https://developers.cloudflare.com/cloudflare-one/identity/idp-integration/

ã¾ãŸã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã®èªè¨¼æ©Ÿèƒ½ã¨ã—ã¦ã€**ç¤¾å†…ç’°å¢ƒ**ã§ã¯`Clerk`ã‚’IdPã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
åŸºæœ¬çš„ã«ã¯ClerkãŒæä¾›ã™ã‚‹ä¸€èˆ¬çš„ãªèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãŠã‚Šã€**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰-ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–“ã®Cross-Originãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦ã¯ã€æ‰‹å‹•ã§JWTã®æ¤œè¨¼**ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚
https://clerk.com/docs/backend-requests/handling/manual-jwt

![alt text](/images/aiworkerv2/7.png)

ã“ã®ãƒ•ãƒ­ãƒ¼ã§ä½¿ç”¨ã•ã‚Œã‚‹[Session Tokens](https://clerk.com/docs/backend-requests/resources/session-tokens)ã¯ã€**RS256ã§ç½²åã•ã‚ŒãŸéå¯¾ç§°ãƒˆãƒ¼ã‚¯ãƒ³å½¢å¼ã®JWT**ã§ã™ã€‚ãã®ãŸã‚JWKã‚’å–å¾—ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
æ¤œè¨¼è‡ªä½“ã¯ClerkãŒBackendã®SDKã‚’æä¾›ã—ã¦ã„ã‚‹ãŸã‚ãã®æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚
https://clerk.com/docs/references/backend/overview

è‡ªå‰å®Ÿè£…ã™ã‚‹å ´åˆã¯`jose`ç­‰ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’çµ„ã¿åˆã‚ã›ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚
https://zenn.dev/aishift/articles/a3dc8dcaac6bfa#jwt

### SAML Federation

Clerkã¯Enterpriseå‘ã‘ã®é€£æºã¨ã—ã¦**SAML Federationã‚’ã‚µãƒãƒ¼ãƒˆ**ã—ã¦ã„ã¾ã™ï¼ˆProãƒ—ãƒ©ãƒ³ãŠã‚ˆã³è¿½åŠ ã®PluginãŒå¿…è¦ï¼‰ã€‚
https://clerk.com/docs/authentication/saml/overview

å¼Šãƒãƒ¼ãƒ ã§ã¯`SP-initiated`ã§ã®SSOã‚’æ¡ç”¨ã—ã€ç¤¾å†…ã®èªè¨¼åŸºç›¤ã¨ã®é€£æºãŒå¯èƒ½ã¨ãªã£ã¦ã„ã¾ã™ã€‚
Connectionã®è¨­å®šã‚’è¡Œã†ä¸Šã§å€‹äººçš„ã«ä¾¿åˆ©ã ã¨æ„Ÿã˜ãŸã®ã¯ã€**Identity Providerã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è¨­å®šãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ç°¡å˜ã«è¡Œãˆã‚‹ç‚¹**ã§ã™ã€‚Auth0ãªã©ã¨æ¯”è¼ƒã—ã¦ã‚‚è¨­å®šãŒéå¸¸ã«ç°¡å˜ã ã¨æ„Ÿã˜ã¾ã—ãŸã€‚

![alt text](/images/aiworkerv2/8.png)

SAMLæ¤œè¨¼ã®æ®µéšã§ã¯`Mock SAML`ã‚’ä½¿ç”¨ã—ã¦å‹•ä½œç¢ºèªã‚’è¡Œã£ã¦ã„ã¾ã—ãŸã€‚
https://mocksaml.com/

### Clerkã®åˆ¶ç´„

Clerkã¯ã€1ãƒ†ãƒŠãƒ³ãƒˆã«åã¾ã‚‹ç¯„å›²ã§ã®èªè¨¼æ©Ÿèƒ½ãŒå……å®Ÿã—ã¦ã„ã¾ã™ãŒã€**ãƒ“ã‚¸ãƒã‚¹ä¸Šã®åˆ©ç”¨ã«ãŠã„ã¦ã¯ä»¥ä¸‹ã®ç‚¹ã§åˆ¶ç´„**ãŒã‚ã‚Šã¾ã™ã€‚

#### ãƒ‡ãƒ¼ã‚¿ã®ä¿ç®¡å ´æ‰€
Clerkã®Privacy Policyã«ã‚ˆã‚‹ã¨ã€ãƒ‡ãƒ¼ã‚¿ã¯ç±³å›½ã‚„ãã®ä»–ã®å›½ã«è»¢é€ãƒ»ä¿å­˜ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã€æ—¥æœ¬å›½å†…ã§ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜è¦ä»¶ã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚

> All information processed by us may be transferred, processed, and stored anywhere in the world, including, but not limited to, the United States or other countries, which may have data protection laws that are different from the laws where you live. We endeavor to safeguard your information consistent with the requirements of applicable laws.
https://clerk.com/legal/privacy

#### ç›£æŸ»ãƒ­ã‚°ã®å–å¾—
ç¾çŠ¶ã€Clerkã¯ç›£æŸ»ãƒ­ã‚°ã‚’ä¿æŒã—ã¦ã„ã¾ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã§ç¢ºèªã™ã‚‹æ‰‹æ®µã¯æä¾›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä»Šå¾Œã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã«ã¯å«ã¾ã‚Œã¦ã„ã¾ã™ãŒã€å®Ÿè£…ã«ã¯ã¾ã æ™‚é–“ãŒã‹ã‹ã‚Šãã†ã§ã™ã€‚

Clerkã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã¯ä»¥ä¸‹ã§ç¢ºèªã§ãã¾ã™ã€‚åˆ©ç”¨ã‚’æ¤œè¨ã—ã¦ã„ã‚‹æ–¹ã¯å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
https://feedback.clerk.com/roadmap

---

## ãã®ä»–å–ã‚Šçµ„ã¿
https://zenn.dev/aishift/articles/f82ec60b1762a0
https://zenn.dev/aishift/articles/1df36e912eb271

---

## ã¾ã¨ã‚

åŠå¹´é–“ã®æ”¹å–„ã®å–ã‚Šçµ„ã¿ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚å…¬é–‹ãŒé›£ã—ã„å†…å®¹ã‚‚å¤šãã€ä¸€éƒ¨ã®ã¿ã®å…¬é–‹ã¨ãªã‚Šã¾ã—ãŸãŒã€ä½•ã‹ã—ã‚‰ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

