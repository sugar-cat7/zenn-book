---
title: "Azure Container Appsã®Secretç®¡ç†ã¨IaC"
emoji: "ğŸ”‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
publication_name: aishift
---

ã“ã‚“ã«ã¡ã¯ã€[sugar-cat](https://twitter.com/sugar235711)ã§ã™ã€‚

ã“ã®è¨˜äº‹ã¯ã€Azureã®Container Appsã‚’Terraformã§æ§‹ç¯‰ã—ã‚ˆã†ã¨ã—ãŸéš›ã«èµ·ããŸå•é¡Œã¨ãã®è§£æ±ºç­–ã«ã¤ã„ã¦ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚
â€»å†…å®¹è‡ªä½“ã¯ä»¥ä¸‹ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã®å†…å®¹ã‚’æ›¸ãèµ·ã“ã—ã€ä¸€éƒ¨åŠ ç­†ã—ãŸã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã€‚

https://speakerdeck.com/sugarcat7/azure-container-apps-secretguan-li-toiac

ã“ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½œæˆã—ãŸå½“æ™‚ã€Terraformã®`AzureRM Provider`å˜ä½“ã§ã¯Azure Container Appsã®Secretç®¡ç†ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«è¡Œã†ã®ãŒå›°é›£ã§ã—ãŸã€‚
ã—ã‹ã—ç¾åœ¨ã§ã¯`Azure Key Vault Reference`ã§Secretã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

å‚è€ƒ:
https://github.com/hashicorp/terraform-provider-azurerm/issues/23668

## Azureã¨Terraform

Azureç”¨ã®Terraform Providerã¯ä¸»ã«ä»¥ä¸‹ã®5ã¤ãŒã‚ã‚Šã¾ã™ã€‚

- [**AzureRM**](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs): ä»®æƒ³ãƒã‚·ãƒ³ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç­‰ã®ç®¡ç†
- [**AzureAD**](https://registry.terraform.io/providers/hashicorp/azuread/latest/docs): ã‚°ãƒ«ãƒ¼ãƒ—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®ç®¡ç†
- [**AzureStack**](https://registry.terraform.io/providers/hashicorp/azurestack/latest/docs): ä»®æƒ³ãƒã‚·ãƒ³ã€DNSç­‰ã®Stack Hubä¸Šã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†
- [**AzAPI**](https://registry.terraform.io/providers/azure/azapi/latest/docs): Azure Resource Managerã‚’ä½¿ç”¨ã—ã€ç›´æ¥ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†
- [**AzureDevOps**](https://registry.terraform.io/providers/microsoft/azuredevops/latest/docs): ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã€ãƒªãƒã‚¸ãƒˆãƒªç­‰ã®ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†

**HashiCorpè£½: AzureRM, AzureAD, AzureStack**
**Microsoftè£½: AzAPI, AzureDevOps**

åŸºæœ¬çš„ãªãƒªã‚½ãƒ¼ã‚¹ç®¡ç†ã«ã¯`AzureRM`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚å¯èƒ½ãªé™ã‚ŠHashiCorpå…¬å¼ã®Providerã ã‘ã§æ§‹ç¯‰ã™ã‚‹ã¨ã€ç®¡ç†ãŒå®¹æ˜“ã«ãªã‚ŠãŠã™ã™ã‚ã§ã™ã€‚


### AzureRMã¨Azure Container Apps

**Azure Container Apps**ã¯2022å¹´5æœˆã«GAã—ãŸãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
https://azure.microsoft.com/ja-jp/products/container-apps

è£ã¯AKSã§ã™ãŒã€ãƒãƒ¼ãƒ‰ãƒ—ãƒ¼ãƒ«ã®ç®¡ç†ã‚„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãªã©ã¯å…¨ã¦ãƒãƒãƒ¼ã‚¸ãƒ‰ã§è¡Œã‚ã‚Œã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºã«é›†ä¸­ã§ãã‚‹ã‚ˆã†ãªç’°å¢ƒã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚
Roadmap:
https://github.com/orgs/microsoft/projects/540

Terraformã§Azure Container Appsã‚’æ§‹ç¯‰ã™ã‚‹éš›ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

```tf:sample.tf
terraform {
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "=3.0.0"
    }
  }
}

provider "azurerm" {
  features {}
}

resource "azurerm_container_app" "example" {
  name                         = "example-app"
  container_app_environment_id = azurerm_container_app_environment.example.id
  resource_group_name          = azurerm_resource_group.example.name
  revision_mode                = "Single"

  template {
    container {
      name   = "examplecontainerapp"
      image  = "mcr.microsoft.com/k8se/quickstart:latest"
      cpu    = 0.25
      memory = "0.5Gi"
    }
  }
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’Applyã™ã‚‹ã¨ã€Terraformã¯AzureRM Providerã‚’ä½¿ç”¨ã—ã¦å†…éƒ¨ã§Azure Resource Manager APIã‚’å‘¼ã³å‡ºã—ã€Container Appsã‚’ä½œæˆã—ã¾ã™ã€‚
![alt text](/images/azure/ca/ca3.png)

### Container Appsã«ãŠã‘ã‚‹Secretç®¡ç†

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®é–‹ç™ºãŒé€²ã‚€ã¨ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ç’°å¢ƒå¤‰æ•°ã‚’æ‰±ã„ãŸã„å ´é¢ãŒå‡ºã¦ãã¾ã™ãã®éš›ã€ç’°å¢ƒå¤‰æ•°ã‚’ç›´æ¥å…¥åŠ›ã™ã‚‹ã‹ã€Secretsã‚’çµŒç”±ã—ã¦å–å¾—ã™ã‚‹ã‹ã‚’é¸æŠã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
![alt text](/images/azure/ca/ca4.png)

Secretsã‚’æ‰±ã†å ´åˆã€`Container Apps Secret`ã¾ãŸã¯`Key Vault Reference`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
Terraformã§ã¯ã€åŸºæœ¬çš„ã«`Key Vault Reference`ã‚’ä½¿ç”¨ã™ã‚‹ã®ãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚`azurerm_container_app`ã®secretãƒ–ãƒ­ãƒƒã‚¯ã«ç›´æ¥è¨­å®šã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™ãŒã€å¹³æ–‡ã§Stateã«æ®‹ã‚‹ãŸã‚ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®å•é¡ŒãŒã‚ã‚Šéæ¨å¥¨ã§ã™ã€‚

![alt text](/images/azure/ca/ca1.png)

### Azure Container Appsã§ã®Secretç®¡ç†ãƒ‘ã‚¿ãƒ¼ãƒ³

#### Azure Key Vault Referenceã®åˆ©ç”¨

ç¾çŠ¶ã€ã‚»ã‚­ãƒ¥ã‚¢ã§ã‹ã¤é‹ç”¨ãŒå®¹æ˜“ãªã®ã¯`Key Vault Referenceã‚’`ä½¿ç”¨ã™ã‚‹æ–¹æ³•ã§ã™ã€‚ä½¿ç”¨æ–¹æ³•ã¯secretãƒ–ãƒ­ãƒƒã‚¯ã«`Managed Identity`ã¨`secretã®ID`ã‚’æŒ‡å®šã™ã‚‹ã ã‘ã§ã™ã€‚

```tf:sample.tf
resource "azurerm_container_app" "test" {
  template {
    container {
      env {
        name        = "key-vault-secret"
        secret_name = "key-vault-secret"
      }
    }
  }
  secret {
    name                = "key-vault-secret"
    identity            = azurerm_user_assigned_identity.test.id
    key_vault_secret_id = azurerm_key_vault_secret.test.id
  }
}
```

ãŸã ã—ã“ã®ç°¡å˜ãªè¨­å®šã«è‡³ã‚‹ã¾ã§ã«ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ãŒå¿…è¦ã§ã™ã€‚

1. **Key Vaultã®ä½œæˆ**
2. **Key Vaultã«Secretã®ç™»éŒ²**
3. **Managed Identityã«Key Vaultã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ä»˜ä¸**
4. **Container Appsã«Secretã®ç™»éŒ²**

å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯LegacyãªAccess Policyã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ãŒã€ç¾åœ¨ã¯RBACãƒ™ãƒ¼ã‚¹ã®åˆ¶å¾¡ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€RBACã§è¨­å®šã—ã¾ã™ã€‚
https://learn.microsoft.com/ja-jp/azure/container-apps/manage-secrets?tabs=azure-portal#reference-secret-from-key-vault
1. **Key Vaultã®ä½œæˆ**

`enable_rbac_authorization = true`ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€Managed Identityã«ã‚ˆã‚‹èªè¨¼ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

```tf:sample.tf
resource "azurerm_key_vault" "example_kv" {
  name                      = "example"
  location                  = var.example_rg.location
  resource_group_name       = var.example_rg.name
  sku_name                  = var.key_vault.sku
  tenant_id                 = data.azurerm_client_config.current.tenant_id
  enable_rbac_authorization = true

  provisioner "local-exec" {
    command = "sleep 60"
  }
}
```

2. **Key Vaultã«Secretã®ç™»éŒ²**

`toSet`ã‚’ä½¿ç”¨ã—ã¦é †åºæ€§ã‚’æ’é™¤ã—ã€`lifecycle`ãƒ–ãƒ­ãƒƒã‚¯ã§valueã®å¤‰æ›´ã‚’ç„¡è¦–ã—ã¾ã™ã€‚
ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°å¾Œã«ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚„CLIã‹ã‚‰å®Ÿéš›ã®å€¤ã‚’ç™»éŒ²ã—ã¾ã™ã€‚

```tf:sample.tf
resource "azurerm_key_vault_secret" "secrets" {
  for_each     = toset([for s in var.container_apps.secrets : s.secret_name])
  name         = each.value
  value        = "dummy"
  key_vault_id = azurerm_key_vault.example_kv.id
  depends_on   = [
    azurerm_role_assignment.example_ca_rbac,
    azurerm_role_assignment.example_kv_rbac_current_user
  ]
  lifecycle {
    ignore_changes = [
      value
    ]
  }
}
```

3. **Managed Identityã«Key Vaultã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ä»˜ä¸**

æœ€å°æ¨©é™ã®åŸå‰‡ã«å¾“ã„ã€`Key Vault Secrets User`ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
https://learn.microsoft.com/ja-jp/azure/key-vault/general/rbac-guide?tabs=azure-cli#azure-built-in-roles-for-key-vault-data-plane-operations

```tf:sample.tf
resource "azurerm_role_assignment" "example_kv_rbac_ca_uai" {
  principal_id         = azurerm_user_assigned_identity.example_ca_uai.principal_id
  role_definition_name = "Key Vault Secrets User"
  scope                = azurerm_key_vault.example_kv.id
}
```

4. **Container Appsã«Secretã®ç™»éŒ²**

Dynamic Blockã‚’æ´»ç”¨ã—ã¦è¤‡æ•°ã®Secretã‚’æ‰±ã„ã‚„ã™ãã—ã¾ã™ã€‚

```tf:sample.tf
resource "azurerm_container_app" "example_ca" {
  dynamic "secret" {
    for_each = azurerm_key_vault_secret.secrets
    content {
      name                = secret.value.name
      identity            = azurerm_user_assigned_identity.example_ca_uai.id
      key_vault_secret_id = azurerm_key_vault_secret.secrets[secret.value.name].id
    }
  }
}
```

ã“ã®ã‚ˆã†ã«Azure Key Vault Referenceã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€Secretç®¡ç†ã‚’ã‚»ã‚­ãƒ¥ã‚¢ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
è©³ç´°ãªå®Ÿè£…æ–¹æ³•ã¯ã€Providerã®ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã‚‹ã¨ç†è§£ãŒæ·±ã¾ã‚Šã¾ã™ã€‚

https://github.com/hashicorp/terraform-provider-azurerm/blob/1b6e07fc03daf3671216720cac603e4edb2c5d91/internal/services/containerapps/container_app_resource_test.go#L745

#### AzAPIã®åˆ©ç”¨

ç¾åœ¨ã§ã¯Secretç®¡ç†ã«ã¯ä¸è¦ã§ã™ãŒã€AzAPIã‚’ä½µç”¨ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚`azapi_update_resource`ã‚’åˆ©ç”¨ã—ã¦ã€Resource Manager APIã‚’ç›´æ¥æ“ä½œã—ã¾ã™ã€‚

```tf:sample.tf
resource "azapi_update_resource" "containerapp_secret" {
  type        = "Microsoft.App/containerApps@2023-05-01"
  resource_id = azurerm_container_app.app.id

  body = jsonencode({
    properties = {
      configuration = {
        secrets = [
          {
            name        = "some-secret"
            keyVaultUrl = "${azurerm_key_vault.some_vault.vault_uri}secrets/some-secret"
            identity    = azurerm_user_assigned_identity.some_identity.id
          }
        ]
      }
    }
  })
}
```

Azure Container Appsã§ã¯ä¸€åº¦ç™»éŒ²ã—ãŸSecretã‚’å‰Šé™¤ã§ããªã„(!?)ãŸã‚ã€ååˆ†ãªæ¤œè¨¼ã‚’ã›ãšã«Secretã‚’ç™»éŒ²ã™ã‚‹ã®ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚
AzAPIã®åˆ©ç”¨æ™‚ã«ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ãŒã€æ—¢ã«Azureã®Providerã¨ã—ã¦ä¸€ç´šå¸‚æ°‘æ‰±ã„ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä½µç”¨ã—ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚

å‚è€ƒ:
https://speakerdeck.com/torumakabe/an-toazuretoterraform-2024xin-chun-baziyon?slide=6

#### Dapr Componentã®åˆ©ç”¨

Daprã®ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã‚’åˆ©ç”¨ã—ã¦Key Vaultã‹ã‚‰Secretã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ã€‚ã“ã®æ–¹æ³•ã§ã¯ã€Secretã‚’ç™»éŒ²ã›ãšã«ã‚µã‚¤ãƒ‰ã‚«ãƒ¼çµŒç”±ã§å‹•çš„ã«Secretã‚’å–å¾—ã—ã¾ã™ã€‚

[](/images/azure/ca/ca2.png)

```tf:dapr_component.tf
resource "azurerm_container_app_environment_dapr_component" "dapr_component_secretstore" {
  name                         = "secretstore"
  container_app_environment_id = azurerm_container_app_environment.example.id
  component_type               = "secretstores.azure.keyvault"
  version                      = "v1"
  metadata {
    name  = "vaultName"
    value = azurerm_key_vault.some_vault.name
  }
  metadata {
    name  = "spnClientId"
    value = azurerm_user_assigned_identity.some_identity.client_id
  }
}
```

```js:app.js
app.get('/show-secret', async (req, res) => {
  const port = process.env.DAPR_HTTP_PORT ?? daprPortDefault;
  const url = `http://${daprHost}:${port}/v1.0/secrets/secretstore/simple-js-secret`;
  try {
    const secret_response = await fetch(url);
    const secret = await secret_response.json();
    return res.status(200).send(secret);
  } catch (error) {
    console.log(error);
  }
});
```

## ã¾ã¨ã‚

Azure Container Appsã«ãŠã‘ã‚‹Secretç®¡ç†ã«ã¤ã„ã¦ã€Azure Key Vault Referenceã€AzAPIã€Dapr Componentãªã©ã®åˆ©ç”¨æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚å„æ–¹æ³•ã®ç‰¹å¾´ã‚’ç†è§£ã—ã€ã‚»ã‚­ãƒ¥ã‚¢ã§åŠ¹ç‡çš„ãªSecretç®¡ç†ã‚’å®Ÿç¾ã—ã¾ã—ã‚‡ã†ã€‚

## å‚è€ƒè³‡æ–™

https://speakerdeck.com/torumakabe/an-toazuretoterraform-2024xin-chun-baziyon
https://www.docswell.com/s/ussvgr/ZEN271-love-aca#p1
https://www.docswell.com/s/ussvgr/5VDXX5-aca-dapr_secrets-api_managed-id
