---
title: "Honoã§Connect RPCã‚’å‹•ã‹ã™"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["hono", "connect", "grpc", "nodejs", "typescript"]
published: false
---

ã“ã‚“ã«ã¡ã¯ã€[@sugar235711](https://twitter.com/sugar235711)ã§ã™ã€‚
ã“ã®è¨˜äº‹ã¯ã€ŒHono Advent Calendar 2025ã€15æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚
https://qiita.com/advent-calendar/2025/hono

## ã¯ã˜ã‚ã«

Honoã®Node.js Adapterã‚’ä½¿ã†ã¨ã€HTTP/2é€šä¿¡ã‚’è¡Œã†ã‚µãƒ¼ãƒãƒ¼ã‚’ç°¡å˜ã«ç«‹ã¡ä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://hono.dev/docs/getting-started/nodejs#http2

```typescript
import { createServer } from 'node:http2'

const server = serve({
  fetch: app.fetch,
  createServer,
})
```

ãªã®ã§Honoã§ç«‹ã¡ä¸Šã’ãŸNode.jsã‚µãƒ¼ãƒãƒ¼ä¸Šã§Connect RPCã‚’ä½¿ã£ãŸgRPCäº’æ›ã®ã‚µãƒ¼ãƒãƒ¼å‹•ã‹ã›ã¾ã™ã‚ˆã­ã€‚ã¨ã„ã†ã“ã¨ã§è©¦ã—ã¾ã—ãŸã€‚

æ¤œè¨¼ç”¨ã®ã‚³ãƒ¼ãƒ‰ã¯â†“
https://github.com/sugar-cat7/hono-connect-example/tree/main

## Connect RPCã«ã¤ã„ã¦

Connect RPCã¯ã€gRPC/gRPC-Web/Connect Protocolã®3ã¤ã®ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§é€šä¿¡ã§ãã‚‹RPCãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚TypeScript/JavaScriptã‚’ã¯ã˜ã‚ã€Goã€Pythonã€Javaã€C#ç­‰æ§˜ã€…ãªè¨€èªã§åˆ©ç”¨å¯èƒ½ã§ã™ã€‚
`Protocol Buffers`ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã—ã€å‹å®‰å…¨ãªRPCé€šä¿¡ã‚’å®Ÿç¾ã—ã¾ã™ã€‚
ã“ã®è¨˜äº‹ã¯Honoã®è¨˜äº‹ãªã®ã§ã“ã‚Œä»¥ä¸Šã¯å‰²æ„›ã—ã¾ã™ã€‚
https://connectrpc.com/


ç­†è€…ã®Connect RPCé–¢é€£è¨˜äº‹
[connect-esç·¨](https://scrapbox.io/sugar-dev/connect-es%E7%B7%A8)
[connect-go ã‹ã‚‰å­¦ã¶ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ](https://zenn.dev/aishift/articles/181bec652a0fc1)
[gRPCã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒˆã‚™_Connectã‚’æ·»ãˆã¦](https://speakerdeck.com/sugarcat7/grpctohurontoento-connectwotian-ete)


## Honoç”¨ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ä½œæˆ

Honoã§Connect RPCã‚’ä½¿ã†ãŸã‚ã«ã€`honoConnectMiddleware`ã‚’ä½œæˆã—ã¾ã™ã€‚[Expressç”¨ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢](https://github.com/connectrpc/connect-es/blob/main/packages/connect-express/src/express-connect-middleware.ts)ã‚’å‚è€ƒã«å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

https://github.com/sugar-cat7/hono-connect-example/blob/main/lib/middleware.ts

ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ã€‚

ãƒ»**Node.jsãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¤‰æ›**: `universalRequestFromNodeRequest`ã¨`universalResponseToNodeResponse`ã‚’ä½¿ç”¨ã—ã¦ã€Honoã®Node.jsç’°å¢ƒã¨Connect RPCã®Universal Handlerã‚’æ©‹æ¸¡ã—ã®å®Ÿè£…
ãƒ»**ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å—ã‘æ¸¡ã—**: Honoã®Contextã‚’Connect RPCã®Contextã«æ¸¡ã™ãŸã‚ã®ä»•çµ„ã¿ã®å®Ÿè£…

### Node.jsãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å¤‰æ›

Honoã®Node.js Adapterã§ã¯ã€`incoming`/`outgoing`ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æ‰±ã„ã¾ã™ã€‚

https://github.com/honojs/node-server/blob/76d80e6c1c7bf7101b80392b6bfacc17e3829fd9/src/types.ts#L23-L31

Connect RPCã®Universal Handlerã¨é€£æºã™ã‚‹ã«ã¯ã€ã“ã‚Œã‚‰ã‚’å¤‰æ›ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚Connectå´ãŒæä¾›ã™ã‚‹`universalRequestFromNodeRequest`ã¨`universalResponseToNodeResponse`ã‚’ä½¿ã£ã¦å¤‰æ›ã‚’è¡Œã„ã¾ã™ã€‚

https://github.com/sugar-cat7/hono-connect-example/blob/6790b1941720f9584bbbe875458a30860bd5e1e5/lib/middleware.ts#L92-L101

### ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å—ã‘æ¸¡ã—

åˆ©ç”¨å´ã¯ç°¡å˜ã§ã€Connect RPCç”¨ã®Routerã‚’ä½œæˆã—ã¦ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã«æ¸¡ã™ã ã‘ã§ã™ã€‚

```typescript
const honoContextKey = createHonoContextKey<HonoEnv>();
const app = new Hono<HonoEnv>();

app.use("*", requestId());

// Connect RPC ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.use(
  "/connectrpc*",
  honoConnectMiddleware({
    honoContextKey,
    routes(router: ConnectRouter) {
      router.service(ElizaService, {
        say(req: SayRequest, ctx) {
          // Honoã®Contextã‹ã‚‰requestIdã‚’å–å¾—
          const honoCtx = ctx.values.get(honoContextKey);
          const reqId = honoCtx?.get("requestId");
          return create(SayResponseSchema, {
            sentence: `You said: "${req.sentence}" (requestId: ${reqId})`,
          });
        },
      });
    },
  })
);

// é€šå¸¸ã®RESTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
app.get("/", (c) => c.text("Hello Hono with Connect RPC over HTTP/2!"));
app.get("/api/users", (c) => c.json({ users: [{ id: 1, name: "John" }] }));
```


ãã®ã¾ã¾ã ã¨Connect RPCã®Routerå´ã«Honoã®ContextãŒæ¸¡ã›ãªã„ã®ã§ã€`createHonoContextKey`ã¨ã„ã†[Symbol](https://github.com/connectrpc/connect-es/blob/bf6b19103f110b4bf61d5d326c2f1443fc2eb155/packages/connect/src/context-values.ts#L63-L68)ã‚’ä½¿ã£ã¦[Honoã®Contextã‚’Connectã®Contextã«æ¸¡ã—ã¦ã„ã¾ã™](https://github.com/sugar-cat7/hono-connect-example/blob/b3ec2ee9ebce64bffd0c6611a1759254b9965eec/lib/middleware.ts#L96)ã€‚

```typescript
export function createHonoContextKey<E extends Env>() {
  return createContextKey<Context<E> | undefined>(undefined);
}
```

ã“ã‚Œã«ã‚ˆã‚ŠHonoã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§è¨­å®šã—ãŸå€¤ï¼ˆä¾‹ï¼š`requestId`ï¼‰ã‚’Connect RPCã®ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…å´ã§å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

### HTTP/2ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•

ã‚ã¨ã¯é©å½“ã«è¨¼æ˜æ›¸ã‚’ç”¨æ„ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚Œã°ã€HTTP/2ã§ã®é€šä¿¡ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

```typescript
serve({
  fetch: app.fetch,
  port: 3000,
  createServer: createSecureServer,
  serverOptions: {
    key: readFileSync("certs/server.key"),
    cert: readFileSync("certs/server.crt")
  },
});
```

### Connect Protocolï¼ˆJSONï¼‰ã§ã®é€šä¿¡

```bash
$ curl -k -v --http2 https://localhost:3000/connectrpc.eliza.v1.ElizaService/Say \
  -H "Content-Type: application/json" \
  -d '{"sentence": "Hello!"}'

* using HTTP/2
* [HTTP/2] [1] OPENED stream for https://localhost:3000/connectrpc.eliza.v1.ElizaService/Say
> POST /connectrpc.eliza.v1.ElizaService/Say HTTP/2
> Content-Type: application/json
< HTTP/2 200 
< content-type: application/json
{"sentence":"You said: \"Hello!\" (requestId: 57a7bfde-12c0-49fd-bb4d-dd0994fd241a)"}
```

### gRPCãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã®é€šä¿¡

gRPCäº’æ›ãªã®ã§`content-type: application/grpc+proto`ã§ã®é€šä¿¡ã‚‚å¯èƒ½ã§ã™ã€‚

```bash
$ grpcurl \
  -insecure \
  -protoset eliza.protoset \
  -d '{"sentence":"Hello!"}' \
  localhost:3000 \
  connectrpc.eliza.v1.ElizaService/Say

{
  "sentence": "You said: \"Hello!\" (requestId: dd1b21d6-7c36-4df5-91e5-dd0ac9e497d0)"
}
```

`unary`ã®ã¿ã—ã‹è©¦ã—ã¦ãªã„ã§ã™ãŒã€Node.jsã‚µãƒ¼ãƒãƒ¼ãªã‚‰Streamingã‚‚å‹•ä½œã™ã‚‹ã¯ãšã§ã™ã€‚
ã‚‚ã¡ã‚ã‚“æ—¢å­˜ã®Hono APIã¨å…±å­˜ã§ãã‚‹ãŸã‚ã€ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ã® REST APIã¨gRPCã®ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚µãƒ¼ãƒãƒ¼ã¨ã—ã¦åˆ©ç”¨ã§ããŸã‚Šã€gRPC Webã¨ã‚‚äº’æ›ãŒã‚ã‚‹ã®ã§ä½•ã‚‚è€ƒãˆãš(???)ã«ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚ä½¿ãˆã¾ã™ã€‚



## ã¾ã¨ã‚

Honoã¨Connect RPCã‚’çµ„ã¿åˆã‚ã›ã¦é–‹ç™ºãŒã§ãã¾ã™ã€‚